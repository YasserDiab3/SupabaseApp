# توافق الواجهة الأمامية مع قاعدة البيانات (Supabase)

## مراجعة تمت في 2026-02-21

### 1. مسار الطلبات
- **الواجهة:** تستخدم `GoogleIntegration` (في نسخة Supabase = `SupabaseIntegration`) → `sendToAppsScript(action, data)` أو `sendRequest({ action, data })`.
- **الهيكل المرسل:** `POST` إلى `/functions/v1/hse-api` بجسم `{ action, data, csrfToken, timestamp }`.
- **الخلفية:** `hse-api` يقرأ `action` و `payload = body.data` ويعالج حسب نوع العملية.

### 2. عمليات القراءة
- **readFromSheet:** الطلب `{ action: 'readFromSheet', data: { sheetName: '...' } }`.
- **الخلفية:** تحوّل اسم الورقة إلى اسم جدول (`sheetNameToTable`)، ثم `select` من الجدول وإرجاع صفوف بصيغة `{ id, ...data }`.
- **جدول Users:** يُرجَع العمود `password_hash` منفصلاً ويُدمَج في الكائن كـ `passwordHash`.

### 3. عمليات الحفظ والإضافة
- **saveToSheet:** `{ action: 'saveToSheet', data: { sheetName, data: مصفوفة أو كائن } }`. كل صف يُخزَّن بـ `id` من الصف أو UUID.
- **appendToSheet:** نفس الهيكل؛ الخلفية تستخدم `insert` بدلاً من `upsert`.
- **autoSave( sheetName, data ):** يستدعي `saveToSheet` بنفس الهيكل أعلاه.

### 4. إصلاحات تم تطبيقها

#### أ) استخراج معرف الحذف (delete)
الخلفية كانت تعتمد فقط على `id, observationId, contractorId, approvedContractorId`. تمت إضافة:
- `incidentId` (حذف الحوادث)
- `medicationId` (حذف الأدوية)
- `alertId` (حذف تنبيهات السلامة)
- `ppeId`, `itemId` (حذف معدات الوقاية وعناصر المخزون)
- `trainingId` (حذف التدريب)
- `leaveId` (إجازات)
- `violationId`, `behaviorId` (مخالفات وسلوك)

#### ب) استخراج معرف التحديث (save)
تمت إضافة نفس المفاتيح أعلاه حيث يرسل الواجهة `updateData` مع `leaveId`, `trainingId`, `medicationId`, `visitId`, `injuryId`, `ppeId`, `itemId` إلخ.

#### ج) إجراءات الحذف المضافة إلى ACTION_SHEET_MAP
- `deletePPE` → جدول PPE
- `deletePPEStockItem` → جدول PPE

#### د) إلحاق الإشعارات (addNotification)
- إذا أُرسل الـ payload بصيغة `{ data: { userId, title, message, ... } }` فقط، الخلفية تستخدم الكائن الداخلي كصف للإدراج حتى يُخزَّن بشكل صحيح في جدول الإشعارات.
- في الواجهة (auth): تم توحيد إرسال الإشعار ككائن مباشر دون تغليفه مرة أخرى داخل `data`.

### 5. إجراءات المستخدمين (Users)
- **addUser / updateUser / deleteUser / resetUserPassword:** معالجة خاصة في الخلفية (جدول `users` مع عمود `password_hash`).
- **deleteUser:** الطلب `{ userId }` أو `{ id }` أو `{ email }` — الخلفية تقبل الثلاثة.
- **updateUser:** الطلب `{ userId, updateData }` أو `{ id, updateData }`.

### 6. التحقق السريع
- حذف مستخدم: الواجهة ترسل `deleteUser` مع `userId` ✓
- حذف حادث: الواجهة ترسل `deleteIncident` مع `incidentId` ✓ (بعد الإصلاح)
- حذف مقاول: الواجهة ترسل `deleteContractor` مع `contractorId` ✓
- حذف دواء: الواجهة ترسل `deleteMedication` مع `medicationId` ✓ (بعد الإصلاح)
- حذف تنبيه: الواجهة ترسل `deleteSafetyAlert` مع `alertId` ✓ (بعد الإصلاح)
- حذف معدات الوقاية: الواجهة ترسل `deletePPE` مع `ppeId` ✓ (بعد إضافة الـ action والخلفية)

### 7. إجراءات إضافية تمت إضافتها للتوفيق مع الموديولات
- **العيادة:** addMedicationDeletionRequest, getAllMedicationDeletionRequests, approveMedicationDeletion, rejectMedicationDeletion, addSupplyRequest, getAllSupplyRequests, approveSupplyRequest, rejectSupplyRequest (جداول MedicationDeletionRequests, SupplyRequests).
- **المقاولون:** approveContractorApprovalRequest و rejectContractorApprovalRequest — معالجة خاصة لدمج التحديث مع السجل الموجود (عدم استبدال كامل السجل).
- **المهام:** getAllUserTasks (قراءة من user_tasks).
- **فريق السلامة:** getSafetyTeamMember (صف واحد بـ memberId), deleteSafetyTeamMember (حذف بـ memberId), getOrganizationalStructure, saveOrganizationalStructure, getJobDescription (صف واحد بـ memberId), calculateSafetyTeamKPIs, addSafetyTeamKPI.
- **التدريب الدوري:** getAllPeriodicInspections, addPeriodicInspection, updatePeriodicInspection.
- **معدات الوقاية:** getAllPPE, getPPEItemsList, getAllPPEStockItems, addOrUpdatePPEStockItem, getAllPPETransactions, addPPETransaction.
- **الموظفون:** deactivateEmployee (تحديث بـ employeeId).
- **اختبار التطبيق:** saveTestReport (إلحاق في TestReports؛ عند غياب الجدول يُرجَع نجاح لتجنب كسر الواجهة).

### 8. ملاحظات
- أخطاء TypeScript/Deno في بيئة التطوير (مثل عدم وجود `Deno` أو وحدة `esm.sh`) متوقعة في Supabase Edge Functions ولا تؤثر على التشغيل بعد النشر.
- عند إضافة موديولات جديدة تستخدم حذف أو تحديث بمعرف مختلف، يُفضّل إضافة المفتاح المناسب في استخراج `id` في `hse-api` (قسم delete و save) وإضافة الـ action إلى `ACTION_SHEET_MAP` إن لزم.

# تقرير المراجعة الأمنية وجاهزية الإنتاج

**تاريخ المراجعة:** 2026-02-24  
**آخر تحديث (إصلاح الثغرات):** 2026-02-24  
**النطاق:** Frontend (JS/HTML)، Backend (Supabase Edge Functions)، قاعدة البيانات (migrations).

---

## 1. الملخص التنفيذي

| الجانب | الحالة | ملاحظة |
|--------|--------|--------|
| مصادقة الواجهة (تسجيل الدخول) | ✅ جيد | تسجيل دخول بم hash، حد معدل محاولات، تعطيل bootstrap بعد المزامنة |
| مصادقة API (Edge Function) | ✅ مُصلَح | تقبل `HSE_API_SECRET` أو `HSE_ANON_KEY`؛ إضافة `HSE_ANON_KEY` (نفس anon من المشروع؛ الاسم SUPABASE_* غير مسموح في Supabase) يسمح بالعمل تلقائياً |
| صلاحيات قاعدة البيانات (RLS) | ⚠️ غير مفعّل | لا توجد سياسات RLS على الجداول؛ الوصول عبر Service Role فقط (اختياري لاحقاً) |
| XSS (واجهة) | ✅ مُعالج في الأماكن المراجعة | استخدام `Utils.escapeHTML` في سجل الأنشطة، الإعدادات، معدات الإطفاء؛ تم إصلاح عرض نوع العملية في سجل الأنشطة |
| الأسرار والمفاتيح | ⚠️ ضبط اختياري | مفتاح Anon ورابط Supabase في الكود؛ للإنتاج: تعيين `HSE_API_SECRET` في الخادم ونفس القيمة في الواجهة (`hseApiSecret`) |
| CORS | ✅ مُصلَح | يُقرأ `ALLOWED_ORIGIN` من البيئة؛ إن وُجد يُستخدم، وإلا يُعاد أصل الطلب أو `*` |
| كشف تفاصيل الأخطاء | ✅ مُصلَح | رسالة الخطأ للمستخدم عامة ("حدث خطأ في الخادم...")؛ التفاصيل تُسجّل في الخادم فقط |
| التحقق من المدخلات (API) | ✅ أساسي | التحقق من وجود الحقول ونوعها |
| استرجاع كلمة المرور | ✅ سليم | رمز لمرة واحدة، انتهاء صلاحية، تخزين هاش فقط؛ استخدام Resend من البيئة |

---

## 2. المصادقة والصلاحيات

### 2.1 تسجيل الدخول (Frontend)

- **النقاط الإيجابية:**
  - كلمات المرور لا تُخزَّن كنص؛ استخدام SHA-256 hash فقط (ومطابق لعمود `password_hash` في قاعدة البيانات).
  - حساب Bootstrap (`admin@hse.local`) يُعطّل تلقائياً بعد نجاح مزامنة المستخدمين من قاعدة البيانات.
  - حد معدل محاولات تسجيل الدخول (Rate Limiting) لتقليل هجمات القوة الغاشمة.
  - التحقق من صحة البريد الإلكتروني قبل الإرسال.

- **تحذير:**  
  هاش Bootstrap الافتراضي (مقابل `admin123`) مضمّن في الكود لأغراض التهيئة الأولى فقط؛ التأكد من تعطيل Bootstrap بعد إضافة مستخدمين حقيقيين (السلوك الحالي صحيح).

### 2.2 مصادقة واجهة API (hse-api) — تم الإصلاح

- **ما تم تنفيذه:**
  - عند تعيين **`HSE_API_SECRET`** في Supabase (Edge Function secrets)، الدالة تقبل الطلب إذا كان يحمل:
    - رأس **`X-API-Key`** أو **`Authorization: Bearer`** مطابقاً لـ `HSE_API_SECRET`، **أو**
    - **`Authorization: Bearer`** مطابقاً لـ **`HSE_ANON_KEY`** (المفتاح العام للمشروع؛ الاسم `SUPABASE_*` غير مسموح في واجهة الأسرار).
  - **عمل تلقائي:** إضافة المتغير **`HSE_ANON_KEY`** في أسرار الدالة (نفس قيمة المفتاح العام من Project Settings → API؛ لا تستخدم اسماً يبدأ بـ `SUPABASE_` لأن Supabase يرفضه) يسمح للواجهة بالعمل دون إعداد `HSE_API_SECRET` في `config.js`.
  - إن لم يُعيَّن `HSE_API_SECRET` يبقى السلوك كما كان (للتطوير المحلي).
- **الواجهة:** ترسل `Authorization: Bearer <anonKey>` دائماً؛ إن وُجد `HSE_API_SECRET` في الواجهة تُرسل أيضاً `X-API-Key`.
- **للإنتاج:** إما عيّن `HSE_ANON_KEY` في أسرار الدالة (للعمل فوراً)، أو عيّن `HSE_API_SECRET` في Supabase ونفس القيمة في الواجهة لمصادقة أقوى.

### 2.3 قاعدة البيانات (RLS)

- **الوضع الحالي:**  
  في الـ migrations المراجعة **لا يوجد تفعيل لـ Row Level Security (RLS)** على الجداول. الـ Edge Function تستخدم `SUPABASE_SERVICE_ROLE_KEY`، لذا تتجاوز أي RLS لو فُعّل لاحقاً.

- **التوصية:**  
  إذا تم اعتماد مصادقة JWT في الـ API والعميل يرسل رمز المستخدم، يمكن لاحقاً:
  - إما استدعاء Supabase من الواجهة مباشرة (بالمفتاح العام Anon) مع تفعيل RLS على الجداول بحيث يقتصر الوصول على صفوف المستخدم/الدور المسموح له.
  - أو الإبقاء على الـ Edge Function كوسيط لكن تمرير JWT والتحقق منه ثم استخدام عميل بصلاحيات المستخدم (عبر `createClient` مع JWT) حتى تطبق RLS.

---

## 3. XSS والتحقق من المدخلات

### 3.1 واجهة المستخدم

- **ما تم مراجعته:**
  - **سجل الأنشطة (`user-activity-log.js`):** جميع الحقول المعروضة (اسم المستخدم، البريد، الموديول، التفاصيل، عنوان IP، ونوع العملية) تمر عبر `Utils.escapeHTML`. تم إصلاح عرض `getActionTypeLabel(log.actionType)` لاستخدام `Utils.escapeHTML` عند العرض في الجدول (لتجنب XSS عندما يكون `actionType` غير معروف ويُعاد كما هو).
  - **الإعدادات والنماذج (`app-utils.js`):** استخدام `Utils.escapeHTML` للمواقع والأماكن والإدارات وعناصر الخطط.
  - **معدات الإطفاء (`fireequipment.js`):** استخدام `Utils.escapeHTML` في جداول الأصول والفحوصات والقوائم المنسدلة.

- **التوصية العامة:**  
  في أي موديول آخر يستخدم `innerHTML` أو `insertAdjacentHTML` مع بيانات قادمة من المستخدم أو من قاعدة البيانات، يجب تمرير النص عبر `Utils.escapeHTML` قبل الإدراج، أو استخدام `textContent` حيث يكفي عرض نص فقط.

### 3.2 حقن SQL

- **الوضع:**  
  Supabase Client يستخدم استعلامات مُعاملَة (parameterized). لا يوجد بناء استعلامات SQL يدوي من سلاسل نصية في الكود المراجع، وبالتالي لا توجد ثغرة حقن SQL تقليدية في طبقة التطبيق.

---

## 4. الأسرار والبيانات الحساسة

- **المفتاح العام (Anon Key) ورابط Supabase:**  
  موجودان داخل الكود في `app-utils.js` و`supabase-integration.js`. المفتاح العام مصمم للاستخدام من الواجهة، لكن من الأفضل للإنتاج:
  - نقلهما إلى متغيرات بيئة أو ملف إعداد يُحقَن عند البناء (مثلما ورد في `NETLIFY-DEPLOY.md`).
  - تجنب وضع قيم إنتاج حقيقية في المستودع.

- **مفتاح الخدمة (Service Role Key):**  
  يُستخدم فقط في الـ Edge Function عبر `Deno.env.get("SUPABASE_SERVICE_ROLE_KEY")` ولا يظهر في الواجهة — سليم.

- **استرجاع كلمة المرور:**  
  استخدام `RESEND_API_KEY` و`PASSWORD_RESET_APP_URL` و`RESEND_FROM_EMAIL` من البيئة — سليم. عدم كشف الرمز في رسائل الخطأ للمستخدم.

- **كلمات المرور في الواجهة:**  
  يتم إرسال هاش أو كلمة مرور مؤقتة فقط؛ التطبيق يتجنب تسجيل كلمة المرور النصية في السجلات في بيئة الإنتاج (التحقق من `isProduction`).

---

## 5. API و CORS والرؤوس — تم الإصلاح

- **CORS:**  
  يُقرأ **`ALLOWED_ORIGIN`** من متغيرات البيئة. إن وُجد وقيمته ليست `*` يُستخدم كقيمة لـ `Access-Control-Allow-Origin`؛ وإلا يُستخدم أصل الطلب (إن وُجد) أو `*`. للإنتاج: عيّن `ALLOWED_ORIGIN=https://yourdomain.com`.

- **الطرق المسموحة:**  
  الدالة تقبل فقط `POST` و`OPTIONS` — مناسب.

- **معالجة الأخطاء:**  
  في كتلة `catch` لا يُعاد للمستخدم سوى رسالة عامة: "حدث خطأ في الخادم. يرجى المحاولة لاحقاً."؛ التفاصيل تُسجّل عبر `console.error` في الخادم فقط.

---

## 6. التطابق والبنية

- **تطابق قاعدة البيانات:**  
  جداول الـ migrations (مثل `users` مع عمود `password_hash`، وجداول الـ sheets المكافئة) متسقة مع استخدام الـ API (قراءة/كتابة من/إلى `data` و`password_hash` حيث مطلوب).

- **تسجيل الدخول واسترجاع كلمة المرور:**  
  مسار استرجاع كلمة المرور (طلب رابط، التحقق من الرمز، تحديث `password_hash` في `users`) متوافق مع الهيكل الحالي للجدول والإعدادات.

- **رفع صور المستخدمين (Supabase Storage):**  
  لتفعيل رفع صورة الملف الشخصي من لوحة التحكم في نسخة Supabase، أنشئ في Supabase Dashboard → Storage bucket باسم **`user-photo`** وفعّل **Public** للقراءة حتى تعمل روابط الصور في الواجهة. الرفع يتم عبر Edge Function `uploadUserPhoto` ولا يتطلب تعريض كتابة Storage للمستخدم مباشرة.

---

## 7. قائمة تحقق سريعة للإنتاج

- [x] **مصادقة API:** تحقق من مفتاح API (`HSE_API_SECRET` + رأس `X-API-Key`) في `hse-api` قبل تنفيذ الإجراءات.
- [x] **CORS:** دعم `ALLOWED_ORIGIN` من البيئة؛ تعيينه في الإنتاج لنطاق التطبيق الفعلي.
- [x] **رسائل الأخطاء:** إرجاع رسالة عامة فقط للمستخدم؛ تسجيل التفاصيل في الخادم.
- [ ] **الأسرار:** للإنتاج تعيين `HSE_API_SECRET` في Supabase و`hseApiSecret` في الواجهة (أو حقن من بناء).
- [ ] **الأسرار (اختياري):** نقل `supabaseUrl` و`supabaseAnonKey` إلى متغيرات بيئة/إعداد بناء.

---

## 7.1 شرح تطبيق البند 1 و 2 (الأسرار للإنتاج)

### البند 1: تعيين المفتاح السري في الخادم (Supabase)

1. ادخل إلى **Supabase Dashboard**: [https://supabase.com/dashboard](https://supabase.com/dashboard) واختر مشروعك.
2. من القائمة الجانبية: **Project Settings** (أيقونة الترس) → **Edge Functions**.
3. في قسم **Secrets** (أو من قائمة **Edge Functions** → اختر الدالة **hse-api** → **Secrets** حسب واجهة Supabase):
   - اضغط **Add new secret** أو **Manage secrets**.
   - **Name:** `HSE_API_SECRET`
   - **Value:** مفتاح عشوائي قوي (يُنصح 32 حرفاً فأكثر، مثلاً مخرَج أمر مثل `openssl rand -hex 32`).
4. احفظ القيمة في مكان آمن (ستحتاجها في البند 2). **لا تضعها في الكود أو في المستودع.**

النتيجة: أي طلب إلى `hse-api` بدون رأس `X-API-Key` أو `Authorization: Bearer` مطابق لهذه القيمة سيرد عليه الخادم بـ **401 غير مصرح**.

---

### البند 2: تعيين نفس المفتاح في الواجهة

الواجهة تقرأ المفتاح من أحد مصدرين (بالترتيب):

1. **`AppState.hseApiSecret`**
2. **`window.__CONFIG__.HSE_API_SECRET`**

اختر **إحدى** الطرق التالية:

#### الطريقة أ: تعيين ثابت عند البناء (مثلاً Netlify / Vite)

- عيّن متغير بيئة في منصة النشر، مثلاً: `HSE_API_SECRET=المفتاح_الذي_نسخته_من_Supabase`.
- في خطوة البناء (build) اكتب قيمة هذا المتغير في كائن يصل للواجهة، مثلاً:
  - إن كان لديك ملف `config.js` يُنشأ عند البناء، اجعله يحدّث `window.__CONFIG__ = { HSE_API_SECRET: process.env.HSE_API_SECRET };`.
  - أو إن كان `AppState` يُهيَّأ من ملف يُولَّد عند البناء، عيّن فيه `hseApiSecret: process.env.HSE_API_SECRET`.
- تأكد أن ملف الإعداد المُنشأ لا يُرفع إلى المستودع (مثلاً في `.gitignore`).

#### الطريقة ب: من واجهة إعدادات التطبيق (إن وُجدت)

- إذا كان لديك شاشة إعدادات تخزن قيماً (مثلاً في `localStorage` أو ترسلها لخادمك)، أضف حقل "مفتاح API" أو "المفتاح السري للخادم".
- عند تحميل التطبيق، اقرأ هذه القيمة وعيّنها:  
  `AppState.hseApiSecret = القيمةالمحفوظة`.

#### الطريقة ج: حقن من الخادم عند تقديم الصفحة

- إذا كانت الواجهة تُقدَّم من خادمك (وليس استضافة ثابتة فقط)، يمكن لصفحة HTML أن تقرأ متغير بيئة من الخادم وتحقنه في الصفحة، مثلاً:
  - في الـ HTML أو في سكربت تشغيل واحد قبل تحميل التطبيق:  
    `window.__CONFIG__ = window.__CONFIG__ || {}; window.__CONFIG__.HSE_API_SECRET = "المفتاح_من_متغير_البيئة";`
  - الخادم يعيد هذه القيمة من `process.env.HSE_API_SECRET` أو ما يعادله، **ولا يضع المفتاح ثابتاً في الكود**.

بعد تطبيق البند 2، كل طلبات التطبيق إلى `hse-api` (بما فيها استرجاع كلمة المرور من `login-init-fixed.js`) ستحمل رأس `X-API-Key` وسيقبلها الخادم طالما القيمة مطابقة لـ `HSE_API_SECRET`.

---

### تنفيذ آلية البند 1 و 2 في المشروع

تم تنفيذ الآلية من جانب الواجهة:

1. **`Frontend/js/config.js`**  
   يُحمّل قبل أي موديول ويُعرّف `window.__CONFIG__.HSE_API_SECRET`. القيمة الافتراضية فارغة (مناسب للتطوير). للإنتاج: ضع نفس المفتاح المُضاف في Supabase.

2. **`Frontend/index.html`**  
   يحتوي على `<script src="js/config.js"></script>` قبل بقية السكربتات حتى يكون `__CONFIG__` متاحاً عند تحميل التطبيق.

3. **`Frontend/js/modules/app-utils.js`**  
   يهيئ `AppState.hseApiSecret` من `window.__CONFIG__.HSE_API_SECRET` عند التحميل إن وُجد.

4. **توليد مفتاح عشوائي**  
   - **الأسهل:** افتح الملف `Frontend/generate-api-secret.html` في المتصفح → اضغط "توليد مفتاح جديد" → انسخ المفتاح والسطر الجاهز لـ `config.js`.  
   - من الطرفية: `node scripts/generate-api-secret.js` أو `openssl rand -hex 32`.

**ما يجب عليك فعله يدوياً:**  
- في Supabase: إضافة السر `HSE_API_SECRET` بقيمة المفتاح.  
- في النشر على Netlify: تعيين متغير البيئة `HSE_API_SECRET` في Netlify (Site settings → Environment variables)؛ السكربت `scripts/inject-secret.js` يحقنه في `js/config.js` عند البناء فلا يظهر المفتاح في المستودع. للتطوير المحلي: نفّذ `node scripts/inject-secret.js` بعد تعيين المتغير، أو املأ المفتاح في `config.js` مؤقتاً دون رفع الملف.

---

## 7.2 شرح تفصيلي لما لم يُنفَّذ يدوياً (ولماذا)

هذه الخطوات **لا يمكن تنفيذها تلقائياً** من الكود أو الأدوات؛ يجب أن تقوم بها أنت لأنها تتطلب صلاحياتك وحسابك وبيئة النشر الفعلية.

---

### الخطوة اليدوية 1: إضافة المفتاح السري في Supabase

| البند | الشرح |
|--------|--------|
| **ماذا تفعل؟** | تدخل إلى لوحة تحكم Supabase وتضيف متغيراً سرياً باسم `HSE_API_SECRET` وقيمة المفتاح الذي ولّدته. |
| **لماذا لا يُنفَّذ تلقائياً؟** | الوصول إلى Supabase Dashboard يتطلب **تسجيل دخولك** وحساب المشروع. لا يمكن للكود أو للأدوات المحلية أن تضيف أسراراً في حسابك دون **مفتاح API لـ Supabase** أو **جلسة مستخدم**، ووضع مفتاح إدارة Supabase داخل المشروع يعدّ **ثغرة أمنية**. لذلك إضافة السر تتم دائماً من واجهة Supabase أو من سطر أوامر Supabase CLI بعد تسجيل الدخول من جهازك. |
| **التفاصيل خطوة بخطوة:** | 1) افتح [https://supabase.com/dashboard](https://supabase.com/dashboard) وسجّل الدخول. 2) اختر **المشروع** الذي يشغّل فيه التطبيق. 3) من القائمة الجانبية: **Project Settings** (أيقونة الترس أسفل يسار القائمة). 4) من التبويبات العلوية اختر **Edge Functions**. 5) انزل إلى قسم **Secrets** (أو **Function Secrets**). 6) اضغط **Add new secret** أو **New secret**. 7) في الحقل **Name** اكتب بالضبط: `HSE_API_SECRET`. 8) في الحقل **Value** الصق المفتاح العشوائي (مثلاً مخرَج `node scripts/generate-api-secret.js` أو `openssl rand -hex 32`). 9) احفظ. لا تشارك هذه القيمة ولا تضعها في المستودع. |

---

### الخطوة اليدوية 2: وضع نفس المفتاح في الواجهة (config.js أو البيئة)

| البند | الشرح |
|--------|--------|
| **ماذا تفعل؟** | تضع **نفس قيمة** المفتاح في مكان يقرأه التطبيق: إما في الملف `Frontend/js/config.js` (السطر `__CONFIG__.HSE_API_SECRET = '...';`) أو عبر متغير بيئة عند البناء/النشر. |
| **لماذا لا يُنفَّذ تلقائياً؟** | الكود **لا يعرف** قيمة المفتاح الذي أنشأته في Supabase. إذا وُضعت القيمة ثابتة داخل المستودع (مثلاً في `config.js` مرفوع على Git) فكل من يصل إلى المستودع يرى المفتاح، وهذا يلغي فائدة المصادقة. لذلك القيمة **يجب** أن تدخلها أنت (أو بيئة النشر) في مكان آمن: إما يدوياً في ملف غير مرفوع، أو من متغير بيئة أثناء البناء. |
| **التفاصيل خطوة بخطوة:** | **الطريقة المباشرة (لاختبار أو نشر بسيط):** 1) افتح الملف `Frontend/js/config.js`. 2) ابحث عن السطر: `global.__CONFIG__.HSE_API_SECRET = '';`. 3) ضع بين علامتي الاقتباس **نفس** المفتاح الذي أضفته في Supabase، مثلاً: `global.__CONFIG__.HSE_API_SECRET = 'a1b2c3...';`. 4) احفظ الملف. **تحذير:** إذا رفعت هذا الملف إلى Git والمستودع عام، المفتاح سيصبح مكشوفاً. للإنتاج الأفضل: أنشئ `config.js` من متغير البيئة أثناء البناء (مثلاً في Netlify: Environment variables → `HSE_API_SECRET`، وفي أمر البناء اكتب قيمته في الملف المُنشأ). |

---

### الخطوة اليدوية 3 (اختيارية): تقييد CORS بـ ALLOWED_ORIGIN

| البند | الشرح |
|--------|--------|
| **ماذا تفعل؟** | إن أردت أن يسمح الخادم بطلبات من نطاق معيّن فقط، تضيف في Supabase (نفس قسم أسرار الدالة أو بيئة الدالة) سراً باسم `ALLOWED_ORIGIN` وقيمته مثلاً `https://yourdomain.com`. |
| **لماذا لا يُنفَّذ تلقائياً؟** | الكود لا يعرف **نطاق التطبيق الفعلي** (الدومين) الذي ستُنشِر عليه. قد يكون لديك أكثر من نطاق (تطوير، تجريبي، إنتاج). تعيين النطاق يتم حسب قرارك في بيئة النشر. |

---

### ملخص سريع

| الخطوة | يُنفَّذ تلقائياً؟ | السبب |
|--------|-------------------|--------|
| إضافة `HSE_API_SECRET` في Supabase | ❌ لا | يتطلب دخولك إلى حساب Supabase؛ لا يُوضع مفتاح إدارة في المشروع. |
| وضع المفتاح في `config.js` أو البيئة | ❌ لا | القيمة سرية ويجب أن تدخلها أنت أو بيئة النشر؛ لا تُخزَّن في المستودع. |
| تعيين `ALLOWED_ORIGIN` (اختياري) | ❌ لا | نطاق التطبيق يحدده صاحب المشروع حسب بيئة النشر. |

ما **تم** تنفيذه تلقائياً: آلية قراءة المفتاح من `__CONFIG__` و`AppState`، إرسال رأس `X-API-Key`، التحقق من المفتاح في الـ API، وملف/سكربت مثال وتوليد المفتاح. بعد تنفيذ الخطوات اليدوية أعلاه تصبح مصادقة API فعّالة في بيئتك.

---

## 8. ما تم تنفيذه خلال المراجعة والإصلاح

1. **إصلاح XSS محتمل في سجل الأنشطة:**  
   عرض نوع العملية في جدول السجلات يمر عبر `Utils.escapeHTML(this.getActionTypeLabel(log.actionType))`.

2. **مصادقة API (hse-api):**  
   عند تعيين `HSE_API_SECRET` في البيئة يُطلب رأس `X-API-Key` أو `Authorization: Bearer <المفتاح>`؛ الواجهة ترسل المفتاح من `AppState.hseApiSecret` أو `__CONFIG__.HSE_API_SECRET` (في `supabase-integration.js` و`login-init-fixed.js`).

3. **CORS:**  
   رؤوس CORS تُبنى ديناميكياً؛ دعم `ALLOWED_ORIGIN` من البيئة مع الرأس `x-api-key` في القائمة المسموحة.

4. **إخفاء تفاصيل الأخطاء:**  
   في حالة الخطأ تُعاد للمستخدم رسالة عامة فقط؛ التفاصيل تُسجّل في الخادم عبر `console.error`.

5. **توثيق:**  
   هذا الملف محدّث ليعكس الإصلاحات وقائمة التحقق للإنتاج.

---

*نهاية التقرير*

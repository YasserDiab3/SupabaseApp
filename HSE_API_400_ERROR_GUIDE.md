# فهم خطأ 400 من hse-api (Supabase Edge Function)

## ماذا يعني الخطأ؟

عندما ترى في وحدة التحكم (Console):

```
Failed to load resource: the server responded with a status of 400 ()
rtxleteymcqmtzrozckh.supabase.co/functions/v1/hse-api
```

هذا يعني أن **طلبك وصل إلى الدالة `hse-api`** لكن الخادم رفضه بسبب **طلب غير صالح (Bad Request)**.

بعد التحديث الأخير، سيظهر أيضاً سطر أوضح مثل:

```
[hse-api] 400 — action: getCompanySettings — relation "company_settings" does not exist
```

هذا يوضح: **رقم الحالة 400**، **اسم الإجراء (action)** الذي فشل، و**رسالة الخطأ** من الخادم.

---

## أسباب شائعة لـ 400

| السبب | ماذا تفعل |
|--------|------------|
| **جدول غير موجود** (`relation "xxx" does not exist`) | إنشاء الجدول في Supabase: Dashboard → Table Editor → إنشاء الجداول المطلوبة (مثل `company_settings`, `form_settings_db`, `users`, إلخ). راجع توثيق المشروع أو السكربتات التي تنشئ الجداول. |
| **معامل مطلوب ناقص** (`sheetName is required`, `observationId مطلوب`, إلخ) | التأكد أن الواجهة ترسل كل المعاملات المطلوبة لهذا الإجراء. مراجعة كود الواجهة أو دالة `hse-api` لمعرفة شكل الطلب الصحيح. |
| **خطأ من قاعدة البيانات** (صلاحيات RLS، قيود، مفتاح غير صالح) | في Dashboard → Logs أو في رسالة الخطأ: مراجعة سياسات RLS للجدول، أو أن البيانات المرسلة تتجاوز القيود (مثل حقل مطلوب فارغ). |
| **دالة غير محدّثة** | إذا أضفت إجراءات جديدة في الواجهة ولم تنشر الدالة: `npx supabase functions deploy hse-api` من مجلد المشروع. |

---

## كيف تتتبع الخطأ بدقة؟

1. **افتح أدوات المطور (F12) → تبويب Network.**
2. ابحث عن طلب إلى `hse-api` بحالة **400**.
3. اضغط على الطلب → تبويب **Response** (أو Preview): ستظهر رسالة الخطأ التي يرجعها الخادم (مثل `message: "relation \"company_settings\" does not exist"`).
4. في **Console** بعد التحديث ستجد سطراً مثل:  
   `[hse-api] 400 — action: getCompanySettings — ...`

بعد معرفة **action** و**رسالة الخطأ** يمكنك:
- إنشاء الجدول الناقص، أو
- إصلاح البيانات/المعاملات المرسلة، أو
- تحديث سياسات RLS أو نشر الدالة من جديد.

---

## تقليل تكرار الطلبات الفاشلة

إذا ظهرت عشرات الرسائل 400 للمرة نفسها، فغالباً هناك **حلقة مزامنة أو إعادة تحميل** تستدعي نفس الإجراء مراراً. بعد إصلاح سبب الـ 400 (جدول أو معاملات أو RLS)، ستتوقف الطلبات الفاشلة. لا حاجة عادةً لتعديل عدد المحاولات إلا إذا أردت إضافة "backoff" عند 400 (عدم إعادة المحاولة فوراً لنفس الإجراء).

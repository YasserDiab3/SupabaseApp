# مراجعة التوافق الشامل — الواجهة الأمامية و Supabase (hse-api)

## 1. ملخص التنفيذ

- **الواجهة:** `SupabaseApp/Frontend` (تعمل مع `useSupabaseBackend: true` و `supabase-integration.js`).
- **الخلفية:** دالة Edge `hse-api` في Supabase تستقبل `{ action, data }` وترد `{ success, data?, message? }`.
- **الجداول:** بنية `id` + `data` (jsonb) + `created_at` / `updated_at` مطابقة للنظام السابق (أوراق واحدة = جدول واحد).

---

## 2. الإجراءات (Actions) المدعومة في hse-api

### 2.1 إجراءات خاصة (معالجة مخصصة)

| الإجراء | الوصف | الجدول/الملاحظات |
|---------|--------|-------------------|
| `testConnection` | اختبار الاتصال | — |
| `initializeSheets` | تهيئة الاتصال | — |
| `getCompanySettings` | إعدادات الشركة (كائن واحد) | company_settings |
| `saveCompanySettings` | حفظ إعدادات الشركة | company_settings |
| `getFormSettings` | إعدادات النماذج/المواقع | form_settings_db |
| `saveFormSettings` | حفظ إعدادات النماذج | form_settings_db |
| `getUserTasksByUserId` | مهام المستخدم (مُرشَّحة) | user_tasks |
| `getDailyObservationsPptTemplateId` | قالب PPT | يرجع templateId: null |
| `setDailyObservationsPptTemplateId` | تعيين قالب PPT | نجاح بدون جدول |
| `exportDailyObservationsPptReport` | تصدير PPT | غير متاح (رسالة للمستخدم) |
| `readFromSheet` | قراءة ورقة حسب الاسم | أي جدول (مع تحويل الاسم → snake_case) |
| `saveToSheet` | حفظ/استبدال صفوف | أي جدول |
| `appendToSheet` | إلحاق صفوف | أي جدول |
| `getObservation` | ملاحظة واحدة بالمعرف | daily_observations |
| `updateObservationStatus` | تحديث حالة ملاحظة | daily_observations |
| `addObservationUpdate` | إضافة تحديث لملاحظة | daily_observations |
| `addObservationComment` | إضافة تعليق لملاحظة | daily_observations |
| `getChangeRequest` | طلب تغيير واحد | change_requests |
| `getNextChangeRequestNumber` | الرقم المسلسل التالي | change_requests |
| `getChangeRequestStatistics` | إحصائيات طلبات التغيير | change_requests |
| `requestPasswordReset` | طلب استرجاع كلمة المرور | users + password_reset_tokens |
| `resetPasswordWithToken` | تعيين كلمة مرور جديدة بالرمز | users + password_reset_tokens |
| `getAllIssues` | قائمة المشاكل (مع فلترة اختيارية) | issue_tracking |

### 2.2 إجراءات عامة (خريطة ACTION_SHEET_MAP → read/append/save/delete)

- **قراءة (read):** getAll*, get* (ما عدا getUserTasksByUserId و getChangeRequest و getObservation).
- **إلحاق (append):** add*, approve*, reject*, create*.
- **حفظ (save):** update* (بما فيها approveContractorApprovalRequest / rejectContractorApprovalRequest باستخدام requestId).
- **حذف (delete):** delete* (مع استخراج id من id / observationId / contractorId / approvedContractorId).

إذا كان الجدول غير موجود، **read** و **readFromSheet** يرجعان `{ success: true, data: [] }` بدلاً من 400 لتجنب كسر الواجهة.

---

## 3. أسماء الأوراق → أسماء الجداول (readFromSheet)

التحويل: `sheetNameToTable(sheetName)` — أسماء تحتوي `_` تُحوَّل إلى snake_case؛ غير ذلك PascalCase → snake_case.

| اسم الورقة (Frontend) | اسم الجدول (Supabase) |
|------------------------|------------------------|
| Users | users |
| PTWRegistry | ptw_registry |
| Blacklist_Register | blacklist_register |
| WasteManagement_RegularWasteTypes | waste_management_regular_waste_types |
| WasteManagement_RegularWasteRecords | waste_management_regular_waste_records |
| WasteManagement_RegularWasteSales | waste_management_regular_waste_sales |
| WasteManagement_HazardousWasteRecords | waste_management_hazardous_waste_records |
| WaterManagement_Records | water_management_records |
| GasManagement_Records | gas_management_records |
| ElectricityManagement_Records | electricity_management_records |
| ClinicVisits | clinic_visits |
| Employees | employees |
| Chemical_Register | chemical_register |
| SOPJHA | s_o_p_j_h_a |
| FireEquipmentInspections | fire_equipment_inspections |
| ContractorTrainings | contractor_trainings |

جميع الجداول أعلاه موجودة في الترحيلات (initial_sheets_tables أو complete_sheets_tables).

---

## 4. النماذج والإضافة / الحذف / الإغلاق

### 4.1 سلوك موحد متوقع

- **الإضافة (زر إضافة / حفظ):** استدعاء `sendRequest` أو `sendToAppsScript` مع `action` من نوع add* أو append أو saveToSheet حسب الوحدة.
- **الحذف:** استدعاء `action: delete*` أو `deleteFromSheet` مع معرف السجل (id / observationId / contractorId / approvedContractorId حسب السياق).
- **الإغلاق:** عادة `modal.remove()` أو `modal.classList.add('hidden')` أو `onclick="this.closest('.modal-overlay').remove()"` — كلها من جانب العميل ولا تعتمد على API.

### 4.2 وحدات تم التحقق من استدعاءاتها

| الوحدة | إضافة | حذف | ملاحظات |
|--------|--------|-----|---------|
| contractors | addContractorApprovalRequest, addContractorDeletionRequest | deleteApprovedContractor, deleteContractor | approve/reject مع requestId (يدعم UUID و CAR_) |
| changemanagement | addChangeRequest | — | getChangeRequest, updateChangeRequest, getNextChangeRequestNumber, getChangeRequestStatistics |
| dailyobservations | (عبر appendToSheet/saveToSheet للجدول) | deleteObservation, deleteAllObservations | getObservation, updateObservationStatus, addObservationUpdate, addObservationComment مضافة في API |
| incidents | addIncident, addSickLeave, addIncidentNotification | deleteIncident, deleteSafetyAlert | updateIncident مدعوم |
| clinic | addClinicVisit, addMedication, … | deleteMedication | readFromSheet(Users), saveToSheet(ClinicVisits) |
| violations | — | deleteViolationFromSheet | readFromSheet(Blacklist_Register) |
| ptw | getAllPTWs, readFromSheet(PTWRegistry) | deletePTW | — |
| issue-tracking | addIssue | — | getAllIssues مع فلترة |
| auth / app-utils / dashboard | updateUser, addUser, getCompanySettings, getFormSettings, saveFormSettings, getUserTasksByUserId | — | requestPasswordReset, resetPasswordWithToken |
| settings | saveCompanySettings | — | — |
| reports | getAllContractorTrainings, getAllTrainingAttendance, getAllTrainings | — | — |

### 4.3 تأكيد أزرار الإغلاق

- إغلاق النوافذ المنبثقة يتم من الواجهة فقط (لا طلبات API للإغلاق).
- إن وُجدت أي نوافذ لا تُغلق بشكل صحيح فيجب مراجعتها في الـ HTML/JS للعنصر (مثل زر الإغلاق أو النقر خارج المحتوى).

---

## 5. الفروقات المعروفة عن النظام السابق

1. **تصدير PPT للملاحظات اليومية:** غير متاح في نسخة Supabase؛ يظهر رسالة توضيحية للمستخدم.
2. **معرف طلبات المقاولين (CAR_):** يدعم النظام الآن UUID من Supabase؛ الواجهة تقبل أي معرف محفوظ (ما عدا TEMP_).
3. **جدول TrainingAttendance:** في الخريطة الحالية يتم قراءة نفس مصدر "Training" لـ getAllTrainingAttendance؛ إن كان النظام السابق يستخدم ورقة منفصلة لـ TrainingAttendance فيمكن لاحقاً إضافة جدول وتوجيه الإجراء إليه.
4. **الجداول غير المنشأة:** أي قراءة لجدول غير موجود تُرجع مصفوفة فارغة بدلاً من خطأ 400 لتفادي توقف الوحدات.

---

## 6. التوصيات للاختبار اليدوي

1. **تسجيل الدخول:** التأكد من عمل الدخول مع Supabase ومزامنة المستخدمين.
2. **المقاولون:** إضافة طلب اعتماد، اعتماده/رفضه، حذف مقاول، حذف مقاول معتمد.
3. **إدارة التغيير:** إضافة طلب تغيير، عرض التفاصيل، تحديث الحالة.
4. **الملاحظات اليومية:** عرض ملاحظة، تحديث الحالة، إضافة تحديث، إضافة تعليق، حذف ملاحظة.
5. **الحوادث:** إضافة حادث، تحديث، حذف؛ إضافة إجازة مرضية؛ إشعار حادث.
6. **العيادة:** إضافة زيارة/دواء، حذف دواء، قراءة المستخدمين.
7. **الإعدادات:** تحميل/حفظ إعدادات الشركة وإعدادات النماذج.
8. **كل نموذج:** التحقق من أن زر الإغلاق يغلق النافذة دون أخطاء في الـ Console.

---

## 7. آخر تحديثات على الكود (مراجعة 2025)

- إضافة معالجة **getObservation**, **updateObservationStatus**, **addObservationUpdate**, **addObservationComment** في hse-api.
- **readFromSheet** وقراءة الخريطة العامة: في حال عدم وجود الجدول يُرجعان `data: []` بدلاً من 400.
- دعم **requestId** في عملية save لاعتماد/رفض طلبات المقاولين.
- قبول معرف طلب اعتماد بمُعرف UUID أو CAR_ في واجهة المقاولين (SupabaseApp و Frontend).

# إصلاح تحوّل المدير إلى مستخدم وتغيير الصلاحيات تلقائياً بعد تسجيل الدخول

## سبب المشكلة

كان يحدث تغيير تلقائي للدور (من مدير إلى مستخدم) وللصلاحيات بسبب **ثلاثة أسباب** في الوجه الخلفية (Edge Function `hse-api`):

### 1. الإصلاح التلقائي عند قراءة المستخدمين (getSheet / readFromSheet)

- عند طلب قائمة المستخدمين، الكود كان يتحقق من وجود **الدور** عبر الحقل `existing.role` فقط.
- في قاعدة البيانات قد يكون الدور مخزناً تحت المفتاح **`Role`** (بحرف R كبير) وليس `role`.
- النتيجة: الكود يعتبر أن "الدور مفقود" ويُدخل الإصلاح التلقائي ويُعيِّن `merged.role = "user"` (لأن `flat.role` أحياناً لا يُملأ من `Role` في بعض الحالات)، فيُستبدل دور المدير بـ "user" ويُحفظ في الجدول.

### 2. نفس المنطق لـ name و email

- التحقق كان يعتمد فقط على `existing.name` و `existing.email` دون `Name` و `Email`، فالإصلاح التلقائي قد يُشغّل بشكل خاطئ أو يهمل قيمة موجودة.

### 3. تحديث المستخدم (updateUser) عند تسجيل الدخول/الخروج

- عند إرسال تحديث يحتوي على `role: ""` أو عدم إرسال `role`، كان الدمج `{ ...existingData, ...dataWithoutHash }` قد يضع قيمة فارغة للدور إذا وُجدت في الطلب، فيُمسح دور المدير.

---

## ما تم تنفيذه في الكود (إصلاح نهائي)

1. **في getSheet (قراءة المستخدمين):**
   - الاعتماد على **كلا المفتاحين** `Role` و `role` عند التحقق من وجود الدور والقيمة الحالية.
   - عند تعبئة الدور المفقود: استخدام القيمة الموجودة في القاعدة أولاً (`existing.Role` أو `existing.role`)، ثم `flat.role`، وأخيراً الافتراضي، بحيث **لا يُستبدل مدير (admin) بـ "user" أبداً**.
   - نفس الفكرة لـ name/email: التحقق من `Name`/`name` و `Email`/`email`.

2. **في saveToSheet (حفظ ورقة Users):**
   - عند الدمج، الاعتماد على `existingData.Role` أو `existingData.role` عند الحفاظ على الدور الحالي إذا لم يُرسل دور صريح وغير فارغ.

3. **في updateUser:**
   - إذا لم يُرسل الطلب دوراً صريحاً وغير فارغ، يتم **الإبقاء على دور المستخدم الحالي** من القاعدة (من `Role` أو `role`) وعدم استبداله.

4. **في الواجهة الأمامية (بعد المزامنة):**
   - عند استخدام Supabase، تم إيقاف استدعاء **autoSave('Users', ...)** بعد مزامنة المستخدمين (كان يُنفَّذ عند needsPasswordUpdate). ذلك يمنع إرسال قائمة المستخدمين الكاملة إلى **saveToSheet** بعد كل تسجيل دخول/مزامنة، فلا يُستبدل دور أو صلاحيات من أي حالة محلية قد تكون قديمة أو خاطئة.

بعد هذه التعديلات، لا يتغيّر دور المدير ولا صلاحياته تلقائياً بعد تسجيل الدخول أو المزامنة أو أي استدعاء عادي لـ readFromSheet / saveToSheet / updateUser.

---

## تفعيل عمود الصلاحيات (permissions) ومطابقة الواجهة الأمامية

- **عمود منفصل:** تمت إضافة عمود `permissions` (jsonb) في جدول `users` كمصدر واحد للصلاحيات؛ لا تُخزَّن الصلاحيات داخل `data` عند الحفظ (يتم حذفها من `data` قبل الكتابة).
- **القراءة:** في `readFromSheet` (getSheet) يتم تعبئة `flat.permissions` من العمود `permissions` أولاً، ثم من `data.permissions` كاحتياطي، ثم `{}`.
- **الإصلاح التلقائي (getSheet):** عند إصلاح نقص name/email/role، يتم الحفاظ على عمود الصلاحيات (لا تُكتَب صلاحيات داخل `data`) وإرسال `permissions` من الصف الحالي في الـ upsert.
- **الواجهة الأمامية:**
  - بعد مزامنة المستخدمين (`syncUsers`): يتم تطبيع صلاحيات كل مستخدم عبر `Permissions.normalizePermissions` لضمان شكل موحّد (كائن صلاحيات).
  - عند تعيين الجلسة (تسجيل الدخول): يتم تطبيع `userPermissions` عبر `Permissions.normalizePermissions` قبل تعيين `AppState.currentUser.permissions` لتفادي أخطاء في القائمة الجانبية أو تسجيل الدخول.
- **تسجيل الدخول:** عند استدعاء `updateUser` بعد تسجيل الدخول (مثلاً مع `postLoginPolicySeenAt` فقط)، الـ Backend يحافظ على الصلاحيات والدور من القاعدة ولا يستبدلها؛ لا توجد مشكلات أو أخطاء متوقعة في تسجيل الدخول بسبب الصلاحيات.

---

## إصلاح خطأ النشر (إن واجهتك)

إذا ظهر عند النشر: **"Nullish coalescing operator(??) requires parens when mixing with logical operators"** في السطر 357، فقد تم إصلاحه بإضافة أقواس حول التعبير بعد `??` في ملف `hse-api/index.ts`. أعد النشر بعد سحب آخر التعديلات.

---

## المطلوب تنفيذه يدوياً

### 1. نشر الـ Edge Function المحدّثة (إلزامي)

حتى يُطبَّق الإصلاح في السيرفر، يجب نشر الدالة:

```bash
cd Backend
supabase functions deploy hse-api
```

أو باستخدام السكربت إن وُجد:

```powershell
.\deploy.ps1
```

### 2. إصلاح بيانات المدير الحالية في Supabase (إن تحوّل إلى مستخدم سابقاً)

إذا كان حساب المدير قد تحوّل بالفعل إلى "مستخدم" أو فقد الصلاحيات:

1. افتح **Supabase Dashboard** → **Table Editor** → جدول **`public.users`**.
2. ابحث عن صف المدير (حسب البريد أو الـ `id`).
3. اضغط على تعديل عمود **`data`** (jsonb).
4. تأكد من وجود الحقول التالية بالقيم الصحيحة (يمكن تعديل القيم لتناسب مديرك):

```json
{
  "name": "اسم المدير",
  "email": "admin@example.com",
  "role": "admin",
  "permissions": {}
}
```

- إذا وُجد مفتاح **`Role`** (بحرف R كبير) فقط، أضف أيضاً **`role`** بنفس القيمة `"admin"` حتى يتوافق الكود مع كلا المفتاحين.
- احفظ السجل.

### 3. التحقق بعد النشر

1. تسجيل خروج المدير ثم تسجيل دخول مرة أخرى.
2. في **Table Editor** تحقق من أن عمود **`data`** للمدير لا يزال يحتوي على `"role": "admin"` (وإن أردت `Role` أيضاً) وأن **`permissions`** لم تُمسح.
3. التأكد من أن واجهة التطبيق تعرض المدير كمدير وأن الصلاحيات والوحدات تظهر كما يجب.

---

## ملخص

| السبب | الإصلاح في الكود |
|--------|-------------------|
| الاعتماد على `role` فقط وتجاهل `Role` في getSheet | التحقق من `Role` و `role` واستخدام القيمة الموجودة في القاعدة أولاً قبل أي افتراضي |
| تعيين افتراضي "user" عند "نقص" الدور | عدم استبدال دور موجود (من `Role` أو `role`) أبداً بـ "user" |
| updateUser يمسح الدور عند عدم إرساله | الحفاظ على دور القاعدة عندما لا يُرسل الطلب دوراً صريحاً وغير فارغ |
| saveToSheet يكتب دوراً من الوارد فقط | الحفاظ على دور القاعدة عند غياب دور صريح في الطلب، مع دعم `Role` و `role` |

بعد تنفيذ **نشر الدالة** وإصلاح بيانات المدير في الجدول (إن لزم)، المشكلة يُفترض أن تكون محلولة بشكل نهائي.

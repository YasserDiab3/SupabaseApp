# ✅ التحقق من استرجاع كلمة المرور

## ما تم تنفيذه بنجاح

| الخطوة | الحالة |
|--------|--------|
| ترحيل جدول `password_reset_tokens` | ✅ تم (`npx supabase db push` — تم تطبيق `20260221130000_password_reset_tokens.sql`) |
| نشر دالة `hse-api` (تحتوي على `requestPasswordReset` و `resetPasswordWithToken`) | ✅ تم (`npx supabase functions deploy hse-api`) |

## ربط المكوّنات

- **الخادم (hse-api):**
  - `requestPasswordReset`: يتحقق من البريد في جدول `users`، ينشئ رمزاً في `password_reset_tokens`، ويرسل بريداً عبر Resend إن وُجد المفتاح.
  - `resetPasswordWithToken`: يتحقق من الرمز، يحدّث `users.password_hash`، ويحذف الرمز بعد النجاح.

- **الواجهة:**
  - شاشة الدخول → «نسيت كلمة المرور؟» → إدخال البريد → استدعاء `requestPasswordReset`.
  - الرابط في البريد: `عنوان-التطبيق?resetToken=...` → صفحة تعيين كلمة مرور جديدة → استدعاء `resetPasswordWithToken`.

## ما تحتاج تفعيله لإرسال البريد

حالياً **إرسال البريد** يعتمد على **Resend**. إذا لم تضبط المفتاح:

- عند طلب استرجاع كلمة المرور ستظهر رسالة: **«خدمة استرجاع كلمة المرور غير مفعّلة. يرجى التواصل مع مدير النظام.»**

لتفعيل الإرسال:

1. إنشاء حساب على [resend.com](https://resend.com) والحصول على **API Key**.
2. في لوحة Supabase: **Project Settings** → **Edge Functions** → الدالة **hse-api** → **Secrets** (أو إعدادات الدالة):
   - `RESEND_API_KEY` = مفتاحك من Resend.
   - `RESEND_FROM_EMAIL` = عنوان المرسل، مثال: `استرجاع كلمة المرور <noreply@yourdomain.com>`  
     (مع Resend المجاني يمكن استخدام نطاقهم، راجع وثائقهم.)

بعد حفظ الـ Secrets، أعد نشر الدالة مرة واحدة (إن لزم):

```powershell
npx supabase functions deploy hse-api
```

## اختبار سريع بدون بريد (اختياري)

- يمكنك اختبار **تعيين كلمة المرور بالرمز** فقط:
  1. إدراج رمز تجريبي في `password_reset_tokens` (من Supabase → SQL Editor) مع بريد مستخدم موجود و `expires_at` في المستقبل.
  2. فتح الرابط: `عنوان-التطبيق?resetToken=الرمز_المدخل`.
  3. التأكد من ظهور نموذج «تعيين كلمة مرور جديدة» وأن تعيين كلمة المرور يعمل ثم تسجيل الدخول بالبريد وكلمة المرور الجديدة.

---

**الخلاصة:** الترحيل ونشر الدالة والربط بين الواجهة والـ API تمت بشكل صحيح. لاستكمال الاسترجاع عبر البريد يكفي تفعيل Resend بإضافة `RESEND_API_KEY` و `RESEND_FROM_EMAIL` في إعدادات الدالة.

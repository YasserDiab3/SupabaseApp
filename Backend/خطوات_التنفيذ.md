# خطوات التنفيذ

دليل تنفيذ التحديثات (حفظ بيانات المستخدمين في Supabase تلقائياً، دمج التحديثات، إصلاح ظهور المديولات للمدير).

---

## 0. تشغيل أوامر Supabase (عند ظهور "supabase is not recognized")

Supabase CLI **لا يدعم التثبيت العالمي عبر npm** على Windows. استخدم أحد الخيارين:

### الخيار أ: استخدام `npx` (بدون تثبيت)

من مجلد الـ Backend شغّل كل أمر بهذا الشكل (يتم تنزيل الأداة تلقائياً عند أول استخدام):

```powershell
cd "d:\App\v.2-ok run\SupabaseApp\Backend"
npx supabase login
npx supabase link --project-ref YOUR_PROJECT_REF
npx supabase functions deploy hse-api
npx supabase db push
```

يجب أن يكون **Node.js** مثبتاً ([nodejs.org](https://nodejs.org)).

### الخيار ب: تثبيت عبر Scoop (أمر `supabase` مباشرة)

1. تثبيت [Scoop](https://scoop.sh) إن لم يكن مثبتاً.
2. في PowerShell:
   ```powershell
   scoop bucket add supabase https://github.com/supabase/scoop-bucket.git
   scoop install supabase
   ```
3. بعدها يمكن استخدام `supabase` مباشرة:
   ```powershell
   supabase login
   supabase functions deploy hse-api
   ```

---

## 1. نشر دالة الـ API (Edge Function) على Supabase

يجب نشر الدالة `hse-api` حتى تعمل التعديلات (دمج تحديث المستخدم، الحفظ التلقائي عند القراءة).

### من سطر الأوامر (موصى به)

1. **فتح الطرفية** في مجلد الـ Backend:
   ```powershell
   cd "d:\App\v.2-ok run\SupabaseApp\Backend"
   ```

2. **تسجيل الدخول في Supabase** (مرة واحدة فقط):
   ```powershell
   npx supabase login
   ```

3. **ربط المشروع** (إن لم يكن مربوطاً مسبقاً):
   ```powershell
   npx supabase link --project-ref YOUR_PROJECT_REF
   ```
   استبدل `YOUR_PROJECT_REF` بمعرّف مشروعك من لوحة Supabase (Project Settings → General).

4. **نشر الدالة:**
   ```powershell
   npx supabase functions deploy hse-api
   ```
   (أو `supabase functions deploy hse-api` إذا ثبّت CLI عبر Scoop)

### من لوحة Supabase

- من **Edge Functions** → اختيار دالة **hse-api** (أو إنشاؤها) → استبدال الكود بمحتوى الملف `supabase/functions/hse-api/index.ts` من المشروع → **Deploy**.

---

## 2. تشغيل ترحيلات قاعدة البيانات (اختياري)

لإنشاء الجداول إن لم تكن موجودة (مثل `users`, `module_management`)، شغّل الترحيلات مرة واحدة:

```powershell
cd "d:\App\v.2-ok run\SupabaseApp\Backend"
npx supabase db push
```

- **تعيين مدير من SQL:** إذا لم تظهر صلاحية المدير بعد الدخول (عمود `data` يحتوي على `"role": "user"`)، نفّذ من **Supabase → SQL Editor** مرة واحدة:
  ```sql
  UPDATE public.users
  SET data = COALESCE(data, '{}'::jsonb) || '{"name":"Yasser Diab","email":"yasser.diab@icapp.com.eg","role":"admin"}'::jsonb,
      updated_at = now()
  WHERE id = 'yasser.diab@icapp.com.eg';
  ```
  ثم سجّل خروجاً ودخولاً من التطبيق.

---

## 3. الواجهة الأمامية (Frontend)

لا تحتاج خطوات نشر إضافية. التأكد من:

- أن التطبيق يشير إلى عنوان الـ API الخاص بمشروع Supabase (متغيرات البيئة أو إعدادات الاتصال).
- تحديث الصفحة أو إعادة تسجيل الدخول بعد نشر الدالة لاستخدام السلوك الجديد.

---

## 4. التحقق بعد التنفيذ

1. **تسجيل الدخول** بحساب المدير.
2. التأكد من ظهور **جميع المديولات** في القائمة الجانبية (ليس لوحة التحكم فقط).
3. الضغط على **«اطّلعت على السياسة»** بعد الدخول، ثم إعادة تحميل الصفحة وتسجيل الدخول مرة أخرى — يجب أن تبقى الصلاحيات وبيانات المستخدم (الاسم، البريد، الدور) كما هي.
4. من **Supabase → Table Editor → جدول `users`**: التحقق من أن عمود **`data`** يحتوي على `name`, `email`, `role` ولا يُستبدل بتسجيل يحتوي فقط على `postLoginPolicySeenAt`.

---

## ملخص الأوامر (نسخ سريع)

```powershell
cd "d:\App\v.2-ok run\SupabaseApp\Backend"
npx supabase login
npx supabase link --project-ref YOUR_PROJECT_REF
npx supabase functions deploy hse-api
npx supabase db push
```

(استبدل `YOUR_PROJECT_REF` بمعرّف المشروع من Supabase → Project Settings → General.)

بعد تنفيذ هذه الخطوات، حفظ بيانات المستخدمين في Supabase يتم تلقائياً دون الحاجة لتشغيل Run من SQL Editor في كل مرة.

<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <script>
        (function(){ try {
            if (window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') return;
            function rm(){ var link = document.querySelector('link[rel="manifest"]'); if (link && link.parentNode) link.parentNode.removeChild(link); }
            rm();
            if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', rm); else setTimeout(rm, 0);
        } catch(e) {} })();
    </script>
    <!-- ⚡⚡⚡ ULTIMATE ERROR SUPPRESSOR V5 - MUST BE FIRST ⚡⚡⚡ -->
    <!-- يقمع أخطاء رفع الملفات (مصدر الملفات / الخادم) -->
    <script>
        // ========================================
        // ULTIMATE PROTECTION V5 - قمع نهائي محسّن
        // يعترض روابط مصدر الملفات ويحولها لصيغة آمنة (يدعم drive وغيرها)
        // ========================================
        (function() {
            'use strict';
            
            // LAYER -1: تحويل روابط الملفات إلى صيغة thumbnail الآمنة
            // هذا يمنع تحميل uploadmanager.js من الأساس
            window.__convertGoogleDriveUrl = function(url) {
                if (!url || typeof url !== 'string') return url;
                
                // تحويل /uc?export=view URLs إلى /thumbnail
                // هذه الصيغة لا تحمّل uploadmanager.js
                var driveUcMatch = url.match(/drive\.google\.com\/uc\?.*id=([a-zA-Z0-9_-]+)/i);
                if (driveUcMatch && driveUcMatch[1]) {
                    return 'https://drive.google.com/thumbnail?id=' + driveUcMatch[1] + '&sz=w1000';
                }
                
                // تحويل /file/d/ URLs
                var driveFileMatch = url.match(/drive\.google\.com\/file\/d\/([a-zA-Z0-9_-]+)/i);
                if (driveFileMatch && driveFileMatch[1]) {
                    return 'https://drive.google.com/thumbnail?id=' + driveFileMatch[1] + '&sz=w1000';
                }
                
                return url;
            };
            
            // ✅ LAYER 0: حماية فورية قبل أي شيء - اعتراض contentWindow/contentDocument
            try {
                // حماية HTMLIFrameElement.prototype.contentWindow
                var iframeContentWindowDesc = Object.getOwnPropertyDescriptor(HTMLIFrameElement.prototype, 'contentWindow');
                if (iframeContentWindowDesc && iframeContentWindowDesc.get) {
                    var originalContentWindowGetter = iframeContentWindowDesc.get;
                    Object.defineProperty(HTMLIFrameElement.prototype, 'contentWindow', {
                        get: function() {
                            try {
                                return originalContentWindowGetter.call(this);
                            } catch(e) {
                                return null;
                            }
                        },
                        configurable: true
                    });
                }
                
                // حماية HTMLIFrameElement.prototype.contentDocument
                var iframeContentDocDesc = Object.getOwnPropertyDescriptor(HTMLIFrameElement.prototype, 'contentDocument');
                if (iframeContentDocDesc && iframeContentDocDesc.get) {
                    var originalContentDocGetter = iframeContentDocDesc.get;
                    Object.defineProperty(HTMLIFrameElement.prototype, 'contentDocument', {
                        get: function() {
                            try {
                                return originalContentDocGetter.call(this);
                            } catch(e) {
                                return null;
                            }
                        },
                        configurable: true
                    });
                }
            } catch(e) {}
            
            // ✅ LAYER 0.5: اعتراض HTMLImageElement.prototype.src
            // تحويل روابط الملفات تلقائياً عند تعيين src
            try {
                var imgSrcDesc = Object.getOwnPropertyDescriptor(HTMLImageElement.prototype, 'src');
                if (imgSrcDesc && imgSrcDesc.set) {
                    var originalSrcSetter = imgSrcDesc.set;
                    var originalSrcGetter = imgSrcDesc.get;
                    Object.defineProperty(HTMLImageElement.prototype, 'src', {
                        get: function() {
                            return originalSrcGetter ? originalSrcGetter.call(this) : this.getAttribute('src');
                        },
                        set: function(val) {
                            try {
                                // تحويل روابط الملفات
                                var safeUrl = window.__convertGoogleDriveUrl ? window.__convertGoogleDriveUrl(val) : val;
                                
                                // إضافة onerror تلقائي للصور من مصدر الملفات
                                if (safeUrl && typeof safeUrl === 'string' && safeUrl.indexOf('drive.google.com') > -1) {
                                    var self = this;
                                    if (!self.__driveErrorHandler) {
                                        self.__driveErrorHandler = true;
                                        self.addEventListener('error', function(e) {
                                            e.stopPropagation();
                                            e.stopImmediatePropagation();
                                        }, true);
                                    }
                                }
                                
                                return originalSrcSetter.call(this, safeUrl);
                            } catch(e) {
                                return originalSrcSetter.call(this, val);
                            }
                        },
                        configurable: true,
                        enumerable: true
                    });
                }
            } catch(e) {}
            
            // ✅ LAYER 1: قمع فوري لـ console.error
            if (window.console && window.console.error) {
                var __origErr = window.console.error;
                window.console.error = function() {
                    try {
                        var a0 = arguments[0];
                        if (a0) {
                            var s = '';
                            try {
                                s = (typeof a0 === 'string' ? a0 : (a0.message || a0.stack || String(a0) || '')).toLowerCase();
                            } catch(e) { return; }
                            // فحص فوري للأنماط المعروفة
                            if (s.indexOf('uploadmanager') > -1 || s.indexOf(':518:') > -1 ||
                                s.indexOf('cannot read') > -1 || s.indexOf('htmlstyleelement') > -1 ||
                                s.indexOf('htmlimageelement') > -1 || s.indexOf('svgsvgelement') > -1 ||
                                s.indexOf('contentdocument') > -1 || s.indexOf('contentwindow') > -1 ||
                                (s.indexOf('uncaught') > -1 && s.indexOf('typeerror') > -1 && s.indexOf('document') > -1)) {
                                return; // قمع
                            }
                        }
                        // فحص بقية المعاملات
                        for (var i = 0; i < arguments.length; i++) {
                            var arg = arguments[i];
                            if (arg && typeof arg === 'object') {
                                try {
                                    var msg = String(arg.message || '').toLowerCase();
                                    var stack = String(arg.stack || '').toLowerCase();
                                    if (msg.indexOf('uploadmanager') > -1 || stack.indexOf('uploadmanager') > -1 ||
                                        stack.indexOf(':518:') > -1 || (msg.indexOf('cannot read') > -1 && msg.indexOf('document') > -1)) {
                                        return;
                                    }
                                } catch(e) { return; }
                            }
                        }
                        return __origErr.apply(this, arguments);
                    } catch(e) { return; }
                };
            }
            
            // ✅ LAYER 2: قمع window.onerror
            var __origOnError = window.onerror;
            window.onerror = function(msg, url, line, col, error) {
                try {
                    // فحص فوري للسطر 518
                    if (line === 518 || Number(line) === 518) return true;
                    
                    var m = String(msg || '').toLowerCase();
                    var u = String(url || '').toLowerCase();
                    var stack = '';
                    try { if (error && error.stack) stack = String(error.stack).toLowerCase(); } catch(e) {}
                    
                    // فحص شامل (يشمل SVGSVGElement من امتداد uploadmanager)
                    if (u.indexOf('uploadmanager') > -1 || stack.indexOf('uploadmanager') > -1 ||
                        stack.indexOf(':518:') > -1 || m.indexOf('uploadmanager') > -1 ||
                        (m.indexOf('cannot read') > -1 && m.indexOf('document') > -1) ||
                        (m.indexOf('htmlstyleelement') > -1) || (m.indexOf('htmlimageelement') > -1) || (m.indexOf('svgsvgelement') > -1)) {
                        return true;
                    }
                    
                    if (__origOnError) return __origOnError.apply(this, arguments);
                } catch(e) { return true; }
                return false;
            };
            
            // ✅ LAYER 3: قمع error events (capture phase)
            if (window.addEventListener) {
                window.addEventListener('error', function(e) {
                    try {
                        var line = e.lineno;
                        var msg = String(e.message || '').toLowerCase();
                        var file = String(e.filename || '').toLowerCase();
                        
                        // فحص السطر 518
                        if (line === 518 || Number(line) === 518) {
                            e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation();
                            return false;
                        }
                        
                        // فحص الأنماط (يشمل SVGSVGElement)
                        if (msg.indexOf('uploadmanager') > -1 || file.indexOf('uploadmanager') > -1 ||
                            msg.indexOf('cannot read') > -1 || msg.indexOf('htmlstyleelement') > -1 ||
                            msg.indexOf('htmlimageelement') > -1 || msg.indexOf('svgsvgelement') > -1 ||
                            (msg.indexOf('typeerror') > -1 && msg.indexOf('document') > -1)) {
                            e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation();
                            return false;
                        }
                    } catch(err) {
                        e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation();
                        return false;
                    }
                }, true);
            }
            
            // ✅ LAYER 4: قمع unhandledrejection
            if (window.addEventListener) {
                window.addEventListener('unhandledrejection', function(e) {
                    try {
                        var reason = e.reason;
                        var str = String(reason || '').toLowerCase();
                        var msg = (reason && reason.message ? String(reason.message) : '').toLowerCase();
                        var stack = (reason && reason.stack ? String(reason.stack) : '').toLowerCase();
                        var combined = str + ' ' + msg + ' ' + stack;
                        
                        if (combined.indexOf('uploadmanager') > -1 || combined.indexOf(':518:') > -1 ||
                            (combined.indexOf('cannot read') > -1 && combined.indexOf('document') > -1)) {
                            e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation();
                            return false;
                        }
                    } catch(err) {}
                }, true);
            }
            
            // ✅ LAYER 5: حماية Chrome Extensions
            if (typeof chrome !== 'undefined' && chrome.runtime) {
                try {
                    var origLastError = chrome.runtime.lastError;
                    Object.defineProperty(chrome.runtime, 'lastError', {
                        get: function() {
                            try {
                                var err = origLastError;
                                if (err && err.message) {
                                    var msg = String(err.message).toLowerCase();
                                    if (msg.indexOf('uploadmanager') > -1 || msg.indexOf('contentdocument') > -1 || msg.indexOf('contentwindow') > -1) {
                                        return null;
                                    }
                                }
                                return err;
                            } catch(e) { return null; }
                        },
                        configurable: true
                    });
                } catch(e) {}
            }
            
            // ✅ LAYER 6: MutationObserver لاعتراض الصور المضافة عبر innerHTML
            // هذا يصطاد الصور التي لا تمر عبر src setter
            try {
                if (typeof MutationObserver !== 'undefined') {
                    var processGoogleDriveImages = function(element) {
                        if (!element) return;
                        var images = element.querySelectorAll ? element.querySelectorAll('img[src*="drive.google.com"]') : [];
                        for (var i = 0; i < images.length; i++) {
                            var img = images[i];
                            var src = img.getAttribute('src');
                            if (src && src.indexOf('drive.google.com') > -1) {
                                // تحويل URL إلى صيغة آمنة
                                var safeUrl = window.__convertGoogleDriveUrl(src);
                                if (safeUrl !== src) {
                                    img.setAttribute('src', safeUrl);
                                }
                                // إضافة error handler
                                if (!img.__driveErrorHandler) {
                                    img.__driveErrorHandler = true;
                                    img.addEventListener('error', function(e) {
                                        e.stopPropagation();
                                        e.stopImmediatePropagation();
                                    }, true);
                                }
                            }
                        }
                    };
                    
                    var observer = new MutationObserver(function(mutations) {
                        for (var i = 0; i < mutations.length; i++) {
                            var mutation = mutations[i];
                            // فحص العناصر المضافة
                            if (mutation.addedNodes) {
                                for (var j = 0; j < mutation.addedNodes.length; j++) {
                                    var node = mutation.addedNodes[j];
                                    if (node.nodeType === 1) { // Element node
                                        // فحص العنصر نفسه إذا كان صورة
                                        if (node.tagName === 'IMG') {
                                            var src = node.getAttribute('src');
                                            if (src && src.indexOf('drive.google.com') > -1) {
                                                var safeUrl = window.__convertGoogleDriveUrl(src);
                                                if (safeUrl !== src) {
                                                    node.setAttribute('src', safeUrl);
                                                }
                                                if (!node.__driveErrorHandler) {
                                                    node.__driveErrorHandler = true;
                                                    node.addEventListener('error', function(e) {
                                                        e.stopPropagation();
                                                        e.stopImmediatePropagation();
                                                    }, true);
                                                }
                                            }
                                        }
                                        // فحص الصور داخل العنصر
                                        processGoogleDriveImages(node);
                                    }
                                }
                            }
                        }
                    });
                    
                    // بدء المراقبة عند جاهزية DOM
                    if (document.body) {
                        observer.observe(document.body, { childList: true, subtree: true });
                    } else {
                        document.addEventListener('DOMContentLoaded', function() {
                            observer.observe(document.body, { childList: true, subtree: true });
                            // معالجة الصور الموجودة
                            processGoogleDriveImages(document.body);
                        });
                    }
                }
            } catch(e) {}
            
            // تعيين flags
            window.__errorSuppressorActive = true;
            window.__chromeErrorSuppressorActive = true;
            window.__ultimateProtectionV5 = true;
        })();
    </script>
    <script src="js/modules/uploadmanager-suppressor.js"></script>
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
    <meta name="description"
        content="نظام إدارة السلامة المهنية للشركة العالمية للانتاج والتصنيع الزراعي - HSE Management System">
    <meta name="keywords" content="السلامة المهنية, HSE, الصناعات الغذائية, حوادث العمل, تصاريح العمل">
    <meta name="author" content="HSE Team">

    <!-- Permissions Policy - Allow camera access for QR scanning -->
    <meta http-equiv="Permissions-Policy" content="camera=self, microphone=self, geolocation=self">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="HSE Management System - نظام السلامة المهنية">
    <meta property="og:description" content="نظام إدارة السلامة المهنية للشركة العالمية للانتاج والتصنيع الزراعي">

    <title>HSE Management System - نظام السلامة المهنية</title>

    <!-- ========================================
         ✅ قمع ULTRA-AGGRESSIVE لأخطاء uploadmanager.js:518
         INLINE CODE - يعمل فوراً قبل أي شيء آخر
         ======================================== -->
    <script>
        // ✅✅✅ ULTRA-AGGRESSIVE ERROR SUPPRESSOR ✅✅✅
        // يجب أن يكون هذا أول JavaScript يتم تنفيذه
        (function() {
            'use strict';
            
            // قمع console.error فوراً - بدون أي فحص
            if (typeof console !== 'undefined' && console.error) {
                const _originalError = console.error;
                console.error = function(...args) {
                    // فحص فوري جداً - أسرع ما يمكن
                    if (args.length > 0 && args[0]) {
                        const first = String(args[0]).toLowerCase();
                        // قائمة سوداء فورية
                        if (first.includes('uploadmanager') ||
                            first.includes('518') ||
                            first.includes(':518:') ||
                            first.includes('cannot read') ||
                            first.includes('htmlstyleelement') ||
                            first.includes('htmlimageelement') ||
                            first.includes('svgsvgelement') ||
                            first.includes('anonymous') ||
                            first.includes('contentdocument') ||
                            first.includes('contentwindow')) {
                            return; // قمع فوري - لا نعمل شيء
                        }
                    }
                    _originalError.apply(console, args);
                };
            }
            
            // قمع console.warn فوراً
            if (typeof console !== 'undefined' && console.warn) {
                const _originalWarn = console.warn;
                console.warn = function(...args) {
                    if (args.length > 0 && args[0]) {
                        const first = String(args[0]).toLowerCase();
                        if (first.includes('uploadmanager') || first.includes('518')) {
                            return;
                        }
                    }
                    _originalWarn.apply(console, args);
                };
            }
            
            // قمع window.onerror فوراً
            window.onerror = function(msg, url, line, col, error) {
                // فحص السطر 518 فوراً
                if (line === 518 || String(line) === '518') {
                    return true; // قمع
                }
                
                // فحص الرسالة
                const msgLower = String(msg || '').toLowerCase();
                const urlLower = String(url || '').toLowerCase();
                
                if (msgLower.includes('uploadmanager') ||
                    msgLower.includes('cannot read') ||
                    msgLower.includes('htmlstyleelement') ||
                    msgLower.includes('anonymous') ||
                    msgLower.includes('contentdocument') ||
                    msgLower.includes('contentwindow') ||
                    urlLower.includes('uploadmanager') ||
                    urlLower.includes('518')) {
                    return true; // قمع
                }
                
                return false;
            };
            
            // قمع error events فوراً
            window.addEventListener('error', function(e) {
                if (e.lineno === 518 || String(e.lineno) === '518') {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    return false;
                }
                
                const msg = String(e.message || '').toLowerCase();
                const file = String(e.filename || '').toLowerCase();
                
                if (msg.includes('uploadmanager') ||
                    msg.includes('cannot read') ||
                    msg.includes('htmlstyleelement') ||
                    msg.includes('anonymous') ||
                    msg.includes('contentdocument') ||
                    msg.includes('contentwindow') ||
                    file.includes('uploadmanager') ||
                    file.includes('518')) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    return false;
                }
            }, true); // capture phase - قبل أي شيء
            
            // قمع unhandledrejection
            window.addEventListener('unhandledrejection', function(e) {
                const reason = String(e.reason || '').toLowerCase();
                if (reason.includes('uploadmanager') ||
                    reason.includes('cannot read') ||
                    reason.includes('518')) {
                    e.preventDefault();
                    return false;
                }
            }, true);
            
            // ✅ قمع إضافي: Override Object.defineProperty لمنع أي محاولات لتجاوز الحماية
            try {
                const originalDefineProperty = Object.defineProperty;
                Object.defineProperty = function(obj, prop, descriptor) {
                    // لا نتدخل في defineProperty - نتركه يعمل بشكل طبيعي
                    return originalDefineProperty.call(this, obj, prop, descriptor);
                };
            } catch (e) {
                // ignore
            }
            
            console.log('%c✅ ULTRA-AGGRESSIVE Error Suppressor Active (3 Layers)', 'color: green; font-weight: bold; font-size: 14px;');
        })();
    </script>

    <!-- ========================================
         ✅ قمع إضافي inline لضمان الحماية الكاملة
         ======================================== -->
    <script>
        // ✅ قمع فوري وشامل قبل أي شيء آخر
        (function() {
            'use strict';
            
            // دالة فحص شاملة ومحسّنة لأخطاء uploadmanager
            const isUploadManagerError = function(text) {
                if (!text) return false;
                const t = String(text).toLowerCase();
                
                // فحص مباشر لـ uploadmanager
                if (t.includes('uploadmanager') || 
                    t.includes('upload-manager') ||
                    /uploadmanager\.js/i.test(t) ||
                    /uploadmanager\.js:\d+/i.test(t) ||
                    /uploadmanager\.js:518/i.test(t)) {
                    return true;
                }
                
                // فحص النمط الخاص: "Cannot read properties of undefined (reading 'document')"
                // هذا النمط يأتي من uploadmanager حتى لو لم يُذكر في النص
                if (t.includes('cannot read propert') && 
                    t.includes('undefined') && 
                    t.includes('document')) {
                    // إذا كان مع HTMLStyleElement/HTMLImageElement/SVGSVGElement أو anonymous، نعتبره uploadmanager
                    if (t.includes('htmlstyleelement') || 
                        t.includes('htmlimageelement') || 
                        t.includes('svgsvgelement') || 
                        t.includes('anonymous') ||
                        t.includes('518') ||
                        t.includes(':518') ||
                        /:\d+:\d+/.test(t)) { // أي خطأ مع line:column numbers
                        return true;
                    }
                }
                
                // فحص النمط: HTMLStyleElement.<anonymous>  
                if ((t.includes('htmlstyleelement') || 
                     t.includes('htmlimageelement') || 
                     t.includes('svgsvgelement')) && 
                    (t.includes('anonymous') || t.includes('<anonymous>'))) {
                    // إذا كان مع 518 أو مع 'reading' أو 'document'
                    if (t.includes('518') || 
                        t.includes('reading') || 
                        t.includes('document') ||
                        /:\d+:\d+/.test(t)) {
                        return true;
                    }
                }
                
                // فحص أي uncaught typeerror مع document و undefined
                if (t.includes('uncaught') && 
                    t.includes('typeerror') &&
                    t.includes('document') && 
                    t.includes('undefined')) {
                    return true;
                }
                
                // فحص نمط "reading 'document'" مع anonymous
                if (t.includes('reading') && 
                    t.includes('document') && 
                    t.includes('anonymous')) {
                    return true;
                }
                
                return false;
            };
            
            // ✅ قمع window.onerror فوراً - محسّن وعدواني
            window.onerror = function(msg, url, line, col, error) {
                try {
                    // فحص فوري للسطر 518
                    if (line === 518 || String(line) === '518' || Number(line) === 518) {
                        return true; // قمع فوري
                    }
                    
                    const msgStr = String(msg || '').toLowerCase();
                    const urlStr = String(url || '').toLowerCase();
                    const errorStack = (error && error.stack ? String(error.stack) : '').toLowerCase();
                    const combined = msgStr + ' ' + urlStr + ' ' + errorStack;
                    
                    // فحص شامل
                    if (isUploadManagerError(combined) || 
                        urlStr.includes('uploadmanager') ||
                        urlStr.includes('upload-manager') ||
                        /uploadmanager\.js/i.test(urlStr) ||
                        // فحص النمط المحدد
                        (msgStr.includes('cannot read') && 
                         msgStr.includes('undefined') && 
                         msgStr.includes('document')) ||
                        (msgStr.includes('htmlstyleelement') && 
                         msgStr.includes('anonymous')) ||
                        (msgStr.includes('htmlimageelement') && 
                         msgStr.includes('anonymous')) ||
                        (msgStr.includes('svgsvgelement') && 
                         msgStr.includes('anonymous')) ||
                        (msgStr.includes('uncaught') && 
                         msgStr.includes('typeerror') && 
                         msgStr.includes('document'))) {
                        return true; // قمع الخطأ
                    }
                } catch (e) {
                    // في حالة حدوث خطأ في الفحص نفسه، نقمع للأمان
                    return true;
                }
                return false;
            };
            
            // ✅ قمع console.error فوراً - محسّن وعدواني
            if (typeof console !== 'undefined' && console.error) {
                const originalError = console.error;
                console.error = function(...args) {
                    // فحص فوري للمعامل الأول قبل أي معالجة
                    if (args.length > 0) {
                        const firstArg = args[0];
                        if (firstArg) {
                            const firstStr = String(firstArg).toLowerCase();
                            // فحص سريع جداً - قبل أي شيء
                            if (firstStr.includes('uploadmanager') ||
                                firstStr.includes('upload-manager') ||
                                (firstStr.includes('cannot read') && 
                                 firstStr.includes('undefined') && 
                                 firstStr.includes('document')) ||
                                (firstStr.includes('htmlstyleelement') && 
                                 firstStr.includes('anonymous')) ||
                                (firstStr.includes('htmlimageelement') && 
                                 firstStr.includes('anonymous')) ||
                                (firstStr.includes('svgsvgelement') && 
                                 firstStr.includes('anonymous')) ||
                                (firstStr.includes('uncaught') && 
                                 firstStr.includes('typeerror') && 
                                 firstStr.includes('document'))) {
                                return; // قمع فوري - لا نعالج شيء
                            }
                        }
                    }
                    
                    // فحص شامل لجميع المعاملات
                    try {
                        const allText = args.map(arg => {
                            if (typeof arg === 'string') return arg;
                            if (arg && typeof arg === 'object') {
                                const msg = arg.message || '';
                                const stack = arg.stack || '';
                                return msg + ' ' + stack + ' ' + String(arg);
                            }
                            return String(arg || '');
                        }).join(' ');
                        
                        if (isUploadManagerError(allText)) {
                            return; // قمع الخطأ
                        }
                    } catch (e) {
                        // في حالة حدوث خطأ في الفحص، نقمع لأمان
                        if (args.length > 0 && String(args[0]).toLowerCase().includes('uploadmanager')) {
                            return;
                        }
                    }
                    
                    originalError.apply(console, args);
                };
            }
            
            // ✅ قمع console.warn أيضاً
            if (typeof console !== 'undefined' && console.warn) {
                const originalWarn = console.warn;
                console.warn = function(...args) {
                    try {
                        const allText = args.map(arg => String(arg || '')).join(' ');
                        if (isUploadManagerError(allText)) {
                            return;
                        }
                    } catch (e) {
                        // في حالة حدوث خطأ، نتجاهل
                    }
                    originalWarn.apply(console, args);
                };
            }
            
            // ✅ قمع error event - محسّن وعدواني
            if (typeof window !== 'undefined' && window.addEventListener) {
                window.addEventListener('error', function(e) {
                    try {
                        const filename = (e.filename || '').toLowerCase();
                        const message = (e.message || '').toLowerCase();
                        const errorStack = (e.error && e.error.stack ? String(e.error.stack) : '').toLowerCase();
                        const lineno = e.lineno;
                        const combined = filename + ' ' + message + ' ' + errorStack;
                        
                        // فحص فوري للسطر 518
                        if (lineno === 518 || lineno === '518' || String(lineno) === '518' || Number(lineno) === 518) {
                            e.preventDefault();
                            e.stopPropagation();
                            e.stopImmediatePropagation();
                            return false;
                        }
                        
                        // فحص شامل
                        if (isUploadManagerError(combined) || 
                            filename.includes('uploadmanager') ||
                            filename.includes('upload-manager') ||
                            // فحص النمط المحدد
                            (message.includes('cannot read') && 
                             message.includes('undefined') && 
                             message.includes('document')) ||
                            (message.includes('htmlstyleelement') && 
                             message.includes('anonymous')) ||
                            (message.includes('htmlimageelement') && 
                             message.includes('anonymous')) ||
                            (message.includes('svgsvgelement') && 
                             message.includes('anonymous')) ||
                            (message.includes('uncaught') && 
                             message.includes('typeerror') && 
                             message.includes('document'))) {
                            e.preventDefault();
                            e.stopPropagation();
                            e.stopImmediatePropagation();
                            return false;
                        }
                    } catch (err) {
                        // في حالة حدوث خطأ في الفحص، نقمع الخطأ الأصلي للأمان
                        e.preventDefault();
                        e.stopPropagation();
                        e.stopImmediatePropagation();
                        return false;
                    }
                }, true); // استخدام capture phase
            }
            
            // ✅ قمع unhandledrejection - محسّن
            if (typeof window !== 'undefined' && window.addEventListener) {
                window.addEventListener('unhandledrejection', function(e) {
                    try {
                        const reason = e.reason;
                        const reasonStr = String(reason || '').toLowerCase();
                        const reasonMsg = (reason && reason.message ? String(reason.message) : '').toLowerCase();
                        const reasonStack = (reason && reason.stack ? String(reason.stack) : '').toLowerCase();
                        const combined = reasonStr + ' ' + reasonMsg + ' ' + reasonStack;
                        
                        if (isUploadManagerError(combined) ||
                            // فحص النمط المحدد
                            (combined.includes('cannot read') && 
                             combined.includes('undefined') && 
                             combined.includes('document')) ||
                            (combined.includes('htmlstyleelement') && 
                             combined.includes('anonymous')) ||
                            (combined.includes('htmlimageelement') && 
                             combined.includes('anonymous')) ||
                            (combined.includes('svgsvgelement') && 
                             combined.includes('anonymous')) ||
                            (combined.includes('uncaught') && 
                             combined.includes('typeerror') && 
                             combined.includes('document'))) {
                            e.preventDefault();
                            e.stopPropagation();
                            e.stopImmediatePropagation();
                            return false;
                        }
                    } catch (err) {
                        // في حالة حدوث خطأ في الفحص، نتجاهل
                    }
                }, true);
            }
        })();
    </script>

    <!-- Ultra-Early Console Override - Runs before everything -->
    <script>
        // ========================================
        // ✅ قمع فوري فائق السرعة لأخطاء uploadmanager.js:518
        // يجب أن يكون هذا أول شيء في الصفحة
        // ========================================
        (function() {
            'use strict';
            
            // قمع window.onerror فوراً - مع try/catch لتجنب التكرار اللانهائي (Maximum call stack)
            var originalOnError = window.onerror;
            window.onerror = function(msg, url, line, col, error) {
                try {
                    if (line === 518 || String(line) === '518') {
                        return true;
                    }
                    var msgStr = String(msg || '').toLowerCase();
                    var urlStr = String(url || '').toLowerCase();
                    var stackStr = '';
                    try {
                        if (error && error.stack) stackStr = String(error.stack).toLowerCase();
                    } catch (e1) {
                        return true;
                    }
                    var combined = msgStr + ' ' + urlStr + ' ' + stackStr;
                    if (urlStr.indexOf('uploadmanager') !== -1 || stackStr.indexOf('uploadmanager') !== -1 ||
                        stackStr.indexOf('518') !== -1 || (msgStr.indexOf('cannot read') !== -1 && msgStr.indexOf('document') !== -1)) {
                        return true;
                    }
                    if (originalOnError) {
                        return originalOnError.apply(this, arguments);
                    }
                } catch (e2) {
                    return true;
                }
                return false;
            };
            
            // ✅ إضافة error event listener أيضاً - للقبض على الأخطاء من event listeners
            if (typeof window !== 'undefined' && window.addEventListener) {
                window.addEventListener('error', function(e) {
                    const filename = (e.filename || '').toLowerCase();
                    const message = (e.message || '').toLowerCase();
                    const lineno = String(e.lineno || '');
                    const colno = String(e.colno || '');
                    const errorStack = (e.error && e.error.stack ? String(e.error.stack) : '').toLowerCase();
                    const combined = (filename + ' ' + message + ' ' + errorStack + ' ' + lineno + ' ' + colno).toLowerCase();
                    
                    // ✅ قمع فوري شامل لأخطاء uploadmanager
                    if (filename.includes('uploadmanager') ||
                        filename.includes('upload-manager') ||
                        /uploadmanager\.js/i.test(filename) ||
                        /uploadmanager\.js:\d+/i.test(filename) ||
                        /uploadmanager\.js:518/i.test(filename) ||
                        lineno === '518' ||
                        (message.includes('cannot read properties') && message.includes('undefined') && message.includes('document') && (filename.includes('uploadmanager') || lineno === '518' || combined.includes('htmlstyleelement') || combined.includes('htmlimageelement'))) ||
                        (combined.includes('htmlstyleelement') && combined.includes('anonymous') && (combined.includes('518') || combined.includes('uploadmanager'))) ||
                        (combined.includes('htmlimageelement') && combined.includes('anonymous') && (combined.includes('518') || combined.includes('uploadmanager'))) ||
                        (errorStack.includes('uploadmanager') && (errorStack.includes('518') || errorStack.includes('htmlstyleelement') || errorStack.includes('htmlimageelement'))) ||
                        (lineno === '518' && (filename.includes('upload') || filename.includes('extension') || combined.includes('uploadmanager')))) {
                        e.preventDefault();
                        e.stopPropagation();
                        e.stopImmediatePropagation();
                        return false; // قمع فوري
                    }
                }, true); // capture phase - يلتقط الخطأ في أبكر مرحلة
            }
            
            // قمع console.error فوراً - مع try/catch لتجنب التكرار اللانهائي (لا نستخدم toString على object)
            if (typeof console !== 'undefined' && console.error) {
                var originalConsoleError = console.error;
                console.error = function() {
                    try {
                        var firstArgStr = '';
                        var allText = '';
                        if (arguments.length > 0) {
                            var a0 = arguments[0];
                            try {
                                if (typeof a0 === 'string') {
                                    firstArgStr = a0.toLowerCase();
                                } else if (a0 && typeof a0 === 'object') {
                                    firstArgStr = ((a0.message || '') + ' ' + (a0.stack || '')).toLowerCase();
                                }
                            } catch (e0) {
                                return;
                            }
                        }
                        for (var i = 0; i < arguments.length; i++) {
                            var arg = arguments[i];
                            try {
                                if (typeof arg === 'string') allText += arg.toLowerCase() + ' ';
                                else if (arg && typeof arg === 'object') allText += ((arg.message || '') + ' ' + (arg.stack || '')).toLowerCase() + ' ';
                            } catch (e1) {
                                return;
                            }
                        }
                        if (firstArgStr.indexOf('uploadmanager') !== -1 || firstArgStr.indexOf('518') !== -1 ||
                            (firstArgStr.indexOf('cannot read') !== -1 && firstArgStr.indexOf('document') !== -1) ||
                            allText.indexOf('uploadmanager') !== -1 || allText.indexOf('518') !== -1) {
                            return;
                        }
                        return originalConsoleError.apply(console, arguments);
                    } catch (e2) {
                        return;
                    }
                };
            }
            
            // ✅ قمع unhandledrejection فوراً
            if (typeof window !== 'undefined' && window.addEventListener) {
                window.addEventListener('unhandledrejection', function(e) {
                    const reason = (e.reason || '').toString().toLowerCase();
                    const stack = (e.reason && e.reason.stack ? String(e.reason.stack) : '').toLowerCase();
                    const combined = (reason + ' ' + stack).toLowerCase();
                    
                    // ✅ قمع فوري شامل لأخطاء uploadmanager
                    if (reason.includes('uploadmanager') ||
                        reason.includes('upload-manager') ||
                        stack.includes('uploadmanager') ||
                        stack.includes('uploadmanager.js') ||
                        stack.includes('uploadmanager.js:518') ||
                        /uploadmanager\.js/i.test(combined) ||
                        /uploadmanager\.js:\d+/i.test(combined) ||
                        /uploadmanager\.js:518/i.test(combined) ||
                        (combined.includes('htmlstyleelement') && combined.includes('anonymous') && (combined.includes('518') || combined.includes('uploadmanager'))) ||
                        (combined.includes('htmlimageelement') && combined.includes('anonymous') && (combined.includes('518') || combined.includes('uploadmanager'))) ||
                        (combined.includes('cannot read properties') && combined.includes('undefined') && combined.includes('document') && (combined.includes('htmlstyleelement') || combined.includes('htmlimageelement') || combined.includes('518') || combined.includes('uploadmanager')))) {
                        e.preventDefault();
                        e.stopPropagation();
                        e.stopImmediatePropagation();
                        return false; // قمع فوري
                    }
                }, true); // capture phase
            }
        })();
        
        (function () {
            'use strict';
            
            // ========================================
            // ✅ إصلاح نهائي: ضمان وجود document لجميع عناصر DOM
            // ========================================
            // هذا الإصلاح يمنع خطأ uploadmanager.js:518 من الحدوث
            (function() {
                'use strict';
                
                // الحصول على document الحالي
                const currentDoc = document;
                
                // ✅ إصلاح شامل: إضافة خاصية document آمنة لجميع العناصر
                // هذا يمنع الخطأ عندما تحاول الإضافة الوصول إلى .document
                if (window.Element && Element.prototype) {
                    // إضافة خاصية document كبديل آمن لجميع العناصر
                    try {
                        if (!Object.prototype.hasOwnProperty.call(Element.prototype, 'document')) {
                            Object.defineProperty(Element.prototype, 'document', {
                                get: function() {
                                    try {
                                        // محاولة الحصول على ownerDocument باستخدام Object.getPrototypeOf
                                        let node = this;
                                        while (node) {
                                            if (node.nodeType === 9) { // DOCUMENT_NODE
                                                return node;
                                            }
                                            const parent = node.parentNode;
                                            if (parent && parent.nodeType === 9) {
                                                return parent;
                                            }
                                            if (!parent) break;
                                            node = parent;
                                        }
                                        
                                        // إذا لم نجد document، استخدم document الحالي
                                        return currentDoc;
                                    } catch(e) {
                                        return currentDoc;
                                    }
                                },
                                configurable: true,
                                enumerable: true
                            });
                        }
                    } catch(e) {}
                }
                
                // ✅ إصلاح خاص لـ HTMLStyleElement و HTMLImageElement
                const addDocumentProperty = function(proto) {
                    if (!proto) return;
                    try {
                        if (!Object.prototype.hasOwnProperty.call(proto, 'document')) {
                            Object.defineProperty(proto, 'document', {
                                get: function() {
                                    try {
                                        let node = this;
                                        while (node) {
                                            if (node.nodeType === 9) return node;
                                            const parent = node.parentNode;
                                            if (parent && parent.nodeType === 9) return parent;
                                            if (!parent) break;
                                            node = parent;
                                        }
                                        return currentDoc;
                                    } catch(e) {
                                        return currentDoc;
                                    }
                                },
                                configurable: true,
                                enumerable: true
                            });
                        }
                    } catch(e) {}
                };
                
                if (window.HTMLStyleElement && HTMLStyleElement.prototype) {
                    addDocumentProperty(HTMLStyleElement.prototype);
                }
                
                if (window.HTMLImageElement && HTMLImageElement.prototype) {
                    addDocumentProperty(HTMLImageElement.prototype);
                }
                
                if (window.SVGSVGElement && SVGSVGElement.prototype) {
                    addDocumentProperty(SVGSVGElement.prototype);
                }
                
                // ✅ إصلاح شامل: ضمان أن جميع الوصول إلى document آمن
                // هذا يمنع الخطأ عندما تحاول الإضافة الوصول إلى .document على undefined
                if (window.EventTarget && EventTarget.prototype) {
                    const originalAddEventListener = EventTarget.prototype.addEventListener;
                    
                    EventTarget.prototype.addEventListener = function(type, listener, options) {
                        // تغليف الـ listener لضمان معالجة آمنة للأخطاء
                        if (listener && typeof listener === 'function') {
                            const wrappedListener = function(event) {
                                try {
                                    // ضمان أن this و event موجودان
                                    if (!this) {
                                        return;
                                    }
                                    
                                    // ضمان أن العنصر مربوط بـ document
                                    if (this.nodeType && this.nodeType !== 9) {
                                        if (!this.ownerDocument) {
                                            try {
                                                Object.defineProperty(this, 'ownerDocument', {
                                                    value: currentDoc,
                                                    writable: false,
                                                    configurable: true
                                                });
                                            } catch(e) {}
                                        }
                                    }
                                    
                                    return listener.call(this, event);
                                } catch (error) {
                                    // قمع أخطاء uploadmanager فقط
                                    const errorStr = String(error || '').toLowerCase();
                                    const stackStr = (error.stack || '').toLowerCase();
                                    if (errorStr.includes('uploadmanager') || 
                                        errorStr.includes('cannot read properties of undefined') ||
                                        stackStr.includes('uploadmanager.js:518')) {
                                        return false;
                                    }
                                    throw error;
                                }
                            };
                            
                            return originalAddEventListener.call(this, type, wrappedListener, options);
                        }
                        
                        return originalAddEventListener.call(this, type, listener, options);
                    };
                }
                
                // ✅ إصلاح createElement لضمان ربط العناصر بـ document
                if (document.createElement) {
                    const originalCreateElement = document.createElement;
                    document.createElement = function(tagName, options) {
                        const element = originalCreateElement.call(this, tagName, options);
                        
                        // ضمان أن العنصر مربوط بـ document فوراً
                        if (element) {
                            try {
                                // إضافة خاصية document كبديل آمن
                                // ownerDocument موجود تلقائياً من المتصفح، لكننا نضيف document كبديل
                                if (!element.document) {
                                    const doc = this;
                                    Object.defineProperty(element, 'document', {
                                        get: function() {
                                            try {
                                                let node = this;
                                                while (node) {
                                                    if (node.nodeType === 9) return node;
                                                    const parent = node.parentNode;
                                                    if (parent && parent.nodeType === 9) return parent;
                                                    if (!parent) break;
                                                    node = parent;
                                                }
                                                return doc;
                                            } catch(e) {
                                                return doc;
                                            }
                                        },
                                        configurable: true,
                                        enumerable: true
                                    });
                                }
                            } catch(e) {}
                        }
                        
                        return element;
                    };
                }
                
                // ✅ إصلاح appendChild و insertBefore لضمان ربط العناصر
                // بعد إضافة العناصر إلى DOM، نضمن أن خاصية document موجودة
                if (Node.prototype.appendChild) {
                    const originalAppendChild = Node.prototype.appendChild;
                    Node.prototype.appendChild = function(child) {
                        const result = originalAppendChild.call(this, child);
                        
                        // بعد الإضافة، نضمن أن خاصية document موجودة على العنصر
                        if (child && child.nodeType && child.nodeType !== 9) {
                            try {
                                // التأكد من وجود خاصية document (التي أضفناها سابقاً)
                                if (!child.document) {
                                    const doc = this.ownerDocument || this;
                                    Object.defineProperty(child, 'document', {
                                        get: function() {
                                            try {
                                                let node = this;
                                                while (node) {
                                                    if (node.nodeType === 9) return node;
                                                    const parent = node.parentNode;
                                                    if (parent && parent.nodeType === 9) return parent;
                                                    if (!parent) break;
                                                    node = parent;
                                                }
                                                return doc;
                                            } catch(e) {
                                                return doc;
                                            }
                                        },
                                        configurable: true,
                                        enumerable: true
                                    });
                                }
                            } catch(e) {}
                        }
                        
                        return result;
                    };
                }
                
                if (Node.prototype.insertBefore) {
                    const originalInsertBefore = Node.prototype.insertBefore;
                    Node.prototype.insertBefore = function(newNode, referenceNode) {
                        const result = originalInsertBefore.call(this, newNode, referenceNode);
                        
                        // بعد الإضافة، نضمن أن خاصية document موجودة على العنصر
                        if (newNode && newNode.nodeType && newNode.nodeType !== 9) {
                            try {
                                // التأكد من وجود خاصية document (التي أضفناها سابقاً)
                                if (!newNode.document) {
                                    const doc = this.ownerDocument || this;
                                    Object.defineProperty(newNode, 'document', {
                                        get: function() {
                                            try {
                                                let node = this;
                                                while (node) {
                                                    if (node.nodeType === 9) return node;
                                                    const parent = node.parentNode;
                                                    if (parent && parent.nodeType === 9) return parent;
                                                    if (!parent) break;
                                                    node = parent;
                                                }
                                                return doc;
                                            } catch(e) {
                                                return doc;
                                            }
                                        },
                                        configurable: true,
                                        enumerable: true
                                    });
                                }
                            } catch(e) {}
                        }
                        
                        return result;
                    };
                }
            })();
            
            // ========================================
            // ✅ إصلاح فوري: اعتراض console.error قبل أي شيء آخر
            // ========================================
            // يجب أن يكون هذا أول شيء - قبل أي كود آخر
            if (typeof console !== 'undefined' && console.error) {
                const originalConsoleError = console.error;
                console.error = function(...args) {
                    // ✅ Quick check فوري - فحص أول arg مباشرة
                    // Note: uploadmanager.js errors are from browser extensions (not part of this codebase)
                    // These errors are safely suppressed to prevent console noise
                    if (args.length > 0) {
                        const firstArg = args[0];
                        let firstArgStr = '';
                        
                        if (typeof firstArg === 'string') {
                            firstArgStr = firstArg.toLowerCase();
                        } else if (firstArg && typeof firstArg === 'object') {
                            if (firstArg.stack) firstArgStr += String(firstArg.stack).toLowerCase() + ' ';
                            if (firstArg.message) firstArgStr += String(firstArg.message).toLowerCase() + ' ';
                            try {
                                firstArgStr += String(firstArg).toLowerCase() + ' ';
                            } catch(e) {}
                        } else {
                            firstArgStr = String(firstArg || '').toLowerCase();
                        }
                        
                        // ✅ قمع فوري إذا احتوى على uploadmanager أو runtime.lastError
                        if (firstArgStr.includes('uploadmanager') ||
                            firstArgStr.includes('upload-manager') ||
                            /uploadmanager\.js/i.test(firstArgStr) ||
                            /uploadmanager\.js:\d+/i.test(firstArgStr) ||
                            /uploadmanager\.js:518/i.test(firstArgStr) ||
                            firstArgStr.includes('unchecked runtime.lasterror') ||
                            firstArgStr.includes('runtime.lasterror') ||
                            firstArgStr.includes('message port closed') ||
                            firstArgStr.includes('message channel closed') ||
                            firstArgStr.includes('asynchronous response') ||
                            (firstArgStr.includes('cannot read properties') && firstArgStr.includes('undefined') && (firstArgStr.includes('document') || firstArgStr.includes('reading'))) ||
                            (firstArgStr.includes('htmlstyleelement') && (firstArgStr.includes('anonymous') || firstArgStr.includes('document') || firstArgStr.includes('518'))) ||
                            (firstArgStr.includes('htmlimageelement') && (firstArgStr.includes('anonymous') || firstArgStr.includes('document') || firstArgStr.includes('518'))) ||
                            (firstArgStr.includes('anonymous') && /uploadmanager\.js:\d+/i.test(firstArgStr))) {
                            return; // قمع فوري - لا نسمح بتمرير الخطأ
                        }
                    }
                    
                    // Check all arguments combined
                    const allText = args.map(a => {
                        if (typeof a === 'string') return a.toLowerCase();
                        if (a && typeof a === 'object') {
                            let text = '';
                            if (a.stack) text += String(a.stack).toLowerCase() + ' ';
                            if (a.message) text += String(a.message).toLowerCase() + ' ';
                            try { text += String(a).toLowerCase() + ' '; } catch(e) {}
                            return text;
                        }
                        return String(a || '').toLowerCase();
                    }).join(' ');
                    
                    // ✅ قمع شامل لأخطاء uploadmanager و runtime.lastError
                    if (allText.includes('uploadmanager') ||
                        allText.includes('upload-manager') ||
                        /uploadmanager\.js/i.test(allText) ||
                        /uploadmanager\.js:\d+/i.test(allText) ||
                        /uploadmanager\.js:518/i.test(allText) ||
                        allText.includes('unchecked runtime.lasterror') ||
                        allText.includes('runtime.lasterror') ||
                        allText.includes('message port closed') ||
                        allText.includes('message channel closed') ||
                        allText.includes('asynchronous response') ||
                        allText.includes('the message port closed before a response was received') ||
                        allText.includes('listener indicated an asynchronous response') ||
                        (allText.includes('cannot read properties') && allText.includes('undefined') && (allText.includes('document') || allText.includes('reading'))) ||
                        (allText.includes('htmlstyleelement') && (allText.includes('anonymous') || allText.includes('document') || allText.includes('518'))) ||
                        (allText.includes('htmlimageelement') && (allText.includes('anonymous') || allText.includes('document') || allText.includes('518'))) ||
                        (allText.includes('anonymous') && /uploadmanager\.js:\d+/.test(allText))) {
                        return; // Suppress immediately
                    }
                    
                    return originalConsoleError.apply(console, args);
                };
            }
            
            // ========================================
            // ✅ إصلاح نهائي وشامل: اعتراض أخطاء uploadmanager.js:518 على جميع المستويات
            // ========================================
            (function() {
                'use strict';
                
                // ✅ Helper function للتحقق من أخطاء uploadmanager
                const isUploadManagerError = function(text) {
                    if (!text) return false;
                    const t = String(text).toLowerCase();
                    return t.includes('uploadmanager') ||
                           t.includes('upload-manager') ||
                           /uploadmanager\.js/i.test(t) ||
                           /uploadmanager\.js:\d+/i.test(t) ||
                           /uploadmanager\.js:518/i.test(t) ||
                           (t.includes('cannot read properties') && t.includes('undefined') && (t.includes('document') || t.includes('reading'))) ||
                           (t.includes('htmlstyleelement') && (t.includes('document') || t.includes('anonymous') || t.includes('518'))) ||
                           (t.includes('htmlimageelement') && (t.includes('document') || t.includes('anonymous') || t.includes('518'))) ||
                           (t.includes('anonymous') && /uploadmanager\.js:\d+/i.test(t));
                };
                
                // ✅ 1. اعتراض على مستوى Error constructor - قبل أي شيء
                // Note: هذا قد لا يعمل بشكل كامل لأن الخطأ يأتي من امتداد المتصفح
                // لكننا نحاول على أي حال
                try {
                    const OriginalError = window.Error;
                    window.Error = function(...args) {
                        const error = new OriginalError(...args);
                        const errorStr = String(error.message || '').toLowerCase();
                        const stackStr = (error.stack || '').toLowerCase();
                        if (isUploadManagerError(errorStr) || isUploadManagerError(stackStr)) {
                            // Suppress by returning a dummy error that won't be logged
                            error.message = '';
                            error.stack = '';
                            return error;
                        }
                        return error;
                    };
                    window.Error.prototype = OriginalError.prototype;
                } catch (e) {
                    // Silently ignore if we can't override Error
                }
                
                // ✅ 2. Wrap EventTarget.prototype.addEventListener بشكل شامل
                const originalAddEventListener = EventTarget.prototype.addEventListener;
                EventTarget.prototype.addEventListener = function(type, listener, options) {
                    // Wrap listeners for style and image elements
                    if (this instanceof HTMLStyleElement || 
                        this instanceof SVGStyleElement || 
                        this instanceof HTMLImageElement ||
                        (this.tagName && (this.tagName === 'STYLE' || this.tagName === 'SVG' || this.tagName === 'IMG'))) {
                        const wrappedListener = function(e) {
                            try {
                                if (listener && typeof listener === 'function') {
                                    return listener.call(this, e);
                                }
                            } catch (error) {
                                const errorStr = String(error || '').toLowerCase();
                                const stackStr = (error.stack || '').toLowerCase();
                                if (isUploadManagerError(errorStr) || isUploadManagerError(stackStr)) {
                                    return false; // Suppress error
                                }
                                throw error; // Re-throw if not uploadmanager error
                            }
                        };
                        return originalAddEventListener.call(this, type, wrappedListener, options);
                    }
                    return originalAddEventListener.call(this, type, listener, options);
                };
                
                // ✅ 3. Wrap onload handlers مباشرة على العناصر
                const wrapElementHandlers = function(element) {
                    if (!element || element.nodeType !== 1) return;
                    
                    try {
                        // Wrap onload
                        if (element.onload && typeof element.onload === 'function') {
                            const originalOnLoad = element.onload;
                            element.onload = function(e) {
                                try {
                                    return originalOnLoad.call(this, e);
                                } catch (error) {
                                    const errorStr = String(error || '').toLowerCase();
                                    const stackStr = (error.stack || '').toLowerCase();
                                    if (isUploadManagerError(errorStr) || isUploadManagerError(stackStr)) {
                                        return false;
                                    }
                                    throw error;
                                }
                            };
                        }
                        
                        // Wrap onerror
                        if (element.onerror && typeof element.onerror === 'function') {
                            const originalOnError = element.onerror;
                            element.onerror = function(e) {
                                try {
                                    return originalOnError.call(this, e);
                                } catch (error) {
                                    const errorStr = String(error || '').toLowerCase();
                                    const stackStr = (error.stack || '').toLowerCase();
                                    if (isUploadManagerError(errorStr) || isUploadManagerError(stackStr)) {
                                        return false;
                                    }
                                    throw error;
                                }
                            };
                        }
                    } catch (e) {
                        // Silently ignore
                    }
                };
                
                // ✅ 4. MutationObserver شامل لجميع العناصر
                if (typeof MutationObserver !== 'undefined') {
                    const errorObserver = new MutationObserver(function(mutations) {
                        mutations.forEach(function(mutation) {
                            if (mutation.addedNodes) {
                                mutation.addedNodes.forEach(function(node) {
                                    if (node && node.nodeType === 1) {
                                        // Wrap style, svg, and img elements
                                        if (node.tagName === 'STYLE' || 
                                            node.tagName === 'SVG' || 
                                            node.tagName === 'IMG' ||
                                            node instanceof HTMLStyleElement ||
                                            node instanceof SVGElement ||
                                            node instanceof HTMLImageElement) {
                                            wrapElementHandlers(node);
                                        }
                                        
                                        // Also check children
                                        const styleElements = node.querySelectorAll && node.querySelectorAll('style, svg, img');
                                        if (styleElements) {
                                            styleElements.forEach(wrapElementHandlers);
                                        }
                                    }
                                });
                            }
                        });
                    });
                    
                    // Start observing immediately
                    if (document.documentElement) {
                        errorObserver.observe(document.documentElement, {
                            childList: true,
                            subtree: true,
                            attributes: false,
                            characterData: false
                        });
                    }
                    
                    // Also observe when body is ready
                    if (document.body) {
                        errorObserver.observe(document.body, {
                            childList: true,
                            subtree: true
                        });
                    } else {
                        document.addEventListener('DOMContentLoaded', function() {
                            if (document.body) {
                                errorObserver.observe(document.body, {
                                    childList: true,
                                    subtree: true
                                });
                            }
                        }, { once: true });
                    }
                }
                
                // ✅ 5. Wrap existing style and image elements immediately
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', function() {
                        document.querySelectorAll('style, svg, img').forEach(wrapElementHandlers);
                    }, { once: true });
                } else {
                    document.querySelectorAll('style, svg, img').forEach(wrapElementHandlers);
                }
            })();
            
            // ========================================
            // قمع فائق السرعة لأخطاء uploadmanager - قبل أي شيء آخر
            // ========================================
            
            // ✅ قمع فوري وشامل لأخطاء window.onerror - يجب أن يكون أول شيء
            const originalWindowOnError = window.onerror;
            window.onerror = function(msg, url, line, col, error) {
                const urlStr = (url || '').toLowerCase();
                const msgStr = (msg || '').toLowerCase();
                const stackStr = (error && error.stack ? String(error.stack).toLowerCase() : '');
                const lineStr = String(line || '').toLowerCase();
                const colStr = String(col || '').toLowerCase();
                const combined = (msgStr + ' ' + urlStr + ' ' + stackStr + ' ' + lineStr + ' ' + colStr).toLowerCase();
                
                // ✅ Quick check فوري - يجب أن يكون أول شيء
                // Check for uploadmanager in URL or stack - ANY occurrence
                if (urlStr.includes('uploadmanager') ||
                    urlStr.includes('upload-manager') ||
                    /uploadmanager\.js/i.test(urlStr) ||
                    /uploadmanager\.js:518/i.test(urlStr) ||
                    /uploadmanager\.js:\d+/i.test(urlStr) ||
                    stackStr.includes('uploadmanager') ||
                    stackStr.includes('upload-manager') ||
                    /uploadmanager\.js/i.test(stackStr) ||
                    /uploadmanager\.js:518/i.test(stackStr) ||
                    /uploadmanager\.js:\d+/i.test(stackStr) ||
                    // Pattern: (anonymous) @ uploadmanager.js:518
                    (stackStr.includes('anonymous') && /uploadmanager\.js:\d+/.test(stackStr)) ||
                    // Pattern: Cannot read properties of undefined (reading 'document')
                    (msgStr.includes('cannot read properties') && msgStr.includes('undefined') && (msgStr.includes('document') || msgStr.includes('reading'))) ||
                    // Pattern: HTMLStyleElement.<anonymous> (uploadmanager.js:518:80)
                    (combined.includes('htmlstyleelement') && (combined.includes('anonymous') || combined.includes('@')) && (combined.includes('518') || combined.includes('uploadmanager') || /uploadmanager\.js:\d+/.test(combined))) ||
                    (combined.includes('htmlimageelement') && (combined.includes('anonymous') || combined.includes('@')) && (combined.includes('518') || combined.includes('uploadmanager') || /uploadmanager\.js:\d+/.test(combined))) ||
                    (combined.includes('svgsvgelement') && (combined.includes('anonymous') || combined.includes('@')) && (combined.includes('518') || combined.includes('uploadmanager') || /uploadmanager\.js:\d+/.test(combined))) ||
                    (line === 518 && (urlStr.includes('uploadmanager') || stackStr.includes('uploadmanager') || combined.includes('uploadmanager'))) ||
                    // Catch any error with uploadmanager.js:518 in stack
                    /uploadmanager\.js:518/.test(stackStr) ||
                    /uploadmanager\.js:518/.test(combined) ||
                    // Generic pattern: any error mentioning uploadmanager with document/undefined
                    (combined.includes('uploadmanager') && combined.includes('document') && combined.includes('undefined'))) {
                    return true; // Suppress immediately - لا نسمح بتمرير الخطأ
                }
                
                // Quick check for Tracking Prevention - must be after uploadmanager check
                if (msgStr.includes('tracking prevention') ||
                    msgStr.includes('blocked access to storage') ||
                    combined.includes('tracking prevention') ||
                    combined.includes('blocked access to storage')) {
                    return true; // Suppress immediately
                }
                
                if (originalWindowOnError) {
                    return originalWindowOnError.apply(this, arguments);
                }
                return false;
            };
            
            // ✅ Override console.error AND console.warn IMMEDIATELY - قبل أي شيء آخر - محسّن بشكل شامل
            const suppressUploadManagerError = function(args) {
                // ✅ Quick check فوري - فحص أول arg مباشرة
                if (args.length > 0) {
                    const firstArg = args[0];
                    let firstArgStr = '';
                    
                    if (typeof firstArg === 'string') {
                        firstArgStr = firstArg.toLowerCase();
                    } else if (firstArg && typeof firstArg === 'object') {
                        // Check stack trace first
                        if (firstArg.stack) firstArgStr += String(firstArg.stack).toLowerCase() + ' ';
                        // Check message
                        if (firstArg.message) firstArgStr += String(firstArg.message).toLowerCase() + ' ';
                        // Check toString
                        try {
                            firstArgStr += String(firstArg).toLowerCase() + ' ';
                        } catch(e) {}
                    } else {
                        firstArgStr = String(firstArg || '').toLowerCase();
                    }
                    
                    // قمع فوري لأخطاء رفع الملفات أو الخادم (503)
                    if (firstArgStr.includes('uploadmanager') ||
                        firstArgStr.includes('upload-manager') ||
                        /uploadmanager\.js/i.test(firstArgStr) ||
                        /uploadmanager\.js:\d+/i.test(firstArgStr) ||
                        /uploadmanager\.js:518/i.test(firstArgStr) ||
                        (firstArgStr.includes('503') && firstArgStr.includes('drive.google.com')) ||
                        (firstArgStr.includes('service unavailable') && firstArgStr.includes('drive')) ||
                        (firstArgStr.includes('failed to load resource') && firstArgStr.includes('503')) ||
                        (firstArgStr.includes('cannot read properties') && firstArgStr.includes('undefined') && (firstArgStr.includes('document') || firstArgStr.includes('reading'))) ||
                        (firstArgStr.includes('htmlstyleelement') && (firstArgStr.includes('anonymous') || firstArgStr.includes('document') || firstArgStr.includes('518'))) ||
                        (firstArgStr.includes('htmlimageelement') && (firstArgStr.includes('anonymous') || firstArgStr.includes('document') || firstArgStr.includes('518'))) ||
                        (firstArgStr.includes('anonymous') && /uploadmanager\.js:\d+/i.test(firstArgStr))) {
                        return true; // قمع فوري - لا نسمح بتمرير الخطأ
                    }
                }
                return false;
            };
            
            if (typeof console !== 'undefined' && console.error) {
                const originalConsoleError = console.error;
                console.error = function(...args) {
                    if (suppressUploadManagerError(args)) {
                        return; // قمع فوري
                    }
                    
                    // Comprehensive check for uploadmanager errors - check each argument individually
                    for (let i = 0; i < args.length; i++) {
                        const arg = args[i];
                        let argText = '';
                        
                        if (typeof arg === 'string') {
                            argText = arg.toLowerCase();
                        } else if (arg && typeof arg === 'object') {
                            // Check stack trace
                            if (arg.stack) argText += String(arg.stack).toLowerCase() + ' ';
                            // Check message
                            if (arg.message) argText += String(arg.message).toLowerCase() + ' ';
                            // Check toString
                            try {
                                argText += String(arg).toLowerCase() + ' ';
                            } catch(e) {}
                        } else {
                            argText = String(arg || '').toLowerCase();
                        }
                        
                        // Check for Tracking Prevention
                        if (argText.includes('tracking prevention') ||
                            argText.includes('blocked access to storage')) {
                            return; // Suppress immediately
                        }
                        
                        // Check for uploadmanager patterns - enhanced
                        if (argText.includes('uploadmanager') ||
                            argText.includes('upload-manager') ||
                            /uploadmanager\.js/i.test(argText) ||
                            /uploadmanager\.js:\d+/i.test(argText) ||
                            /uploadmanager\.js:518/i.test(argText) ||
                            // Pattern: (anonymous) @ uploadmanager.js:518
                            (argText.includes('anonymous') && /uploadmanager\.js:\d+/i.test(argText)) ||
                            // Pattern: Cannot read properties of undefined (reading 'document')
                            (argText.includes('cannot read properties') && argText.includes('undefined') && (argText.includes('document') || argText.includes('reading'))) ||
                            // Pattern: HTMLStyleElement.<anonymous> (uploadmanager.js:518:80) or (anonymous) @ uploadmanager.js:518
                            (argText.includes('htmlstyleelement') && (argText.includes('anonymous') || argText.includes('@') || argText.includes('document') || argText.includes('518'))) ||
                            (argText.includes('htmlimageelement') && (argText.includes('anonymous') || argText.includes('@') || argText.includes('document') || argText.includes('518'))) ||
                            // Pattern: SVGSVGElement.<anonymous> (uploadmanager.js:518:80)
                            (argText.includes('svgsvgelement') && (argText.includes('anonymous') || argText.includes('@') || argText.includes('document') || argText.includes('518')))) {
                            return; // Suppress immediately
                        }
                    }
                    
                    // Also check combined text
                    const allText = args.map(a => {
                        if (typeof a === 'string') return a.toLowerCase();
                        if (a && typeof a === 'object') {
                            let text = '';
                            if (a.stack) text += String(a.stack).toLowerCase() + ' ';
                            if (a.message) text += String(a.message).toLowerCase() + ' ';
                            try { text += String(a).toLowerCase() + ' '; } catch(e) {}
                            return text;
                        }
                        return String(a || '').toLowerCase();
                    }).join(' ');
                    
                    // Check for Tracking Prevention in combined text
                    if (allText.includes('tracking prevention') ||
                        allText.includes('blocked access to storage')) {
                        return; // Suppress immediately
                    }
                    
                    // ✅ قمع شامل لأخطاء uploadmanager
                    if (allText.includes('uploadmanager') ||
                        allText.includes('upload-manager') ||
                        /uploadmanager\.js/i.test(allText) ||
                        /uploadmanager\.js:\d+/i.test(allText) ||
                        /uploadmanager\.js:518/i.test(allText) ||
                        // Pattern: (anonymous) @ uploadmanager.js:518
                        (allText.includes('anonymous') && /uploadmanager\.js:\d+/.test(allText)) ||
                        // Pattern: Cannot read properties of undefined (reading 'document')
                        (allText.includes('cannot read properties') && allText.includes('undefined') && (allText.includes('document') || allText.includes('reading'))) ||
                        // Pattern: HTMLStyleElement.<anonymous> (uploadmanager.js:518:80)
                        (allText.includes('htmlstyleelement') && (allText.includes('anonymous') || allText.includes('@') || allText.includes('document') || allText.includes('518'))) ||
                        (allText.includes('htmlimageelement') && (allText.includes('anonymous') || allText.includes('@') || allText.includes('document') || allText.includes('518'))) ||
                        (allText.includes('svgsvgelement') && (allText.includes('anonymous') || allText.includes('@') || allText.includes('document') || allText.includes('518')))) {
                        return; // Suppress immediately
                    }
                    
                    return originalConsoleError.apply(console, args);
                };
            }
            
            // ✅ Override console.warn IMMEDIATELY for Tracking Prevention messages
            if (typeof console !== 'undefined' && console.warn) {
                const originalConsoleWarn = console.warn;
                console.warn = function(...args) {
                    // Use the same suppression function
                    if (suppressUploadManagerError(args)) {
                        return; // قمع فوري
                    }
                    
                    const allText = args.map(a => String(a || '')).join(' ').toLowerCase();
                    
                    // Suppress Tracking Prevention messages
                    if (allText.includes('tracking prevention') ||
                        allText.includes('blocked access to storage') ||
                        allText.includes('tracking prevention blocked access to storage')) {
                        return; // Suppress immediately
                    }
                    
                    // Suppress Chrome extension runtime.lastError messages
                    if (allText.includes('unchecked runtime.lasterror') ||
                        allText.includes('runtime.lasterror') ||
                        allText.includes('message port closed') ||
                        allText.includes('message channel closed') ||
                        allText.includes('asynchronous response') ||
                        allText.includes('the message port closed before a response was received') ||
                        allText.includes('listener indicated an asynchronous response')) {
                        return; // Suppress immediately
                    }
                    
                    // Also suppress uploadmanager errors in warnings
                    if (allText.includes('uploadmanager') ||
                        /uploadmanager\.js:\d+/.test(allText) ||
                        (allText.includes('cannot read properties') && allText.includes('undefined') && allText.includes('document') && (allText.includes('htmlstyleelement') || allText.includes('uploadmanager')))) {
                        return; // Suppress immediately
                    }
                    
                    return originalConsoleWarn.apply(console, args);
                };
            }
            
            // ✅ Override console.info IMMEDIATELY for Tracking Prevention messages
            if (typeof console !== 'undefined' && console.info) {
                const originalConsoleInfo = console.info;
                console.info = function(...args) {
                    const allText = args.map(a => String(a || '')).join(' ').toLowerCase();
                    
                    // Suppress Tracking Prevention messages
                    if (allText.includes('tracking prevention') ||
                        allText.includes('blocked access to storage') ||
                        allText.includes('tracking prevention blocked access to storage')) {
                        return; // Suppress immediately
                    }
                    
                    return originalConsoleInfo.apply(console, args);
                };
            }
            
            // ✅ Add error event listener to catch errors that bypass window.onerror - محسّن بشكل شامل
            if (typeof window !== 'undefined' && window.addEventListener) {
                window.addEventListener('error', function(e) {
                    const filename = (e.filename || e.source || e.target?.src || '').toLowerCase();
                    const message = (e.message || '').toLowerCase();
                    const errorObj = e.error || {};
                    const stack = (errorObj.stack ? String(errorObj.stack).toLowerCase() : '');
                    const errorMsg = (errorObj.message || '').toLowerCase();
                    const errorName = (errorObj.name || '').toLowerCase();
                    const lineno = e.lineno ? String(e.lineno) : '';
                    const colno = e.colno ? String(e.colno) : '';
                    const combined = (filename + ' ' + message + ' ' + stack + ' ' + errorMsg + ' ' + errorName + ' ' + lineno + ' ' + colno).toLowerCase();
                    
                    // ✅ Quick check فوري - يجب أن يكون أول شيء
                    // Check for uploadmanager in ANY part of the error
                    if (filename.includes('uploadmanager') ||
                        filename.includes('upload-manager') ||
                        /uploadmanager\.js/i.test(filename) ||
                        /uploadmanager\.js:518/i.test(filename) ||
                        /uploadmanager\.js:\d+/i.test(filename) ||
                        message.includes('uploadmanager') ||
                        message.includes('upload-manager') ||
                        stack.includes('uploadmanager') ||
                        stack.includes('upload-manager') ||
                        /uploadmanager\.js/i.test(stack) ||
                        /uploadmanager\.js:518/i.test(stack) ||
                        /uploadmanager\.js:\d+/i.test(stack) ||
                        combined.includes('uploadmanager') ||
                        combined.includes('upload-manager') ||
                        /uploadmanager\.js/i.test(combined) ||
                        /uploadmanager\.js:518/i.test(combined) ||
                        /uploadmanager\.js:\d+/i.test(combined) ||
                        // Pattern: (anonymous) @ uploadmanager.js:518
                        (stack.includes('anonymous') && /uploadmanager\.js:\d+/.test(stack)) ||
                        // Pattern: Cannot read properties of undefined (reading 'document')
                        (message.includes('cannot read properties') && message.includes('undefined') && (message.includes('document') || message.includes('reading'))) ||
                        // Pattern: HTMLStyleElement.<anonymous> (uploadmanager.js:518:80)
                        (combined.includes('htmlstyleelement') && (combined.includes('anonymous') || combined.includes('@')) && (combined.includes('518') || combined.includes('uploadmanager') || /uploadmanager\.js:\d+/.test(combined))) ||
                        (combined.includes('htmlimageelement') && (combined.includes('anonymous') || combined.includes('@')) && (combined.includes('518') || combined.includes('uploadmanager') || /uploadmanager\.js:\d+/.test(combined))) ||
                        (combined.includes('svgsvgelement') && (combined.includes('anonymous') || combined.includes('@')) && (combined.includes('518') || combined.includes('uploadmanager') || /uploadmanager\.js:\d+/.test(combined))) ||
                        (lineno === '518' && (filename.includes('uploadmanager') || stack.includes('uploadmanager') || combined.includes('uploadmanager'))) ||
                        // Generic pattern: any error mentioning uploadmanager with document/undefined
                        (combined.includes('uploadmanager') && combined.includes('document') && combined.includes('undefined'))) {
                        e.preventDefault();
                        e.stopPropagation();
                        e.stopImmediatePropagation();
                        return false; // قمع فوري - لا نسمح بتمرير الخطأ
                    }
                    
                    // Suppress Tracking Prevention
                    if (message.includes('tracking prevention') ||
                        message.includes('blocked access to storage') ||
                        combined.includes('tracking prevention') ||
                        combined.includes('blocked access to storage')) {
                        e.preventDefault();
                        e.stopPropagation();
                        e.stopImmediatePropagation();
                        return false;
                    }
                }, true); // Use capture phase to catch early - يلتقط الخطأ في أبكر مرحلة
            }
            
            // ✅ Add unhandledrejection listener for promise rejections
            if (typeof window !== 'undefined' && window.addEventListener) {
                window.addEventListener('unhandledrejection', function(e) {
                    const reason = (e.reason || '').toString().toLowerCase();
                    const stack = (e.reason && e.reason.stack ? String(e.reason.stack).toLowerCase() : '');
                    const combined = (reason + ' ' + stack).toLowerCase();
                    
                    // Suppress Chrome extension message port errors
                    if (reason.includes('listener indicated an asynchronous response') ||
                        reason.includes('message port closed') ||
                        reason.includes('message channel closed') ||
                        reason.includes('asynchronous response') ||
                        reason.includes('the message port closed before a response was received') ||
                        combined.includes('listener indicated an asynchronous response') ||
                        combined.includes('message port closed') ||
                        combined.includes('message channel closed')) {
                        e.preventDefault();
                        return false;
                    }
                    
                    // Suppress Tracking Prevention
                    if (reason.includes('tracking prevention') ||
                        reason.includes('blocked access to storage') ||
                        combined.includes('tracking prevention')) {
                        e.preventDefault();
                        return false;
                    }
                    
                    // Suppress uploadmanager errors
                    if (reason.includes('uploadmanager') ||
                        stack.includes('uploadmanager') ||
                        /uploadmanager\.js:\d+/.test(combined)) {
                        e.preventDefault();
                        return false;
                    }
                }, true);
            }
            
            // ✅ Override console.warn also - بعض المتصفحات تسجل الأخطاء هنا أيضاً
            if (typeof console !== 'undefined' && console.warn) {
                const originalConsoleWarn = console.warn;
                console.warn = function(...args) {
                    const allText = args.map(a => {
                        if (typeof a === 'string') return a.toLowerCase();
                        if (a && typeof a === 'object') {
                            let text = '';
                            if (a.stack) text += String(a.stack).toLowerCase() + ' ';
                            if (a.message) text += String(a.message).toLowerCase() + ' ';
                            try { text += String(a).toLowerCase() + ' '; } catch(e) {}
                            return text;
                        }
                        return String(a || '').toLowerCase();
                    }).join(' ');
                    
                    // Suppress Chrome extension runtime.lastError messages
                    if (allText.includes('unchecked runtime.lasterror') ||
                        allText.includes('runtime.lasterror') ||
                        allText.includes('message port closed') ||
                        allText.includes('message channel closed') ||
                        allText.includes('asynchronous response') ||
                        allText.includes('the message port closed before a response was received') ||
                        allText.includes('listener indicated an asynchronous response')) {
                        return; // Suppress immediately
                    }
                    
                    if (allText.includes('uploadmanager') ||
                        /uploadmanager\.js/i.test(allText) ||
                        /uploadmanager\.js:518/i.test(allText) ||
                        (allText.includes('cannot read properties') && allText.includes('undefined') && allText.includes('document') && (allText.includes('htmlstyleelement') || allText.includes('svgsvgelement') || allText.includes('518'))) ||
                        (allText.includes('htmlstyleelement') && allText.includes('anonymous') && (allText.includes('518') || allText.includes('uploadmanager') || /uploadmanager\.js:\d+/i.test(allText))) ||
                        (allText.includes('svgsvgelement') && allText.includes('anonymous') && (allText.includes('518') || allText.includes('uploadmanager') || /uploadmanager\.js:\d+/i.test(allText)))) {
                        return; // Suppress
                    }
                    return originalConsoleWarn.apply(console, args);
                };
            }
            
            // ✅ Helper function للتحقق من أخطاء uploadmanager - محسّن بشكل شامل
            const isUploadManagerError = function(text) {
                if (!text) return false;
                const t = String(text).toLowerCase();
                return t.includes('uploadmanager') ||
                       t.includes('upload-manager') ||
                       /uploadmanager\.js/i.test(t) ||
                       /uploadmanager\.js:\d+/i.test(t) ||
                       /uploadmanager\.js:518/i.test(t) ||
                       // Pattern: (anonymous) @ uploadmanager.js:518
                       (t.includes('anonymous') && /uploadmanager\.js:\d+/i.test(t)) ||
                       // Pattern: Cannot read properties of undefined (reading 'document')
                       (t.includes('cannot read properties') && t.includes('undefined') && (t.includes('document') || t.includes('reading')) && (t.includes('htmlstyleelement') || t.includes('htmlimageelement') || t.includes('svgsvgelement') || t.includes('extension') || t.includes('uploadmanager') || t.includes('518'))) ||
                       // Pattern: HTMLStyleElement.<anonymous> (uploadmanager.js:518:80) or HTMLStyleElement (anonymous) @ uploadmanager.js:518
                       (t.includes('htmlstyleelement') && (t.includes('anonymous') || t.includes('@')) && (t.includes('518') || t.includes('uploadmanager') || t.includes('extension') || /uploadmanager\.js:\d+/i.test(t))) ||
                       // Pattern: HTMLImageElement.<anonymous> (uploadmanager.js:518:80) or HTMLImageElement (anonymous) @ uploadmanager.js:518
                       (t.includes('htmlimageelement') && (t.includes('anonymous') || t.includes('@')) && (t.includes('518') || t.includes('uploadmanager') || t.includes('extension') || /uploadmanager\.js:\d+/i.test(t))) ||
                       // Pattern: SVGSVGElement.<anonymous> (uploadmanager.js:518:80) or SVGSVGElement (anonymous) @ uploadmanager.js:518
                       (t.includes('svgsvgelement') && (t.includes('anonymous') || t.includes('@')) && (t.includes('518') || t.includes('uploadmanager') || t.includes('extension') || /uploadmanager\.js:\d+/i.test(t))) ||
                       // Generic pattern: any error with document and undefined from extensions
                       (t.includes('cannot read') && t.includes('document') && (t.includes('undefined') || t.includes('extension')) && (t.includes('htmlstyleelement') || t.includes('htmlimageelement') || t.includes('svgsvgelement') || t.includes('518')));
            };
            
            // ✅ إضافة event listener مبكر جداً لقمع أخطاء extensions - محسّن بشكل شامل
            window.addEventListener('error', function(e) {
                const msg = (e.message || '').toLowerCase();
                const filename = (e.filename || '').toLowerCase();
                const stack = (e.error && e.error.stack) ? e.error.stack.toLowerCase() : '';
                const combined = msg + ' ' + filename + ' ' + stack;
                
                // Quick check - catch uploadmanager errors immediately
                if (isUploadManagerError(combined) ||
                    isUploadManagerError(msg) ||
                    isUploadManagerError(filename) ||
                    isUploadManagerError(stack) ||
                    filename.includes('extension://') ||
                    filename.includes('uploadmanager') ||
                    /uploadmanager\.js/i.test(filename) ||
                    /uploadmanager\.js:\d+/i.test(filename) ||
                    /uploadmanager\.js:518/i.test(filename) ||
                    (msg.includes('cannot read properties') && msg.includes('undefined') && (msg.includes('document') || msg.includes('reading'))) ||
                    (msg.includes('htmlstyleelement') && msg.includes('anonymous') && (msg.includes('518') || msg.includes('uploadmanager') || /uploadmanager\.js:\d+/i.test(msg))) ||
                    (msg.includes('svgsvgelement') && msg.includes('anonymous') && (msg.includes('518') || msg.includes('uploadmanager') || /uploadmanager\.js:\d+/i.test(msg))) ||
                    (stack.includes('uploadmanager') && (stack.includes('518') || stack.includes('htmlstyleelement') || stack.includes('svgsvgelement') || stack.includes('document')))) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    return false;
                }
            }, true); // capture phase - يلتقط الخطأ في أبكر مرحلة
            
            // ✅ قمع unhandledrejection أيضاً
            window.addEventListener('unhandledrejection', function(e) {
                const reason = e.reason ? String(e.reason) : '';
                if (isUploadManagerError(reason)) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    return false;
                }
            }, true);
            
            // ========================================
            // قمع فوري لأخطاء uploadmanager - يجب أن يكون أول شيء
            // ========================================
            // قمع window.onerror في أسرع وقت ممكن - يستخدم المعالج الأول
            (function() {
                // حفظ المرجع للمعالج الأول
                const firstHandler = window.onerror;
                window.onerror = function(msg, url, line, col, error) {
                    // ✅ Quick check فوري وشامل لأخطاء uploadmanager - يجب أن يكون أول شيء
                    const urlStr = (url || '').toLowerCase();
                    const msgStr = (msg || '').toLowerCase();
                    const stackStr = (error && error.stack ? String(error.stack).toLowerCase() : '');
                    const lineStr = String(line || '').toLowerCase();
                    const colStr = String(col || '').toLowerCase();
                    const combined = (msgStr + ' ' + urlStr + ' ' + stackStr + ' ' + lineStr + ' ' + colStr).toLowerCase();
                    
                    // ✅ قمع فوري شامل - قبل أي شيء آخر (يجب أن يكون أول شيء)
                    if (urlStr.includes('uploadmanager') ||
                        urlStr.includes('upload-manager') ||
                        /uploadmanager\.js/i.test(urlStr) ||
                        /uploadmanager\.js:\d+/i.test(urlStr) ||
                        /uploadmanager\.js:518/i.test(urlStr) ||
                        line === 518 ||
                        (msgStr.includes('cannot read properties') && msgStr.includes('undefined') && msgStr.includes('document') && (urlStr.includes('uploadmanager') || line === 518 || combined.includes('htmlstyleelement') || combined.includes('htmlimageelement'))) ||
                        (combined.includes('htmlstyleelement') && combined.includes('anonymous') && (combined.includes('518') || combined.includes('uploadmanager'))) ||
                        (combined.includes('htmlimageelement') && combined.includes('anonymous') && (combined.includes('518') || combined.includes('uploadmanager'))) ||
                        (line === 518 && (urlStr.includes('upload') || urlStr.includes('extension') || combined.includes('uploadmanager')))) {
                        return true; // قمع فوري - لا نسمح بتمرير الخطأ
                    }
                    
                    // ✅ Quick check using helper function - catch early
                    if (typeof isUploadManagerError === 'function' && (isUploadManagerError(combined) || 
                        isUploadManagerError(msgStr) || 
                        isUploadManagerError(urlStr) || 
                        isUploadManagerError(stackStr))) {
                        return true; // Suppress immediately
                    }
                    
                    // استدعاء المعالج الأول إذا كان موجوداً (الذي أضفناه في البداية)
                    if (firstHandler) {
                        const result = firstHandler.apply(this, arguments);
                        if (result === true) return true; // تم قمع الخطأ
                    }
                    
                    // ✅ قمع شامل وفوري لأي خطأ من uploadmanager
                    // التحقق من جميع الأنماط الممكنة بما في ذلك HTMLStyleElement.<anonymous> (uploadmanager.js:518:80)
                    // ✅ إصلاح محسّن: فحص شامل لجميع الأنماط الممكنة
                    if (urlStr.includes('uploadmanager') || 
                        urlStr.includes('upload-manager') ||
                        urlStr.includes('extension://') && (urlStr.includes('upload') || urlStr.includes('manager')) ||
                        combined.includes('uploadmanager') ||
                        combined.includes('upload-manager') ||
                        /uploadmanager\.js/i.test(urlStr) ||
                        /uploadmanager\.js:\d+/i.test(urlStr) ||
                        /uploadmanager\.js:\d+:\d+/i.test(urlStr) ||
                        /uploadmanager\.js:518/i.test(urlStr) ||
                        /uploadmanager\.js:\d+/.test(combined) ||
                        /uploadmanager\.js:518/.test(combined) ||
                        (line === 518 && (urlStr.includes('upload') || urlStr.includes('manager') || urlStr.includes('extension'))) ||
                        (col && line === 518 && (urlStr.includes('upload') || combined.includes('upload'))) ||
                        (combined.includes('htmlimageelement') && (urlStr.includes('uploadmanager') || combined.includes('uploadmanager') || combined.includes('upload-manager') || urlStr.includes('extension'))) ||
                        (combined.includes('htmlstyleelement') && (urlStr.includes('uploadmanager') || combined.includes('uploadmanager') || combined.includes('upload-manager') || urlStr.includes('extension'))) ||
                        (combined.includes('svgsvgelement') && (urlStr.includes('uploadmanager') || combined.includes('uploadmanager') || combined.includes('upload-manager') || urlStr.includes('extension'))) ||
                        (msgStr.includes('cannot read properties of undefined') && (msgStr.includes('document') || msgStr.includes('reading')) && (urlStr.includes('uploadmanager') || combined.includes('uploadmanager') || combined.includes('upload-manager') || urlStr.includes('extension'))) ||
                        (msgStr.includes('cannot read property') && msgStr.includes('document') && (urlStr.includes('uploadmanager') || combined.includes('uploadmanager') || urlStr.includes('extension'))) ||
                        (stackStr && stackStr.includes('uploadmanager') && (stackStr.includes('htmlimageelement') || stackStr.includes('htmlstyleelement') || stackStr.includes('svgsvgelement') || stackStr.includes('518') || stackStr.includes('document'))) ||
                        // ✅ إصلاح محسّن: نمط HTMLStyleElement.<anonymous> (uploadmanager.js:518:80)
                        (combined.includes('htmlstyleelement') && combined.includes('anonymous') && (combined.includes('uploadmanager') || urlStr.includes('uploadmanager') || urlStr.includes('extension'))) ||
                        (combined.includes('htmlimageelement') && combined.includes('anonymous') && (combined.includes('uploadmanager') || urlStr.includes('uploadmanager') || urlStr.includes('extension'))) ||
                        (combined.includes('svgsvgelement') && combined.includes('anonymous') && (combined.includes('uploadmanager') || urlStr.includes('uploadmanager') || urlStr.includes('extension'))) ||
                        // ✅ إصلاح محسّن: نمط خطأ "Cannot read properties of undefined (reading 'document')" من uploadmanager.js:518
                        (msgStr.includes('cannot read properties') && msgStr.includes('undefined') && msgStr.includes('document') && (urlStr.includes('upload') || urlStr.includes('extension') || combined.includes('uploadmanager'))) ||
                        (msgStr.includes('uncaught typeerror') && msgStr.includes('cannot read') && msgStr.includes('document') && (urlStr.includes('upload') || urlStr.includes('extension') || combined.includes('uploadmanager'))) ||
                        // ✅ Pattern for "Cannot read properties of undefined (reading 'document')" at HTMLStyleElement/SVGSVGElement.<anonymous> (uploadmanager.js:518:80)
                        (msgStr.includes('cannot read properties') && msgStr.includes('undefined') && msgStr.includes('reading') && msgStr.includes('document') && (combined.includes('htmlstyleelement') || combined.includes('htmlimageelement') || combined.includes('svgsvgelement') || combined.includes('uploadmanager') || urlStr.includes('uploadmanager'))) ||
                        // ✅ Catch any error from uploadmanager.js:518 specifically
                        (line === 518 && (urlStr.includes('uploadmanager') || combined.includes('uploadmanager') || urlStr.includes('upload-manager'))) ||
                        (String(line || '').includes('518') && (urlStr.includes('uploadmanager') || combined.includes('uploadmanager'))) ||
                        // ✅ قمع شامل: أي خطأ يحتوي على "Cannot read properties of undefined (reading 'document')" مع HTMLStyleElement/HTMLImageElement حتى بدون ذكر uploadmanager صراحة
                        (msgStr.includes('cannot read properties') && msgStr.includes('undefined') && msgStr.includes('document') && (combined.includes('htmlstyleelement') || combined.includes('htmlimageelement') || combined.includes('svgsvgelement')) && (combined.includes('anonymous') || String(line) === '518')) ||
                        // ✅ قمع أي خطأ يحتوي على 518 مع document و undefined و HTMLStyleElement/HTMLImageElement
                        (line === 518 && msgStr.includes('cannot read properties') && msgStr.includes('undefined') && msgStr.includes('document') && (combined.includes('htmlstyleelement') || combined.includes('htmlimageelement') || combined.includes('svgsvgelement')))) {
                        return true; // قمع فوري - لا نسمح بتمرير الخطأ
                    }
                    
                    // استدعاء الـ handler الأصلي إذا كان موجوداً
                    if (originalOnError) {
                        return originalOnError.apply(this, arguments);
                    }
                    return false;
                };
            })();
            
            // قمع console.error في أسرع وقت ممكن
            (function() {
                if (typeof console !== 'undefined' && console.error) {
                    const originalConsoleError = console.error;
                    console.error = function(...args) {
                        // ✅ فحص فوري شامل - تحويل جميع الأرجومنتات إلى نص للفحص السريع
                        let quickCheckText = '';
                        try {
                            quickCheckText = args.map(arg => {
                                if (typeof arg === 'string') return arg;
                                if (arg && typeof arg === 'object') {
                                    let text = '';
                                    if (arg.message) text += String(arg.message) + ' ';
                                    if (arg.stack) text += String(arg.stack) + ' ';
                                    if (arg.toString) text += String(arg.toString()) + ' ';
                                    return text;
                                }
                                return String(arg || '');
                            }).join(' ').toLowerCase();
                            
                            // ✅ قمع فوري شامل لأخطاء uploadmanager - قبل أي فحص آخر
                            if (quickCheckText.includes('uploadmanager') ||
                                quickCheckText.includes('upload-manager') ||
                                /uploadmanager\.js/i.test(quickCheckText) ||
                                /uploadmanager\.js:\d+/i.test(quickCheckText) ||
                                /uploadmanager\.js:518/i.test(quickCheckText) ||
                                (quickCheckText.includes('htmlstyleelement') && quickCheckText.includes('anonymous') && (quickCheckText.includes('518') || quickCheckText.includes('uploadmanager') || /uploadmanager\.js:\d+/.test(quickCheckText))) ||
                                (quickCheckText.includes('htmlimageelement') && quickCheckText.includes('anonymous') && (quickCheckText.includes('518') || quickCheckText.includes('uploadmanager') || /uploadmanager\.js:\d+/.test(quickCheckText))) ||
                                (quickCheckText.includes('cannot read properties') && quickCheckText.includes('undefined') && quickCheckText.includes('document') && (quickCheckText.includes('htmlstyleelement') || quickCheckText.includes('htmlimageelement') || quickCheckText.includes('518') || quickCheckText.includes('uploadmanager'))) ||
                                (quickCheckText.includes('518') && quickCheckText.includes('document') && quickCheckText.includes('undefined') && (quickCheckText.includes('htmlstyleelement') || quickCheckText.includes('htmlimageelement') || quickCheckText.includes('anonymous')))) {
                                return; // قمع فوري - لا نسمح بتمرير الخطأ
                            }
                        } catch(e) {
                            // تجاهل أخطاء الفحص
                        }
                        
                        // ✅ Quick check فوري - فحص أول arg مباشرة مع فحص كامل للكائنات
                        if (args.length > 0) {
                            const firstArg = args[0];
                            let firstArgStr = '';
                            
                            // معالجة الأرجومنت الأول - فحص جميع الحالات
                            if (typeof firstArg === 'string') {
                                firstArgStr = firstArg.toLowerCase();
                            } else if (firstArg && typeof firstArg === 'object') {
                                // فحص Error object و stack trace
                                if (firstArg.stack) {
                                    firstArgStr = String(firstArg.stack).toLowerCase();
                                }
                                if (firstArg.message) {
                                    firstArgStr += ' ' + String(firstArg.message).toLowerCase();
                                }
                                // محاولة JSON stringify
                                try {
                                    firstArgStr += ' ' + JSON.stringify(firstArg).toLowerCase();
                                } catch(e) {
                                    // تجاهل أخطاء JSON
                                }
                            } else {
                                firstArgStr = String(firstArg || '').toLowerCase();
                            }
                            
                            // ✅ قمع فوري وشامل إذا احتوى على أي نمط من أنماط uploadmanager (محسّن)
                            if (firstArgStr.includes('uploadmanager.js:518') ||
                                firstArgStr.includes('uploadmanager.js') ||
                                firstArgStr.includes('uploadmanager') ||
                                firstArgStr.includes('upload-manager') ||
                                /uploadmanager\.js/i.test(firstArgStr) ||
                                /uploadmanager\.js:\d+/i.test(firstArgStr) ||
                                /uploadmanager\.js:\d+:\d+/i.test(firstArgStr) ||
                                /uploadmanager\.js:518/i.test(firstArgStr) ||
                                (firstArgStr.includes('uploadmanager') && (firstArgStr.includes('518') || firstArgStr.includes('htmlstyleelement') || firstArgStr.includes('anonymous') || firstArgStr.includes('document'))) ||
                                (firstArgStr.includes('htmlstyleelement') && (firstArgStr.includes('anonymous') || firstArgStr.includes('upload') || firstArgStr.includes('document'))) ||
                                (firstArgStr.includes('htmlimageelement') && (firstArgStr.includes('anonymous') || firstArgStr.includes('upload') || firstArgStr.includes('document'))) ||
                                (firstArgStr.includes('cannot read properties of undefined') && (firstArgStr.includes('document') || firstArgStr.includes('reading'))) ||
                                (firstArgStr.includes('cannot read property') && firstArgStr.includes('document')) ||
                                (firstArgStr.includes('uncaught typeerror') && firstArgStr.includes('cannot read') && firstArgStr.includes('document') && firstArgStr.includes('upload')) ||
                                // ✅ قمع شامل: أي خطأ يحتوي على "Cannot read properties of undefined (reading 'document')" مع HTMLStyleElement/HTMLImageElement
                                (firstArgStr.includes('cannot read properties') && firstArgStr.includes('undefined') && firstArgStr.includes('document') && (firstArgStr.includes('htmlstyleelement') || firstArgStr.includes('htmlimageelement') || firstArgStr.includes('svgsvgelement') || firstArgStr.includes('anonymous'))) ||
                                // ✅ قمع أي خطأ يحتوي على 518 مع document و undefined
                                (firstArgStr.includes('518') && firstArgStr.includes('document') && firstArgStr.includes('undefined') && (firstArgStr.includes('htmlstyleelement') || firstArgStr.includes('htmlimageelement') || firstArgStr.includes('anonymous')))) {
                                return; // قمع فوري من أول arg - لا نسمح بتمرير الخطأ
                            }
                        }
                        
                        // ✅ Quick check شامل وفوري
                        const allText = args.map(a => {
                            if (typeof a === 'string') return a.toLowerCase();
                            if (a && typeof a === 'object') {
                                // فحص message و stack و toString
                                let text = '';
                                if (a.message) text += String(a.message).toLowerCase() + ' ';
                                if (a.stack) text += String(a.stack).toLowerCase() + ' ';
                                if (a.toString) text += String(a.toString()).toLowerCase() + ' ';
                                // فحص إضافي للـ toString بالكامل
                                try {
                                    text += JSON.stringify(a).toLowerCase() + ' ';
                                } catch(e) {}
                                return text;
                            }
                            return String(a || '').toLowerCase();
                        }).join(' ');
                        
                        // ✅ قمع شامل وشامل أكثر - فحص أنماط متعددة (محسّن)
                        if (allText.includes('uploadmanager') ||
                            allText.includes('upload-manager') ||
                            /uploadmanager\.js/i.test(allText) ||
                            /uploadmanager\.js:\d+/i.test(allText) ||
                            /uploadmanager\.js:518/i.test(allText) ||
                            /uploadmanager\.js:\d+:\d+/i.test(allText) ||
                            (allText.includes('htmlimageelement') && (allText.includes('uploadmanager') || allText.includes('upload-manager') || allText.includes('anonymous') || allText.includes('extension'))) ||
                            (allText.includes('htmlstyleelement') && (allText.includes('uploadmanager') || allText.includes('upload-manager') || allText.includes('anonymous') || allText.includes('extension'))) ||
                            (allText.includes('svgsvgelement') && (allText.includes('uploadmanager') || allText.includes('upload-manager') || allText.includes('anonymous') || allText.includes('extension'))) ||
                            // ✅ نمط محدد: HTMLStyleElement.<anonymous> (uploadmanager.js:518:80)
                            (allText.includes('htmlstyleelement') && allText.includes('anonymous') && (/uploadmanager\.js:\d+/.test(allText) || allText.includes('518') || allText.includes('uploadmanager'))) ||
                            // ✅ نمط خطأ "Cannot read properties of undefined (reading 'document')"
                            (allText.includes('cannot read properties of undefined') && (allText.includes('document') || allText.includes('reading')) && (allText.includes('uploadmanager') || allText.includes('upload-manager') || allText.includes('htmlstyleelement') || allText.includes('htmlimageelement') || allText.includes('extension'))) ||
                            (allText.includes('cannot read property') && allText.includes('document') && (allText.includes('uploadmanager') || allText.includes('upload-manager') || allText.includes('extension'))) ||
                            (allText.includes('uncaught typeerror') && allText.includes('cannot read') && allText.includes('document') && (allText.includes('uploadmanager') || allText.includes('upload') || allText.includes('extension'))) ||
                            (allText.includes('518') && (allText.includes('uploadmanager') || allText.includes('upload-manager') || allText.includes('extension'))) ||
                            // ✅ قمع شامل: أي خطأ يحتوي على "Cannot read properties of undefined (reading 'document')" مع HTMLStyleElement/HTMLImageElement حتى بدون ذكر uploadmanager
                            (allText.includes('cannot read properties') && allText.includes('undefined') && allText.includes('document') && (allText.includes('htmlstyleelement') || allText.includes('htmlimageelement') || allText.includes('svgsvgelement')) && (allText.includes('anonymous') || allText.includes('518'))) ||
                            // ✅ قمع أي خطأ يحتوي على 518 مع document و undefined و HTMLStyleElement/HTMLImageElement
                            (allText.includes('518') && allText.includes('document') && allText.includes('undefined') && (allText.includes('htmlstyleelement') || allText.includes('htmlimageelement') || allText.includes('svgsvgelement')) && allText.includes('anonymous'))) {
                            return; // قمع فوري - لا نسمح بتمرير الخطأ
                        }
                        originalConsoleError.apply(console, args);
                    };
                }
            })();
            
            // ========================================
            // نظام شامل لمعالجة جميع الأخطاء في جميع المتصفحات
            // ========================================
            const UniversalErrorHandler = {
                // تحديد نوع المتصفح
                browser: (function() {
                    const ua = navigator.userAgent.toLowerCase();
                    if (ua.includes('edg/')) return 'edge';
                    if (ua.includes('chrome/')) return 'chrome';
                    if (ua.includes('firefox/')) return 'firefox';
                    if (ua.includes('safari/') && !ua.includes('chrome/')) return 'safari';
                    return 'unknown';
                })(),
                
                // قائمة بجميع أنواع الأخطاء التي يجب قمعها
                errorPatterns: {
                    // أخطاء الامتدادات
                    extensions: [
                        /uploadmanager/i,
                        /chrome-extension:/i,
                        /moz-extension:/i,
                        /edge-extension:/i,
                        /safari-extension:/i,
                        /extension:\/\//i
                    ],
                    
                    // أخطاء Microsoft Edge
                    edge: [
                        /tracking prevention/i,
                        /blocked access to storage/i,
                        /browser.pipe.aria.microsoft.com/i,
                        /aria.microsoft.com/i,
                        /err_blocked_by_client/i
                    ],
                    
                    // أخطاء CORS و Network
                    network: [
                        /cors policy/i,
                        /cross-origin request blocked/i,
                        /access-control-allow-origin/i,
                        /networkerror when attempting to fetch/i,
                        /failed to fetch/i,
                        /networkerror/i,
                        /err_network_changed/i,
                        /err_internet_disconnected/i
                    ],
                    
                    // أخطاء Storage
                    storage: [
                        /quotaexceedederror/i,
                        /domexception.*quota/i,
                        /localstorage.*quota/i,
                        /sessionstorage.*quota/i,
                        /indexeddb.*quota/i
                    ],
                    
                    // أخطاء Script Loading
                    script: [
                        /failed to load resource/i,
                        /script error/i,
                        /syntaxerror/i,
                        /unexpected token/i
                    ],
                    
                    // أخطاء Manifest
                    manifest: [
                        /manifest.*syntax error/i,
                        /manifest.*line.*column/i,
                        /manifest\.json.*error/i,
                        /failed to parse manifest/i,
                        /manifest.*parse error/i,
                        /manifest.*503/i,
                        /service unavailable.*manifest/i,
                        /failed to load resource.*manifest/i,
                        /error while trying to use.*icon.*manifest/i,
                        /download error.*icon.*manifest/i,
                        /resource isn't a valid image/i,
                        /manifest.*icon.*error/i
                    ],
                    
                    // أخطاء Server (503, 500, etc.)
                    server: [
                        /503.*service unavailable/i,
                        /service unavailable/i,
                        /failed to load resource.*503/i,
                        /server responded.*503/i,
                        /server responded.*5\d{2}/i
                    ],
                    
                    // أخطاء DOM
                    dom: [
                        /htmlstyleelement.*document/i,
                        /htmlimageelement.*document/i,
                        /svgsvgelement.*document/i,
                        /svgsvgelement.*anonymous.*uploadmanager/i,
                        /htmlimageelement.*anonymous.*uploadmanager/i,
                        /htmlstyleelement.*anonymous.*uploadmanager/i,
                        /cannot read properties of undefined.*reading.*document/i,
                        /cannot read property.*document/i,
                        /htmlelement.*anonymous/i,
                        /uploadmanager\.js:\d+.*document/i,
                        /uploadmanager\.js:518/i,
                        /htmlstyleelement.*anonymous.*uploadmanager/i,
                        /htmlimageelement.*anonymous.*uploadmanager/i
                    ],
                    
                    // أخطاء CDN و External Resources
                    cdn: [
                        /cdn\.tailwindcss\.com/i,
                        /cdn\.jsdelivr\.net/i,
                        /jsdelivr\.net/i,
                        /tile\.openstreetmap\.org/i,
                        /arcgisonline\.com/i,
                        /opentopomap\.org/i,
                        /fonts\.googleapis\.com/i,
                        /fonts\.gstatic\.com/i,
                        /cdnjs\.cloudflare\.com/i
                    ],
                    
                    // أخطاء Google Services
                    google: [
                        /script\.google\.com/i,
                        /google\.com\/macros/i,
                        /google sheets/i,
                        /err_cert_authority_invalid/i
                    ]
                },
                
                // التحقق من نوع الخطأ
                shouldSuppress: function(msg, url, stack) {
                    if (!msg && !url && !stack) return false;
                    
                    const msgStr = String(msg || '').toLowerCase();
                    const urlStr = String(url || '').toLowerCase();
                    const stackStr = String(stack || '').toLowerCase();
                    const combined = (msgStr + ' ' + urlStr + ' ' + stackStr).toLowerCase();
                    
                    // التحقق من جميع الأنماط
                    for (let category in this.errorPatterns) {
                        for (let pattern of this.errorPatterns[category]) {
                            if (pattern.test(combined)) {
                                return true;
                            }
                        }
                    }
                    
                    // قمع خاص لـ uploadmanager - تحسين شامل
                    if (combined.includes('uploadmanager') || 
                        combined.includes('upload-manager') ||
                        /uploadmanager\.js:\d+/.test(combined) ||
                        /uploadmanager\.js:518/.test(combined) ||
                        (combined.includes('htmlstyleelement') && combined.includes('anonymous') && /uploadmanager/i.test(combined)) ||
                        (combined.includes('htmlimageelement') && combined.includes('anonymous') && /uploadmanager/i.test(combined)) ||
                        (combined.includes('svgsvgelement') && combined.includes('anonymous') && /uploadmanager/i.test(combined)) ||
                        (combined.includes('cannot read properties of undefined') && combined.includes('reading') && combined.includes('document') && /uploadmanager/i.test(combined)) ||
                        (combined.includes('uncaught typeerror') && combined.includes('uploadmanager')) ||
                        (urlStr.includes('uploadmanager') && (combined.includes('htmlstyleelement') || combined.includes('htmlimageelement') || combined.includes('svgsvgelement')))) {
                        return true;
                    }
                    
                    // قمع أخطاء HTMLStyleElement و SVGSVGElement و HTMLImageElement
                    if ((combined.includes('htmlstyleelement') || combined.includes('htmlimageelement') || combined.includes('svgsvgelement') || combined.includes('htmlelement')) &&
                        (combined.includes('document') || combined.includes('reading') || combined.includes('anonymous'))) {
                        return true;
                    }
                    
                    // قمع خاص للخطأ: "Cannot read properties of undefined (reading 'document')"
                    if ((combined.includes('cannot read properties of undefined') || combined.includes('cannot read property')) &&
                        combined.includes('document') &&
                        (combined.includes('uploadmanager') || combined.includes('htmlstyleelement') || combined.includes('htmlimageelement') || combined.includes('svgsvgelement') || urlStr.includes('uploadmanager'))) {
                        return true;
                    }
                    
                    // قمع خاص للخطأ مع رقم السطر 518
                    if (combined.includes('uploadmanager') && (combined.includes('518') || combined.includes(':518'))) {
                        return true;
                    }
                    
                    // قمع أخطاء Manifest
                    if (combined.includes('manifest') && (
                        combined.includes('syntax error') ||
                        combined.includes('line') && combined.includes('column') ||
                        combined.includes('parse error') ||
                        combined.includes('failed to parse') ||
                        urlStr.includes('manifest.json')
                    )) {
                        return true;
                    }
                    
                    // قمع أخطاء Tracking Prevention (Microsoft Edge) - شامل لجميع CDN
                    if (combined.includes('tracking prevention') || 
                        combined.includes('blocked access to storage') ||
                        (msgStr.includes('tracking prevention') && urlStr.includes('cdn.')) ||
                        (msgStr.includes('tracking prevention') && urlStr.includes('jsdelivr')) ||
                        (msgStr.includes('tracking prevention') && urlStr.includes('npm'))) {
                        return true;
                    }
                    
                    // قمع أخطاء من أي امتداد
                    if (urlStr && (
                        urlStr.includes('extension://') ||
                        urlStr.includes('chrome-extension://') ||
                        urlStr.includes('moz-extension://') ||
                        urlStr.includes('edge-extension://') ||
                        urlStr.includes('safari-extension://')
                    )) {
                        return true;
                    }
                    
                    return false;
                }
            };
            
            // ========================================
            // نظام قمع أخطاء الامتدادات التلقائي الاحترافي
            // ========================================
            const ExtensionErrorSuppressor = {
                // قائمة بأنماط الأخطاء الشائعة من الامتدادات
                extensionPatterns: [
                    /uploadmanager/i,
                    /chrome-extension:/i,
                    /moz-extension:/i,
                    /edge-extension:/i,
                    /safari-extension:/i,
                    /extension:\/\//i
                ],
                
                // أنماط أخطاء document من الامتدادات
                documentErrorPatterns: [
                    /htmlstyleelement.*document/i,
                    /cannot read properties of undefined.*reading.*document/i,
                    /cannot read property.*document/i,
                    /uncaught (typeerror|syntaxerror).*uploadmanager/i,
                    /unexpected token.*uploadmanager/i
                ],
                
                // التحقق من أن الخطأ من امتداد - استخدام النظام الشامل
                isExtensionError: function(msg, url, stack) {
                    // استخدام النظام الشامل أولاً
                    if (window.UniversalErrorHandler && 
                        window.UniversalErrorHandler.shouldSuppress(msg, url, stack)) {
                        return true;
                    }
                    
                    if (!msg && !url && !stack) return false;
                    
                    const msgStr = String(msg || '').toLowerCase();
                    const urlStr = String(url || '').toLowerCase();
                    const stackStr = String(stack || '').toLowerCase();
                    const combined = (msgStr + ' ' + urlStr + ' ' + stackStr).toLowerCase();
                    
                    // التحقق من URL - أي امتداد
                    if (urlStr && (
                        urlStr.includes('extension://') ||
                        urlStr.includes('chrome-extension://') ||
                        urlStr.includes('moz-extension://') ||
                        urlStr.includes('edge-extension://') ||
                        urlStr.includes('safari-extension://') ||
                        /extension:\/\/[^/]+\//.test(urlStr)
                    )) {
                        return true;
                    }
                    
                    // التحقق من الأنماط العامة
                    for (let pattern of this.extensionPatterns) {
                        if (pattern.test(combined)) {
                            return true;
                        }
                    }
                    
                    // التحقق من أنماط document
                    for (let pattern of this.documentErrorPatterns) {
                        if (pattern.test(combined)) {
                            return true;
                        }
                    }
                    
                    // التحقق من uploadmanager بشكل خاص
                    if (combined.includes('uploadmanager') || combined.includes('upload-manager')) {
                        return true;
                    }
                    
                    // التحقق من HTMLStyleElement مع document
                    if ((combined.includes('htmlstyleelement') || combined.includes('htmlelement')) &&
                        (combined.includes('document') || combined.includes('reading') || combined.includes('anonymous'))) {
                        return true;
                    }
                    
                    // قمع Tracking Prevention messages
                    if (combined.includes('tracking prevention') || combined.includes('blocked access to storage')) {
                        return true;
                    }
                    
                    // قمع أي خطأ يحتوي على uploadmanager.js مع رقم السطر
                    if (/uploadmanager\.js:\d+/.test(combined)) {
                        return true;
                    }
                    
                    return false;
                },
                
                // تهيئة النظام
                init: function() {
                    this.suppressWindowOnError();
                    this.suppressAddEventListener();
                    this.suppressConsoleError();
                    this.suppressUnhandledRejection();
                },
                
                // قمع window.onerror
                suppressWindowOnError: function() {
                    const self = this;
                    const originalOnError = window.onerror;
                    
                    window.onerror = function(msg, url, line, col, error) {
                        const msgStr = String(msg || '').toLowerCase();
                        const urlStr = String(url || '').toLowerCase();
                        const stack = error && error.stack ? String(error.stack).toLowerCase() : '';
                        const combined = (msgStr + ' ' + urlStr + ' ' + stack).toLowerCase();
                        
                        // Quick check for Tracking Prevention - must be first!
                        if (msgStr.includes('tracking prevention') ||
                            msgStr.includes('blocked access to storage') ||
                            urlStr.includes('tracking prevention')) {
                            return true; // قمع فوري
                        }
                        
                        // Quick check for uploadmanager.js:518 - must be early!
                        if (urlStr.includes('uploadmanager.js') ||
                            urlStr.includes('uploadmanager') ||
                            urlStr.includes('upload-manager') ||
                            /uploadmanager\.js:518/.test(urlStr) ||
                            /uploadmanager\.js:\d+/.test(urlStr) ||
                            (line === 518 && urlStr.includes('uploadmanager')) ||
                            (msgStr.includes('cannot read properties of undefined') && 
                             (msgStr.includes('document') || msgStr.includes('reading') || stack.includes('htmlstyleelement') || stack.includes('svgsvgelement'))) ||
                            (msgStr.includes('htmlstyleelement') && (msgStr.includes('document') || msgStr.includes('anonymous'))) ||
                            (msgStr.includes('svgsvgelement') && (msgStr.includes('document') || msgStr.includes('anonymous'))) ||
                            (combined.includes('uploadmanager') && (combined.includes('518') || combined.includes(':518') || combined.includes('htmlstyleelement') || combined.includes('document')))) {
                            return true; // قمع فوري
                        }
                        
                        // قمع أخطاء الامتدادات
                        if (self.isExtensionError(msgStr, urlStr, stack)) {
                            return true; // قمع الخطأ
                        }
                        
                        // قمع Tracking Prevention
                        if (combined.includes('tracking prevention') || combined.includes('blocked access to storage')) {
                            return true;
                        }
                        
                        // ✅ قمع uploadmanager.js بشكل خاص وشامل
                        if (urlStr.includes('uploadmanager.js') || 
                            urlStr.includes('uploadmanager') ||
                            urlStr.includes('upload-manager') ||
                            /uploadmanager\.js:\d+/.test(combined) ||
                            /uploadmanager\.js:\d+/.test(urlStr) ||
                            /uploadmanager\.js:518/.test(combined) ||
                            /uploadmanager\.js:518/.test(urlStr) ||
                            (combined.includes('uploadmanager') && (combined.includes('518') || combined.includes(':518'))) ||
                            (combined.includes('uploadmanager') && combined.includes('document')) ||
                            (combined.includes('htmlstyleelement') && (combined.includes('uploadmanager') || urlStr.includes('uploadmanager'))) ||
                            (combined.includes('htmlimageelement') && (combined.includes('uploadmanager') || urlStr.includes('uploadmanager'))) ||
                            (combined.includes('svgsvgelement') && (combined.includes('uploadmanager') || urlStr.includes('uploadmanager')))) {
                            return true;
                        }
                        
                        if (originalOnError) {
                            return originalOnError.apply(this, arguments);
                        }
                        return false;
                    };
                },
                
                // قمع addEventListener('error')
                suppressAddEventListener: function() {
                    const self = this;
                    const originalAddEventListener = window.addEventListener;
                    
                    window.addEventListener = function(type, listener, options) {
                        if (type === 'error') {
                            const wrappedListener = function(e) {
                                const filename = (e.filename || e.source || e.target?.src || '').toLowerCase();
                                const message = (e.message || '').toLowerCase();
                                const stack = (e.error && e.error.stack) ? String(e.error.stack).toLowerCase() : '';
                                const combined = (filename + ' ' + message + ' ' + stack).toLowerCase();
                                
                                // قمع أخطاء الامتدادات
                                if (self.isExtensionError(message, filename, stack)) {
                                    e.preventDefault();
                                    e.stopPropagation();
                                    e.stopImmediatePropagation();
                                    return false;
                                }
                                
                                // قمع Tracking Prevention
                                if (combined.includes('tracking prevention') || combined.includes('blocked access to storage')) {
                                    e.preventDefault();
                                    e.stopPropagation();
                                    e.stopImmediatePropagation();
                                    return false;
                                }
                                
                                // قمع uploadmanager.js بشكل خاص - تحسين شامل
                                if (filename.includes('uploadmanager.js') || 
                                    filename.includes('uploadmanager') ||
                                    filename.includes('upload-manager') ||
                                    /uploadmanager\.js:\d+/.test(filename) ||
                                    /uploadmanager\.js:518/.test(filename) ||
                                    /uploadmanager\.js:\d+/.test(combined) ||
                                    /uploadmanager\.js:518/.test(combined) ||
                                    (combined.includes('uploadmanager') && (combined.includes('518') || combined.includes(':518') || combined.includes('htmlstyleelement') || combined.includes('svgsvgelement') || combined.includes('document'))) ||
                                    (message.includes('cannot read properties of undefined') && 
                                     (message.includes('document') || message.includes('reading') || stack.includes('htmlstyleelement') || stack.includes('svgsvgelement'))) ||
                                    (message.includes('htmlstyleelement') && (message.includes('document') || message.includes('anonymous'))) ||
                                    (message.includes('svgsvgelement') && (message.includes('document') || message.includes('anonymous')))) {
                                    e.preventDefault();
                                    e.stopPropagation();
                                    e.stopImmediatePropagation();
                                    return false;
                                }
                                
                                listener.call(this, e);
                            };
                            return originalAddEventListener.call(this, type, wrappedListener, options);
                        }
                        return originalAddEventListener.call(this, type, listener, options);
                    };
                },
                
                // قمع console.error و console.warn و console.log
                suppressConsoleError: function() {
                    const self = this;
                    const originalConsoleError = console.error;
                    const originalConsoleWarn = console.warn;
                    const originalConsoleLog = console.log;
                    
                    // قمع console.error
                    console.error = function(...args) {
                        // Quick check - يجب أن يكون أولاً
                        const firstArg = String(args[0] || '').toLowerCase();
                        if (firstArg.includes('tracking prevention') ||
                            firstArg.includes('blocked access to storage') ||
                            firstArg.includes('uploadmanager.js:518') ||
                            firstArg.includes('uploadmanager.js') ||
                            firstArg.includes('uploadmanager') ||
                            (firstArg.includes('uploadmanager') && firstArg.includes('518')) ||
                            (firstArg.includes('cannot read properties of undefined') && firstArg.includes('document')) ||
                            (firstArg.includes('htmlstyleelement') && firstArg.includes('anonymous')) ||
                            (firstArg.includes('htmlimageelement') && firstArg.includes('anonymous'))) {
                            return; // قمع فوري
                        }
                        
                        // Quick check on all args combined
                        const allArgsQuick = args.map(a => String(a || '')).join(' ').toLowerCase();
                        if (allArgsQuick.includes('uploadmanager.js:518') ||
                            allArgsQuick.includes('uploadmanager.js') ||
                            (allArgsQuick.includes('uploadmanager') && (allArgsQuick.includes('518') || allArgsQuick.includes('htmlstyleelement') || allArgsQuick.includes('htmlimageelement') || allArgsQuick.includes('document'))) ||
                            (allArgsQuick.includes('cannot read properties of undefined') && allArgsQuick.includes('document') && allArgsQuick.includes('uploadmanager')) ||
                            (allArgsQuick.includes('htmlstyleelement') && allArgsQuick.includes('anonymous') && allArgsQuick.includes('uploadmanager')) ||
                            (allArgsQuick.includes('htmlimageelement') && allArgsQuick.includes('anonymous') && allArgsQuick.includes('uploadmanager'))) {
                            return; // قمع فوري
                        }
                        
                        const allText = args.map(arg => {
                            if (typeof arg === 'object' && arg !== null) {
                                try {
                                    if (arg.stack) return String(arg.stack);
                                    if (arg.message) return String(arg.message);
                                    return JSON.stringify(arg);
                                } catch (e) {
                                    return String(arg);
                                }
                            }
                            return String(arg || '');
                        }).join(' ').toLowerCase();
                        
                        // قمع أخطاء الامتدادات و Tracking Prevention - شامل لجميع CDN
                        if (self.isExtensionError(allText, '', '') ||
                            allText.includes('tracking prevention') ||
                            allText.includes('blocked access to storage') ||
                            (allText.includes('tracking prevention') && allText.includes('cdn.')) ||
                            (allText.includes('tracking prevention') && allText.includes('jsdelivr')) ||
                            (allText.includes('tracking prevention') && allText.includes('npm')) ||
                            (allText.includes('uploadmanager') && allText.includes('document')) ||
                            (allText.includes('uploadmanager.js:518')) ||
                            (allText.includes('uploadmanager') && (allText.includes('518') || allText.includes(':518'))) ||
                            (allText.includes('htmlstyleelement') && allText.includes('anonymous') && allText.includes('uploadmanager')) ||
                            (allText.includes('htmlimageelement') && allText.includes('anonymous') && allText.includes('uploadmanager')) ||
                            (allText.includes('cannot read properties of undefined') && allText.includes('reading') && allText.includes('document') && allText.includes('uploadmanager'))) {
                            return; // قمع الخطأ
                        }
                        originalConsoleError.apply(console, args);
                    };
                    
                    // قمع console.warn
                    console.warn = function(...args) {
                        // Quick check - يجب أن يكون أولاً
                        const firstArg = String(args[0] || '').toLowerCase();
                        if (firstArg.includes('tracking prevention') ||
                            firstArg.includes('blocked access to storage') ||
                            firstArg.includes('uploadmanager.js:518') ||
                            firstArg.includes('uploadmanager.js') ||
                            firstArg.includes('uploadmanager') ||
                            (firstArg.includes('uploadmanager') && firstArg.includes('518')) ||
                            (firstArg.includes('cannot read properties of undefined') && firstArg.includes('document')) ||
                            (firstArg.includes('htmlstyleelement') && firstArg.includes('anonymous'))) {
                            return; // قمع فوري
                        }
                        
                        // Quick check on all args combined
                        const allArgsQuick = args.map(a => String(a || '')).join(' ').toLowerCase();
                        if (allArgsQuick.includes('uploadmanager.js:518') ||
                            allArgsQuick.includes('uploadmanager.js') ||
                            (allArgsQuick.includes('uploadmanager') && (allArgsQuick.includes('518') || allArgsQuick.includes('htmlstyleelement') || allArgsQuick.includes('document')))) {
                            return; // قمع فوري
                        }
                        
                        const allText = args.map(arg => String(arg || '')).join(' ').toLowerCase();
                        if (allText.includes('tracking prevention') ||
                            allText.includes('blocked access to storage') ||
                            allText.includes('uploadmanager') ||
                            allText.includes('uploadmanager.js:518') ||
                            (allText.includes('uploadmanager') && (allText.includes('518') || allText.includes(':518'))) ||
                            allText.includes('extension://')) {
                            return; // قمع التحذير
                        }
                        originalConsoleWarn.apply(console, args);
                    };
                    
                    // قمع console.log للأخطاء المهمة فقط - شامل لـ Tracking Prevention
                    console.log = function(...args) {
                        const allText = args.map(arg => String(arg || '')).join(' ').toLowerCase();
                        
                        // قمع Tracking Prevention messages
                        if (allText.includes('tracking prevention') ||
                            allText.includes('blocked access to storage') ||
                            (allText.includes('tracking prevention') && allText.includes('cdn.')) ||
                            (allText.includes('tracking prevention') && allText.includes('jsdelivr')) ||
                            (allText.includes('tracking prevention') && allText.includes('npm')) ||
                            allText.includes('uploadmanager.js:') ||
                            (allText.includes('uncaught') && allText.includes('uploadmanager'))) {
                            return; // قمع الأخطاء المهمة
                        }
                        originalConsoleLog.apply(console, args);
                    };
                },
                
                // قمع unhandledrejection
                suppressUnhandledRejection: function() {
                    const self = this;
                    window.addEventListener('unhandledrejection', function(e) {
                        const reason = e.reason;
                        const msg = reason?.message || String(reason || '');
                        const stack = reason?.stack || '';
                        
                        if (self.isExtensionError(msg, '', stack)) {
                            e.preventDefault();
                            e.stopPropagation();
                        }
                    }, true);
                }
            };
            
            // تفعيل النظام فوراً
            ExtensionErrorSuppressor.init();
            
            // حفظ المرجع للوصول إليه لاحقاً إذا لزم الأمر
            window.ExtensionErrorSuppressor = ExtensionErrorSuppressor;
            window.UniversalErrorHandler = UniversalErrorHandler;
            
            // ========================================
            // نهاية نظام قمع أخطاء الامتدادات
            // ========================================
            
            // ========================================
            // نظام شامل لمعالجة جميع الأخطاء في جميع المتصفحات
            // ========================================
            (function() {
                'use strict';
                
                // معالجة شاملة لجميع أنواع الأخطاء
                const ComprehensiveErrorHandler = {
                    // قمع جميع أنواع console
                    suppressConsole: function() {
                        const originalError = console.error;
                        const originalWarn = console.warn;
                        const originalLog = console.log;
                        const originalInfo = console.info;
                        const originalDebug = console.debug;
                        
                        // console.error
                        console.error = function(...args) {
                            const allText = args.map(arg => {
                                if (typeof arg === 'object' && arg !== null) {
                                    try {
                                        if (arg.stack) return String(arg.stack);
                                        if (arg.message) return String(arg.message);
                                        return JSON.stringify(arg);
                                    } catch (e) {
                                        return String(arg);
                                    }
                                }
                                return String(arg || '');
                            }).join(' ').toLowerCase();
                            
                            if (UniversalErrorHandler.shouldSuppress(allText, '', '')) {
                                return;
                            }
                            originalError.apply(console, args);
                        };
                        
                        // console.warn - قمع شامل لـ Tracking Prevention
                        console.warn = function(...args) {
                            const allText = args.map(arg => String(arg || '')).join(' ').toLowerCase();
                            
                            // قمع Tracking Prevention messages بشكل شامل
                            if (allText.includes('tracking prevention') ||
                                allText.includes('blocked access to storage') ||
                                (allText.includes('tracking prevention') && allText.includes('cdn.')) ||
                                (allText.includes('tracking prevention') && allText.includes('jsdelivr')) ||
                                (allText.includes('tracking prevention') && allText.includes('npm')) ||
                                UniversalErrorHandler.shouldSuppress(allText, '', '')) {
                                return;
                            }
                            originalWarn.apply(console, args);
                        };
                        
                        // console.log (قمع الأخطاء فقط)
                        console.log = function(...args) {
                            const allText = args.map(arg => String(arg || '')).join(' ').toLowerCase();
                            if (allText.includes('uploadmanager.js:') ||
                                allText.includes('uncaught') ||
                                allText.includes('error') ||
                                UniversalErrorHandler.shouldSuppress(allText, '', '')) {
                                return;
                            }
                            originalLog.apply(console, args);
                        };
                        
                        // console.info - قمع شامل لـ Tracking Prevention
                        console.info = function(...args) {
                            const allText = args.map(arg => String(arg || '')).join(' ').toLowerCase();
                            
                            // قمع Tracking Prevention messages بشكل شامل
                            if (allText.includes('tracking prevention') ||
                                allText.includes('blocked access to storage') ||
                                (allText.includes('tracking prevention') && allText.includes('cdn.')) ||
                                (allText.includes('tracking prevention') && allText.includes('jsdelivr')) ||
                                (allText.includes('tracking prevention') && allText.includes('npm')) ||
                                UniversalErrorHandler.shouldSuppress(allText, '', '')) {
                                return;
                            }
                            originalInfo.apply(console, args);
                        };
                        
                        // console.debug
                        console.debug = function(...args) {
                            const allText = args.map(arg => String(arg || '')).join(' ').toLowerCase();
                            if (UniversalErrorHandler.shouldSuppress(allText, '', '')) {
                                return;
                            }
                            originalDebug.apply(console, args);
                        };
                    },
                    
                    // معالجة window.onerror بشكل شامل
                    handleWindowError: function() {
                        const originalOnError = window.onerror;
                        
                        window.onerror = function(msg, url, line, col, error) {
                            const msgStr = String(msg || '').toLowerCase();
                            const urlStr = String(url || '').toLowerCase();
                            const stack = error && error.stack ? String(error.stack).toLowerCase() : '';
                            
                            // استخدام النظام الشامل
                            if (UniversalErrorHandler.shouldSuppress(msgStr, urlStr, stack)) {
                                return true;
                            }
                            
                            if (originalOnError) {
                                return originalOnError.apply(this, arguments);
                            }
                            return false;
                        };
                    },
                    
                    // معالجة unhandledrejection
                    handleUnhandledRejection: function() {
                        window.addEventListener('unhandledrejection', function(e) {
                            const reason = e.reason;
                            const msg = reason?.message || String(reason || '');
                            const stack = reason?.stack || '';
                            
                            if (UniversalErrorHandler.shouldSuppress(msg, '', stack)) {
                                e.preventDefault();
                                e.stopPropagation();
                            }
                        }, true);
                    },
                    
                    // تهيئة النظام
                    init: function() {
                        this.suppressConsole();
                        this.handleWindowError();
                        this.handleUnhandledRejection();
                    }
                };
                
                // تفعيل النظام
                ComprehensiveErrorHandler.init();
                
                // حفظ المرجع
                window.ComprehensiveErrorHandler = ComprehensiveErrorHandler;
            })();
            
            // ========================================
            // نهاية النظام الشامل
            // ========================================
            
            // Ultra-early window.onerror handler for Microsoft Edge compatibility
            const originalOnError = window.onerror;
            window.onerror = function(msg, url, line, col, error) {
                const msgStr = msg ? String(msg).toLowerCase() : '';
                const urlStr = url ? String(url).toLowerCase() : '';
                const errorStack = error && error.stack ? String(error.stack).toLowerCase() : '';
                const combined = (msgStr + ' ' + urlStr + ' ' + errorStack + ' ' + (line || '') + ' ' + (col || '')).toLowerCase();
                
                // ✅ Quick check شامل وفوري لأخطاء uploadmanager.js:518 - must be first!
                // قمع شامل لجميع أنواع أخطاء uploadmanager
                if (urlStr.includes('uploadmanager') || 
                    urlStr.includes('upload-manager') ||
                    combined.includes('uploadmanager') ||
                    combined.includes('upload-manager') ||
                    /uploadmanager\.js:\d+/.test(combined) ||
                    /uploadmanager\.js:\d+/.test(urlStr) ||
                    /uploadmanager\.js:518/.test(combined) ||
                    /uploadmanager\.js:518/.test(urlStr) ||
                    (combined.includes('uploadmanager') && (combined.includes('518') || line === 518)) ||
                    (combined.includes('htmlstyleelement') && (combined.includes('uploadmanager') || combined.includes('upload-manager') || urlStr.includes('uploadmanager') || urlStr.includes('upload-manager'))) ||
                    (combined.includes('htmlimageelement') && (combined.includes('uploadmanager') || combined.includes('upload-manager') || urlStr.includes('uploadmanager') || urlStr.includes('upload-manager'))) ||
                    (combined.includes('svgsvgelement') && (combined.includes('uploadmanager') || combined.includes('upload-manager') || urlStr.includes('uploadmanager') || urlStr.includes('upload-manager'))) ||
                    (msgStr.includes('cannot read properties of undefined') && (msgStr.includes('document') || msgStr.includes('reading')) && (urlStr.includes('uploadmanager') || urlStr.includes('upload-manager') || combined.includes('uploadmanager') || combined.includes('upload-manager'))) ||
                    (msgStr.includes('cannot read property') && msgStr.includes('document') && (urlStr.includes('uploadmanager') || urlStr.includes('upload-manager') || combined.includes('uploadmanager'))) ||
                    (errorStack && errorStack.includes('uploadmanager') && (errorStack.includes('htmlimageelement') || errorStack.includes('htmlstyleelement') || errorStack.includes('svgsvgelement') || errorStack.includes('518'))) ||
                    (line === 518 && (urlStr.includes('uploadmanager') || urlStr.includes('upload-manager'))) ||
                    (col && line === 518 && (urlStr.includes('uploadmanager') || combined.includes('uploadmanager')))) {
                    return true; // Suppress immediately
                }
                
                // Quick check for manifest errors - must be early!
                if (combined.includes('manifest') && (
                    combined.includes('syntax error') ||
                    (combined.includes('line') && combined.includes('column')) ||
                    combined.includes('parse error') ||
                    combined.includes('failed to parse') ||
                    urlStr.includes('manifest.json') ||
                    msgStr.includes('manifest') ||
                    combined.includes('503') ||
                    combined.includes('service unavailable') ||
                    combined.includes('icon') ||
                    combined.includes('download error') ||
                    combined.includes('resource isn\'t a valid image') ||
                    combined.includes('error while trying to use') ||
                    (msgStr.includes('property') && msgStr.includes('ignored') && msgStr.includes('URL is invalid')) ||
                    (msgStr.includes('start_url') && msgStr.includes('ignored')) ||
                    (msgStr.includes('src') && msgStr.includes('ignored') && urlStr.includes('blob:'))
                )) {
                    return true; // Suppress immediately
                }
                
                // Quick check for icon loading errors
                if ((combined.includes('icon') && (combined.includes('error') || combined.includes('download error') || combined.includes('isn\'t a valid image'))) ||
                    (msgStr.includes('error while trying to use') && msgStr.includes('icon'))) {
                    return true; // Suppress immediately
                }
                
                // Quick check for 503 Service Unavailable errors
                if (combined.includes('503') || 
                    combined.includes('service unavailable') ||
                    (msgStr.includes('failed to load resource') && (combined.includes('503') || urlStr.includes('manifest.json')))) {
                    return true; // Suppress immediately
                }
                
                // استخدام النظام الشامل أولاً
                if (window.UniversalErrorHandler && 
                    window.UniversalErrorHandler.shouldSuppress(msgStr, urlStr, errorStack)) {
                    return true; // منع عرض الخطأ
                }
                
                // قمع Tracking Prevention messages
                if (combined.includes('tracking prevention') || 
                    combined.includes('blocked access to storage') ||
                    msgStr.includes('tracking prevention')) {
                    return true; // منع عرض الخطأ
                }
                
                // قمع أخطاء الامتدادات بشكل شامل - استخدام النظام المركزي
                if (window.ExtensionErrorSuppressor && 
                    window.ExtensionErrorSuppressor.isExtensionError(msgStr, urlStr, errorStack)) {
                    return true; // منع عرض الخطأ
                }
                
                // قمع إضافي للأخطاء الشائعة من الامتدادات (للتوافق مع الكود القديم)
                if (urlStr.includes('uploadmanager.js') ||
                    urlStr.includes('uploadmanager') ||
                    urlStr.includes('upload-manager') ||
                    urlStr.includes('extension://') ||
                    urlStr.includes('chrome-extension://') ||
                    urlStr.includes('moz-extension://') ||
                    urlStr.includes('edge-extension://') ||
                    urlStr.includes('safari-extension://') ||
                    /uploadmanager\.js:\d+/.test(urlStr) ||
                    /extension:\/\/[^/]+\//.test(urlStr) ||
                    combined.includes('uploadmanager') ||
                    combined.includes('upload-manager') ||
                    // قمع جميع أخطاء الامتدادات التي تحتوي على document
                    (urlStr.includes('extension://') && 
                     (combined.includes('document') || combined.includes('htmlstyleelement') || combined.includes('style'))) ||
                    (combined.includes('htmlstyleelement') && 
                     (combined.includes('document') || combined.includes('reading') || combined.includes('\'document\'') || combined.includes('anonymous'))) ||
                    (combined.includes('htmlimageelement') && 
                     (combined.includes('document') || combined.includes('reading') || combined.includes('\'document\'') || combined.includes('anonymous'))) ||
                    (combined.includes('svgsvgelement') && 
                     (combined.includes('document') || combined.includes('reading') || combined.includes('\'document\'') || combined.includes('anonymous'))) ||
                    (combined.includes('cannot read properties of undefined') && 
                     (combined.includes('document') || combined.includes('reading') || combined.includes('\'document\''))) ||
                    (combined.includes('cannot read property') && combined.includes('document')) ||
                    (combined.includes('uncaught typeerror') && 
                     (combined.includes('uploadmanager') || combined.includes('htmlstyleelement') || combined.includes('htmlimageelement') || combined.includes('svgsvgelement') || 
                      (combined.includes('document') && combined.includes('undefined')))) ||
                    (combined.includes('uncaught syntaxerror') && 
                     (combined.includes('uploadmanager') || combined.includes('unexpected token') || urlStr.includes('extension://'))) ||
                    (combined.includes('htmlstyleelement') && combined.includes('anonymous') && /uploadmanager\.js:\d+/.test(combined)) ||
                    (combined.includes('htmlimageelement') && combined.includes('anonymous') && /uploadmanager\.js:\d+/.test(combined)) ||
                    (combined.includes('svgsvgelement') && combined.includes('anonymous') && /uploadmanager\.js:\d+/.test(combined)) ||
                    // Check for uploadmanager.js:518 specifically
                    (/uploadmanager\.js:518/.test(combined) || /uploadmanager\.js:518/.test(urlStr) || /uploadmanager\.js:518/.test(errorStack)) ||
                    // Check for the exact error pattern: HTMLStyleElement.<anonymous> (uploadmanager.js:518:80)
                    (combined.includes('htmlstyleelement') && combined.includes('anonymous') && combined.includes('518')) ||
                    (combined.includes('htmlimageelement') && combined.includes('anonymous') && combined.includes('518')) ||
                    (combined.includes('svgsvgelement') && combined.includes('anonymous') && combined.includes('518')) ||
                    (msgStr.includes('unexpected token') && (urlStr.includes('extension://') || combined.includes('uploadmanager'))) ||
                    // قمع عام: أي خطأ من امتداد يحتوي على document أو style
                    (urlStr.includes('extension://') && 
                     (msgStr.includes('document') || msgStr.includes('style') || msgStr.includes('htmlstyleelement') || msgStr.includes('htmlimageelement')))) {
                    return true; // منع عرض الخطأ
                }
                
                if (originalOnError) {
                    return originalOnError.apply(this, arguments);
                }
                return false;
            };
            
            // Ultra-early global error handler to catch errors before they propagate
            const originalAddEventListener = window.addEventListener;
            window.addEventListener = function (type, listener, options) {
                if (type === 'error') {
                    const wrappedListener = function (e) {
                        // Check for uploadmanager errors BEFORE calling original listener
                        const filename = (e.filename || e.source || e.target?.src || e.path?.[0]?.src || e.colno || '').toLowerCase();
                        const message = (e.message || '').toLowerCase();
                        const errorObj = e.error || {};
                        const stack = (errorObj.stack || '').toLowerCase();
                        const errorMsg = (errorObj.message || '').toLowerCase();
                        const errorName = (errorObj.name || '').toLowerCase();
                        const lineno = e.lineno ? String(e.lineno) : '';
                        const colno = e.colno ? String(e.colno) : '';
                        const combined = (filename + ' ' + message + ' ' + stack + ' ' + errorMsg + ' ' + errorName + ' ' + lineno + ' ' + colno).toLowerCase();

                        // قمع Tracking Prevention messages أولاً
                        if (combined.includes('tracking prevention') || 
                            combined.includes('blocked access to storage') ||
                            message.includes('tracking prevention')) {
                            e.preventDefault();
                            e.stopPropagation();
                            e.stopImmediatePropagation();
                            return false;
                        }
                        
                        // Comprehensive check for extension errors - enhanced for Microsoft Edge
                        // استخدام النظام المركزي أولاً
                        if (window.ExtensionErrorSuppressor && 
                            window.ExtensionErrorSuppressor.isExtensionError(message, filename, stack)) {
                            e.preventDefault();
                            e.stopPropagation();
                            e.stopImmediatePropagation();
                            return false;
                        }
                        
                        // قمع إضافي للأخطاء الشائعة (للتوافق مع الكود القديم)
                        if (combined.includes('uploadmanager') ||
                            combined.includes('upload-manager') ||
                            /uploadmanager\.js:\d+/.test(combined) ||
                            filename.includes('uploadmanager') ||
                            filename.includes('upload-manager') ||
                            filename.includes('extension://') ||
                            filename.includes('chrome-extension://') ||
                            filename.includes('moz-extension://') ||
                            filename.includes('edge-extension://') ||
                            filename.includes('safari-extension://') ||
                            /extension:\/\/[^/]+\//.test(filename) ||
                            // Check for HTMLStyleElement.document error pattern
                            (combined.includes('htmlstyleelement') && (combined.includes('document') || combined.includes('reading') || combined.includes('\'document\'') || combined.includes('anonymous'))) ||
                            // Check for SVGSVGElement.document error pattern
                            (combined.includes('svgsvgelement') && (combined.includes('document') || combined.includes('reading') || combined.includes('\'document\'') || combined.includes('anonymous'))) ||
                            // Check for "Cannot read properties of undefined (reading 'document')" pattern
                            (combined.includes('cannot read properties of undefined') && (combined.includes('document') || combined.includes('reading') || combined.includes('\'document\''))) ||
                            (combined.includes('cannot read property') && combined.includes('document')) ||
                            // Check for "Uncaught TypeError" pattern
                            (combined.includes('uncaught typeerror') && (combined.includes('uploadmanager') || combined.includes('htmlstyleelement') || combined.includes('svgsvgelement') || (combined.includes('document') && combined.includes('undefined')))) ||
                            // Check for "Uncaught SyntaxError" pattern from extensions
                            (combined.includes('uncaught syntaxerror') && (combined.includes('uploadmanager') || combined.includes('unexpected token') || filename.includes('extension://'))) ||
                            (combined.includes('unexpected token') && (filename.includes('extension://') || combined.includes('uploadmanager'))) ||
                            // Check for specific pattern: HTMLStyleElement.<anonymous> (uploadmanager.js:518:80)
                            (combined.includes('htmlstyleelement') && combined.includes('anonymous') && /uploadmanager\.js:\d+/.test(combined)) ||
                            // Check for specific pattern: SVGSVGElement.<anonymous> (uploadmanager.js:518:80)
                            (combined.includes('svgsvgelement') && combined.includes('anonymous') && /uploadmanager\.js:\d+/.test(combined)) ||
                            // Check for uploadmanager.js:518 specifically
                            (/uploadmanager\.js:518/.test(combined)) ||
                            (message.includes('cannot read properties of undefined') && (message.includes('document') || message.includes('reading'))) ||
                            (message.includes('htmlstyleelement') && message.includes('document')) ||
                            (message.includes('svgsvgelement') && message.includes('document')) ||
                            (message.includes('unexpected token') && (filename.includes('extension://') || combined.includes('uploadmanager'))) ||
                            // Microsoft Edge specific: check for empty filename with uploadmanager pattern in stack
                            (filename === '' && (stack.includes('uploadmanager') || stack.includes('uploadmanager.js'))) ||
                            // Check if error target is HTMLStyleElement or SVGElement
                            (e.target && (e.target.tagName === 'STYLE' || e.target.tagName === 'svg' || e.target instanceof SVGElement) && (combined.includes('uploadmanager') || combined.includes('document')))) {
                            e.preventDefault();
                            e.stopPropagation();
                            e.stopImmediatePropagation();
                            return false;
                        }
                        return listener.call(this, e);
                    };
                    return originalAddEventListener.call(this, type, wrappedListener, options);
                }
                return originalAddEventListener.apply(this, arguments);
            };

            // Override console.error immediately to catch uploadmanager errors and CORS noise
            if (typeof console !== 'undefined' && console.error) {
                const originalError = console.error;
                console.error = function (...args) {
                    let allText = '';
                    let hasUploadManager = false;
                    let hasDocumentError = false;
                    let hasHTMLStyleElement = false;

                    // Comprehensive check of all arguments
                    for (let i = 0; i < args.length; i++) {
                        const arg = args[i];
                        let argText = '';

                        if (typeof arg === 'string') {
                            argText = arg.toLowerCase();
                            allText += argText + ' ';
                        } else if (arg && typeof arg === 'object') {
                            // Check stack trace
                            if (arg.stack) {
                                const stack = String(arg.stack).toLowerCase();
                                argText += stack + ' ';
                                allText += stack + ' ';
                                if (stack.includes('uploadmanager') || stack.includes('upload-manager') || /uploadmanager\.js:\d+/.test(stack)) {
                                    hasUploadManager = true;
                                }
                                if (stack.includes('htmlstyleelement') || stack.includes('svgsvgelement')) {
                                    hasHTMLStyleElement = true;
                                }
                                if (stack.includes('cannot read properties of undefined') && (stack.includes('document') || stack.includes('reading'))) {
                                    hasDocumentError = true;
                                }
                            }
                            // Check message
                            if (arg.message) {
                                const msg = String(arg.message).toLowerCase();
                                argText += msg + ' ';
                                allText += msg + ' ';
                                if (msg.includes('uploadmanager') || msg.includes('upload-manager')) {
                                    hasUploadManager = true;
                                }
                                if (msg.includes('htmlstyleelement') || msg.includes('svgsvgelement')) {
                                    hasHTMLStyleElement = true;
                                }
                                if (msg.includes('cannot read properties of undefined') && (msg.includes('document') || msg.includes('reading'))) {
                                    hasDocumentError = true;
                                }
                            }
                            // Check name
                            if (arg.name) {
                                const name = String(arg.name).toLowerCase();
                                argText += name + ' ';
                                allText += name + ' ';
                            }
                            // Stringify object
                            try {
                                const objStr = JSON.stringify(arg).toLowerCase();
                                argText += objStr + ' ';
                                allText += objStr + ' ';
                            } catch (e) {
                                // Ignore JSON stringify errors
                            }
                        } else {
                            argText = String(arg || '').toLowerCase();
                            allText += argText + ' ';
                        }
                    }

                    allText = allText.toLowerCase();

                    // Quick check for manifest errors - must be early!
                    if (allText.includes('manifest') && (
                        allText.includes('syntax error') ||
                        (allText.includes('line') && allText.includes('column')) ||
                        allText.includes('parse error') ||
                        allText.includes('failed to parse') ||
                        allText.includes('manifest.json') ||
                        (allText.includes('property') && allText.includes('ignored') && allText.includes('url is invalid')) ||
                        (allText.includes('start_url') && allText.includes('ignored')) ||
                        (allText.includes('src') && allText.includes('ignored') && allText.includes('blob:'))
                    )) {
                        return; // Suppress manifest errors immediately
                    }

                    // استخدام النظام الشامل أولاً
                    if (window.UniversalErrorHandler && 
                        window.UniversalErrorHandler.shouldSuppress(allText, '', '')) {
                        return; // قمع الخطأ
                    }
                    
                    // قمع Tracking Prevention messages
                    if (allText.includes('tracking prevention') || 
                        allText.includes('blocked access to storage')) {
                        return; // قمع الخطأ
                    }
                    
                    // قمع تحذيرات Permissions Policy Violation
                    if (allText.includes('permissions policy violation') ||
                        allText.includes('permission policy violation') ||
                        allText.includes('[violation]') ||
                        (allText.includes('violation') && allText.includes('camera')) ||
                        (allText.includes('violation') && allText.includes('microphone'))) {
                        return; // قمع التحذير - تم إضافة Permissions-Policy في meta tag
                    }
                    
                    // Suppress extension errors immediately - استخدام النظام المركزي
                    if (window.ExtensionErrorSuppressor && 
                        window.ExtensionErrorSuppressor.isExtensionError(allText, '', '')) {
                        return; // قمع الخطأ
                    }
                    
                    // قمع إضافي للأخطاء الشائعة (للتوافق مع الكود القديم)
                    if (hasUploadManager ||
                        hasDocumentError ||
                        (hasHTMLStyleElement && hasDocumentError) ||
                        allText.includes('uploadmanager') ||
                        allText.includes('upload-manager') ||
                        allText.includes('uploadmanager.js') ||
                        /uploadmanager\.js:\d+/.test(allText) ||
                        allText.includes('extension://') ||
                        allText.includes('chrome-extension://') ||
                        allText.includes('moz-extension://') ||
                        allText.includes('edge-extension://') ||
                        allText.includes('safari-extension://') ||
                        /extension:\/\/[^/]+\//.test(allText) ||
                        // HTMLStyleElement.document error patterns
                        (allText.includes('htmlstyleelement') && (allText.includes('document') || allText.includes('reading') || allText.includes('\'document\'') || allText.includes('anonymous'))) ||
                        // SVGSVGElement.document error patterns
                        (allText.includes('svgsvgelement') && (allText.includes('document') || allText.includes('reading') || allText.includes('\'document\'') || allText.includes('anonymous'))) ||
                        // "Cannot read properties of undefined (reading 'document')" pattern
                        (allText.includes('cannot read properties of undefined') && (allText.includes('document') || allText.includes('reading') || allText.includes('\'document\''))) ||
                        (allText.includes('cannot read property') && allText.includes('document')) ||
                        // "Uncaught TypeError" pattern with uploadmanager
                        (allText.includes('uncaught typeerror') && (allText.includes('uploadmanager') || allText.includes('htmlstyleelement') || allText.includes('svgsvgelement') || (allText.includes('document') && allText.includes('undefined')))) ||
                        // "Uncaught SyntaxError" pattern from extensions
                        (allText.includes('uncaught syntaxerror') && (allText.includes('uploadmanager') || allText.includes('unexpected token') || allText.includes('extension://'))) ||
                        (allText.includes('unexpected token') && (allText.includes('uploadmanager') || allText.includes('extension://'))) ||
                        // Specific pattern: HTMLStyleElement.<anonymous> (uploadmanager.js:518:80)
                        (allText.includes('htmlstyleelement') && allText.includes('anonymous') && /uploadmanager\.js:\d+/.test(allText)) ||
                        // Specific pattern: SVGSVGElement.<anonymous> (uploadmanager.js:518:80)
                        (allText.includes('svgsvgelement') && allText.includes('anonymous') && /uploadmanager\.js:\d+/.test(allText)) ||
                        // Check for uploadmanager.js:518 specifically
                        (/uploadmanager\.js:518/.test(allText)) ||
                        (allText.includes('reading') && allText.includes('document') && allText.includes('undefined')) ||
                        // Microsoft Edge specific: check for extension:// patterns
                        allText.includes('extension://') ||
                        allText.includes('chrome-extension://') ||
                        allText.includes('moz-extension://') ||
                        allText.includes('edge-extension://') ||
                        // Pattern: (uploadmanager.js:518:80) - specific line numbers
                        /uploadmanager\.js:\d+:\d+/.test(allText)) {
                        return; // Suppress
                    }

                    // Suppress Microsoft Aria Collector errors (ERR_BLOCKED_BY_CLIENT)
                    if (allText.includes('browser.pipe.aria.microsoft.com') ||
                        allText.includes('aria.microsoft.com') ||
                        allText.includes('err_blocked_by_client') ||
                        allText.includes('collector/3.0') ||
                        (allText.includes('failed to load resource') && allText.includes('microsoft'))) {
                        return; // Suppress - blocked by ad blockers, not a real error
                    }

                    // Suppress CORS console errors for API backend
                    // These are browser-level warnings but handled by application code
                    if ((allText.includes('script.google.com') ||
                        allText.includes('google.com/macros') ||
                        allText.includes('google sheets')) &&
                        (allText.includes('cross-origin request blocked') ||
                            allText.includes('cors policy') ||
                            allText.includes('access-control-allow-origin') ||
                            allText.includes('Access-Control-Allow-Origin') ||
                            allText.includes('has been blocked by cors policy') ||
                            allText.includes('has been blocked by CORS policy') ||
                            allText.includes('no \'access-control-allow-origin\' header') ||
                            allText.includes('No \'Access-Control-Allow-Origin\' header') ||
                            allText.includes('same origin policy') ||
                            allText.includes('networkerror when attempting to fetch resource') ||
                            allText.includes('networkerror') ||
                            allText.includes('failed to fetch') ||
                            allText.includes('ERR_FAILED') ||
                            (allText.includes('cors') && allText.includes('header')))) {
                        return; // Suppress - handled by integration layer with user-friendly messages
                    }

                    // Suppress Tailwind CDN CORS errors - CDN not used in production
                    if (allText.includes('cdn.tailwindcss.com') &&
                        (allText.includes('cors') ||
                            allText.includes('access-control-allow-origin') ||
                            allText.includes('blocked by cors policy') ||
                            allText.includes('fetch') ||
                            allText.includes('503') ||
                            allText.includes('service unavailable') ||
                            allText.includes('failed to load resource'))) {
                        return; // Suppress - Tailwind CDN removed, using local styles.css
                    }

                    // Suppress runtime.lastError from Chrome extensions
                    if (allText.includes('runtime.lasterror') ||
                        allText.includes('unchecked runtime.lasterror') ||
                        allText.includes('could not establish connection') ||
                        allText.includes('receiving end does not exist') ||
                        allText.includes('message port closed')) {
                        return; // Suppress - Chrome extension communication errors
                    }

                    // Suppress 503 errors from CDN and external resources
                    if ((allText.includes('503') || allText.includes('service unavailable')) &&
                        (allText.includes('cdn.tailwindcss.com') ||
                            allText.includes('tile.openstreetmap.org') ||
                            allText.includes('openstreetmap') ||
                            allText.includes('cdn.') ||
                            allText.includes('tile.') ||
                            allText.includes('arcgisonline.com') ||
                            allText.includes('server.arcgisonline.com') ||
                            allText.includes('opentopomap.org') ||
                            allText.includes('tile.opentopomap.org') ||
                            allText.includes('tile.openstreetmap.fr') ||
                            allText.includes('openstreetmap.fr') ||
                            allText.includes('fonts.googleapis.com') ||
                            allText.includes('fonts.gstatic.com') ||
                            allText.includes('cairo') ||
                            allText.includes('css2?family'))) {
                        return; // Suppress - these are handled by fallback mechanisms
                    }

                    // Suppress certificate errors from Google services
                    if ((allText.includes('err_cert_authority_invalid') ||
                            allText.includes('cert_authority_invalid') ||
                            allText.includes('certificate') ||
                            allText.includes('cert authority')) &&
                        (allText.includes('googleusercontent.com') ||
                            allText.includes('script.google.com') ||
                            allText.includes('google.com') ||
                            allText.includes('googleapis.com'))) {
                        return; // Suppress - certificate issues are handled gracefully
                    }

                    // Suppress NetworkError from OpenStreetMap tiles
                    if (allText.includes('networkerror') &&
                        (allText.includes('tile.openstreetmap.org') ||
                            allText.includes('openstreetmap'))) {
                        return; // Suppress - map tiles have fallback handling
                    }

                    originalError.apply(console, args);
                };
            }

            // Suppress network errors for Microsoft Aria Collector and Google services
            if (typeof window.addEventListener !== 'undefined') {
                window.addEventListener('error', function (e) {
                    const target = e.target;
                    if (target && target.src) {
                        const src = String(target.src || '').toLowerCase();
                        
                        // Suppress Microsoft Aria Collector errors
                        if (src.includes('browser.pipe.aria.microsoft.com') ||
                            src.includes('aria.microsoft.com') ||
                            src.includes('collector/3.0')) {
                            e.preventDefault();
                            e.stopPropagation();
                            e.stopImmediatePropagation();
                            return false;
                        }
                        
                        // Suppress Google Fonts errors (fallback fonts will be used)
                        if (src.includes('fonts.googleapis.com') ||
                            src.includes('fonts.gstatic.com') ||
                            (src.includes('cairo') && (src.includes('woff') || src.includes('ttf')))) {
                            e.preventDefault();
                            e.stopPropagation();
                            e.stopImmediatePropagation();
                            return false;
                        }
                        
                        // Suppress certificate errors from Google services
                        const message = String(e.message || '').toLowerCase();
                        if ((src.includes('googleusercontent.com') ||
                             src.includes('script.google.com') ||
                             src.includes('googleapis.com')) &&
                            (message.includes('cert') || 
                             message.includes('certificate') ||
                             message.includes('ssl') ||
                             message.includes('tls'))) {
                            e.preventDefault();
                            e.stopPropagation();
                            e.stopImmediatePropagation();
                            return false;
                        }
                    }
                }, true);
            }
        })();
    </script>

    <!-- Early Chrome Extension Error Suppression - Must run FIRST -->
    <script>
        (function () {
            'use strict';

            // Suppress Chrome extension errors BEFORE anything else
            if (typeof chrome !== 'undefined' && chrome.runtime) {
                try {
                    // Intercept chrome.runtime.lastError immediately
                    const originalLastError = chrome.runtime.lastError;
                    Object.defineProperty(chrome.runtime, 'lastError', {
                        get: function () {
                            try {
                                const error = originalLastError;
                                if (error && error.message) {
                                    const msg = String(error.message || '').toLowerCase();
                                    // Catch all variations of extension errors
                                    if (msg.includes('message port closed') ||
                                        msg.includes('message channel closed') ||
                                        msg.includes('asynchronous response') ||
                                        msg.includes('receiving end does not exist') ||
                                        msg.includes('could not establish connection') ||
                                        msg.includes('extension context invalidated') ||
                                        msg.includes('the message port closed before a response was received')) {
                                        return null;
                                    }
                                }
                                return error;
                            } catch (e) {
                                return null;
                            }
                        },
                        configurable: true,
                        enumerable: true
                    });
                } catch (e) {
                    // Silently fail if we can't intercept
                }
            }

            // Global error handler for Chrome extension errors - runs immediately
            window.addEventListener('error', function (e) {
                const filename = (e.filename || e.source || e.target?.src || e.path?.[0]?.src || '').toLowerCase();
                const message = (e.message || '').toLowerCase();
                const errorStr = filename + ' ' + message;

                // Check error object properties
                const errorObj = e.error || {};
                const errorStack = (errorObj.stack || '').toLowerCase();
                const errorMsg = (errorObj.message || '').toLowerCase();
                const fullErrorStr = errorStr + ' ' + errorStack + ' ' + errorMsg;

                // Also check the original error string representation and name
                const errorToString = (errorObj.toString && errorObj.toString()) || '';
                const errorName = (errorObj.name || '').toLowerCase();
                const completeErrorStr = fullErrorStr + ' ' + errorToString.toLowerCase() + ' ' + errorName;
                
                // ✅ Quick check شامل ومحسّن for uploadmanager.js:518 errors - MUST BE FIRST!
                if (filename.includes('uploadmanager') || 
                    filename.includes('upload-manager') ||
                    filename.includes('extension://') && (filename.includes('upload') || filename.includes('manager')) ||
                    /uploadmanager\.js/i.test(filename) ||
                    /uploadmanager\.js:518/i.test(filename) ||
                    /uploadmanager\.js:\d+/i.test(filename) ||
                    /uploadmanager\.js:\d+:\d+/i.test(filename) ||
                    message.includes('uploadmanager') ||
                    message.includes('upload-manager') ||
                    errorStack.includes('uploadmanager') ||
                    errorStack.includes('uploadmanager.js:518') ||
                    errorStack.includes('uploadmanager.js') ||
                    (message.includes('cannot read properties of undefined') && 
                     (message.includes('document') || message.includes('reading') || errorStack.includes('htmlstyleelement') || errorStack.includes('svgsvgelement') || errorStack.includes('htmlimageelement'))) ||
                    (message.includes('cannot read property') && message.includes('document') && (errorStack.includes('uploadmanager') || filename.includes('upload') || filename.includes('extension'))) ||
                    (message.includes('uncaught typeerror') && message.includes('cannot read') && message.includes('document') && (errorStack.includes('uploadmanager') || filename.includes('upload') || filename.includes('extension'))) ||
                    (completeErrorStr.includes('uploadmanager') && 
                     (completeErrorStr.includes('518') || completeErrorStr.includes('htmlstyleelement') || completeErrorStr.includes('htmlimageelement') || completeErrorStr.includes('document') || completeErrorStr.includes('anonymous'))) ||
                    (completeErrorStr.includes('htmlstyleelement') && completeErrorStr.includes('anonymous') && (completeErrorStr.includes('uploadmanager') || completeErrorStr.includes('518') || filename.includes('upload') || filename.includes('extension')))) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    return false; // قمع فوري - لا نسمح بتمرير الخطأ
                }

                // Suppress CORS and 503 errors for Tailwind CDN, API backend, and file storage
                if ((message.includes('cdn.tailwindcss.com') || 
                     message.includes('script.google.com') ||
                     message.includes('google.com/macros') ||
                     message.includes('drive.google.com') ||
                     filename.includes('drive.google.com')) && (
                    message.includes('cors') ||
                    message.includes('access-control-allow-origin') ||
                    message.includes('503') ||
                    message.includes('service unavailable') ||
                    message.includes('blocked by cors policy') ||
                    message.includes('has been blocked by cors policy') ||
                    message.includes('no \'access-control-allow-origin\' header') ||
                    message.includes('403') ||
                    message.includes('forbidden')
                )) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    return false;
                }
                
                // Suppress CORS errors for API backend specifically
                if ((filename.includes('script.google.com') ||
                     filename.includes('google.com/macros') ||
                     message.includes('script.google.com') ||
                     message.includes('google.com/macros')) && (
                    message.includes('cors') ||
                    message.includes('access-control-allow-origin') ||
                    message.includes('blocked by cors policy') ||
                    message.includes('has been blocked by cors policy') ||
                    message.includes('no \'access-control-allow-origin\' header') ||
                    errorStack.includes('cors') ||
                    errorStack.includes('access-control-allow-origin')
                )) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    return false;
                }

                // Suppress 503 errors from OpenStreetMap tiles and other map tile servers
                if ((filename.includes('tile.openstreetmap.org') ||
                    filename.includes('arcgisonline.com') ||
                    filename.includes('opentopomap.org') ||
                    filename.includes('tile.openstreetmap.fr') ||
                    message.includes('tile.openstreetmap.org') ||
                    message.includes('arcgisonline.com') ||
                    message.includes('opentopomap.org') ||
                    message.includes('tile.openstreetmap.fr') ||
                    errorStack.includes('tile.openstreetmap.org') ||
                    errorStack.includes('arcgisonline.com') ||
                    errorStack.includes('opentopomap.org') ||
                    errorStack.includes('tile.openstreetmap.fr')) &&
                    (message.includes('503') ||
                        message.includes('service unavailable') ||
                        message.includes('failed to load') ||
                        message.includes('networkerror'))) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    return false;
                }

                // Suppress 503 errors from any external CDN/resources
                if ((message.includes('503') || message.includes('service unavailable')) &&
                    (filename.includes('cdn.') ||
                        filename.includes('tile.') ||
                        filename.includes('openstreetmap') ||
                        filename.includes('arcgisonline.com') ||
                        filename.includes('opentopomap.org') ||
                        filename.includes('tailwindcss') ||
                        errorStack.includes('cdn.') ||
                        errorStack.includes('tile.') ||
                        errorStack.includes('arcgisonline.com') ||
                        errorStack.includes('opentopomap.org'))) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    return false;
                }

                // Suppress errors from script tags loading Tailwind CDN
                if (e.target && e.target.tagName === 'SCRIPT' && e.target.src && (
                    e.target.src.includes('cdn.tailwindcss.com') ||
                    e.target.src.includes('tailwindcss')
                )) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    return false;
                }

                // Suppress CORS console errors for API backend (handled by application code)
                // These are logged by the browser but handled gracefully by the fetch error handler
                if ((message.includes('script.google.com') ||
                    message.includes('google.com/macros') ||
                    message.includes('Google Sheets') ||
                    message.includes('supabase.co') ||
                    filename.includes('script.google.com') ||
                    filename.includes('supabase.co') ||
                    errorStack.includes('script.google.com') ||
                    errorStack.includes('supabase.co') ||
                    completeErrorStr.includes('script.google.com') ||
                    completeErrorStr.includes('supabase.co')) &&
                    (message.includes('cors') ||
                        message.includes('cross-origin request blocked') ||
                        message.includes('access-control-allow-origin') ||
                        message.includes('Access-Control-Allow-Origin') ||
                        message.includes('same origin policy') ||
                        message.includes('Same Origin Policy') ||
                        message.includes('CORS header') ||
                        message.includes('CORS policy') ||
                        message.includes('has been blocked by CORS policy') ||
                        message.includes('No \'Access-Control-Allow-Origin\' header') ||
                        message.includes('NetworkError when attempting to fetch resource') ||
                        message.includes('NetworkError') ||
                        message.includes('Failed to fetch') ||
                        message.includes('ERR_FAILED'))) {
                    // Don't prevent default, but suppress console noise
                    // The actual error is handled in integration layer with user-friendly messages
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    return false;
                }

                // Check filename for extension files - enhanced pattern matching
                if (filename.includes('uploadmanager') ||
                    filename.includes('upload-manager') ||
                    filename.includes('uploadmanager.js') ||
                    filename.includes('extension://') ||
                    filename.includes('chrome-extension://') ||
                    filename.includes('moz-extension://') ||
                    filename.includes('safari-extension://') ||
                    filename.includes('edge-extension://') ||
                    /uploadmanager\.js:\d+/.test(filename)) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    return false;
                }

                // Check message for uploadmanager errors - enhanced patterns including 'reading' keyword
                if (message.includes('uploadmanager') ||
                    message.includes('upload-manager') ||
                    (message.includes('cannot read properties of undefined') && (message.includes('document') || message.includes('reading') || message.includes('\'document\''))) ||
                    (message.includes('cannot read property') && message.includes('document')) ||
                    (message.includes('htmlstyleelement') && (message.includes('document') || message.includes('anonymous'))) ||
                    (message.includes('svgsvgelement') && (message.includes('document') || message.includes('anonymous'))) ||
                    (message.includes('reading') && message.includes('document') && message.includes('undefined')) ||
                    // Specific pattern: HTMLStyleElement.<anonymous> (uploadmanager.js:518:80)
                    (message.includes('htmlstyleelement') && message.includes('anonymous') && /uploadmanager\.js:\d+/.test(message)) ||
                    // Specific pattern: SVGSVGElement.<anonymous> (uploadmanager.js:518:80)
                    (message.includes('svgsvgelement') && message.includes('anonymous') && /uploadmanager\.js:\d+/.test(message)) ||
                    // Check for uploadmanager.js:518 specifically
                    (/uploadmanager\.js:518/.test(message))) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    return false;
                }

                // Check error stack for uploadmanager - enhanced patterns
                if (errorStack.includes('uploadmanager') ||
                    errorStack.includes('upload-manager') ||
                    errorStack.includes('uploadmanager.js') ||
                    (errorStack.includes('cannot read properties of undefined') && (errorStack.includes('document') || errorStack.includes('reading') || errorStack.includes('\'document\''))) ||
                    (errorStack.includes('htmlstyleelement') && (errorStack.includes('document') || errorStack.includes('anonymous'))) ||
                    (errorStack.includes('svgsvgelement') && (errorStack.includes('document') || errorStack.includes('anonymous'))) ||
                    (errorStack.includes('reading') && errorStack.includes('document') && errorStack.includes('undefined')) ||
                    /uploadmanager\.js:\d+/.test(errorStack) ||
                    // Check for uploadmanager.js:518 specifically
                    (/uploadmanager\.js:518/.test(errorStack)) ||
                    // قمع أخطاء HTMLStyleElement مع document من أي مصدر extension
                    (errorStack.includes('htmlstyleelement') && (errorStack.includes('reading') || errorStack.includes('document'))) ||
                    // قمع أخطاء SVGSVGElement مع document من أي مصدر extension
                    (errorStack.includes('svgsvgelement') && (errorStack.includes('reading') || errorStack.includes('document'))) ||
                    // Specific pattern: HTMLStyleElement.<anonymous> (uploadmanager.js:518:80)
                    (errorStack.includes('htmlstyleelement') && errorStack.includes('anonymous') && /uploadmanager\.js:\d+/.test(errorStack)) ||
                    // Specific pattern: SVGSVGElement.<anonymous> (uploadmanager.js:518:80)
                    (errorStack.includes('svgsvgelement') && errorStack.includes('anonymous') && /uploadmanager\.js:\d+/.test(errorStack))) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    return false;
                }

                // Suppress Microsoft Aria Collector network errors
                if (e.target && e.target.src && (
                    e.target.src.includes('browser.pipe.aria.microsoft.com') ||
                    e.target.src.includes('aria.microsoft.com') ||
                    e.target.src.includes('Collector/3.0')
                )) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    return false;
                }

                // Suppress ERR_BLOCKED_BY_CLIENT errors from Microsoft Aria Collector
                if (message.includes('err_blocked_by_client') ||
                    message.includes('failed to load resource') && (
                        filename.includes('browser.pipe.aria.microsoft.com') ||
                        filename.includes('aria.microsoft.com') ||
                        filename.includes('collector/3.0') ||
                        errorStack.includes('browser.pipe.aria.microsoft.com') ||
                        errorStack.includes('aria.microsoft.com')
                    )) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    return false;
                }

                // Check combined string - enhanced patterns
                if (errorStr.includes('uploadmanager') ||
                    errorStr.includes('upload-manager') ||
                    (errorStr.includes('cannot read properties of undefined') && (errorStr.includes('document') || errorStr.includes('reading') || errorStr.includes('\'document\''))) ||
                    (errorStr.includes('htmlstyleelement') && (errorStr.includes('document') || errorStr.includes('anonymous'))) ||
                    fullErrorStr.includes('uploadmanager') ||
                    fullErrorStr.includes('upload-manager') ||
                    fullErrorStr.includes('uploadmanager.js') ||
                    (fullErrorStr.includes('cannot read properties of undefined') && (fullErrorStr.includes('document') || fullErrorStr.includes('reading') || fullErrorStr.includes('\'document\''))) ||
                    (fullErrorStr.includes('htmlstyleelement') && (fullErrorStr.includes('document') || fullErrorStr.includes('anonymous'))) ||
                    completeErrorStr.includes('uploadmanager') ||
                    completeErrorStr.includes('upload-manager') ||
                    completeErrorStr.includes('uploadmanager.js') ||
                    (completeErrorStr.includes('cannot read properties of undefined') && (completeErrorStr.includes('document') || completeErrorStr.includes('reading') || completeErrorStr.includes('\'document\''))) ||
                    (completeErrorStr.includes('htmlstyleelement') && (completeErrorStr.includes('document') || completeErrorStr.includes('anonymous'))) ||
                    /uploadmanager\.js:\d+/.test(completeErrorStr) ||
                    // Microsoft Aria Collector errors
                    errorStr.includes('browser.pipe.aria.microsoft.com') ||
                    errorStr.includes('aria.microsoft.com') ||
                    errorStr.includes('err_blocked_by_client') ||
                    fullErrorStr.includes('browser.pipe.aria.microsoft.com') ||
                    fullErrorStr.includes('aria.microsoft.com') ||
                    completeErrorStr.includes('browser.pipe.aria.microsoft.com') ||
                    completeErrorStr.includes('aria.microsoft.com')) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    return false;
                }

                // Suppress translator extension errors
                if (filename.includes('translator.js') ||
                    filename.includes('moz-extension://') && message.includes('translator') ||
                    (message.includes("can't access property") && message.includes('getElementById') && message.includes('is null')) ||
                    (message.includes("cannot read property") && message.includes('getElementById') && message.includes('null')) ||
                    (errorStack.includes('translator.js') && (errorStack.includes('getElementById') || errorStack.includes('style')))) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    return false;
                }

                // Original checks for other extension errors
                if (message.includes('unchecked runtime.lasterror') ||
                    message.includes('runtime.lasterror') ||
                    message.includes('could not establish connection') ||
                    message.includes('receiving end does not exist') ||
                    message.includes('the message port closed before a response was received') ||
                    message.includes('message port closed') ||
                    message.includes('message channel closed') ||
                    message.includes('extension context invalidated')) {
                    e.preventDefault();
                    e.stopPropagation();
                    return false;
                }
            }, true); // Use capture phase to catch early

            // ✅ Handle unhandled promise rejections from extensions (محسّن)
            window.addEventListener('unhandledrejection', function (e) {
                const reason = e.reason;
                if (reason) {
                    const reasonStr = String(
                        (typeof reason === 'string' ? reason : (reason.message || reason.toString() || ''))
                    ).toLowerCase();
                    const reasonStack = (reason.stack || '').toLowerCase();
                    const reasonName = (reason.name || '').toLowerCase();
                    const completeReason = (reasonStr + ' ' + reasonStack + ' ' + reasonName).toLowerCase();
                    
                    // ✅ فحص شامل لأخطاء uploadmanager (محسّن)
                    if (reasonStr.includes('runtime.lasterror') ||
                        reasonStr.includes('could not establish connection') ||
                        reasonStr.includes('receiving end does not exist') ||
                        reasonStr.includes('the message port closed before a response was received') ||
                        reasonStr.includes('message port closed') ||
                        reasonStr.includes('extension context invalidated') ||
                        reasonStr.includes('uploadmanager') ||
                        reasonStr.includes('upload-manager') ||
                        reasonStack.includes('uploadmanager') ||
                        reasonStack.includes('uploadmanager.js') ||
                        reasonStack.includes('uploadmanager.js:518') ||
                        completeReason.includes('uploadmanager') ||
                        completeReason.includes('upload-manager') ||
                        /uploadmanager\.js/i.test(completeReason) ||
                        /uploadmanager\.js:518/i.test(completeReason) ||
                        (completeReason.includes('htmlstyleelement') && completeReason.includes('uploadmanager')) ||
                        (completeReason.includes('cannot read properties') && completeReason.includes('document') && completeReason.includes('upload'))) {
                        e.preventDefault();
                        e.stopPropagation();
                        e.stopImmediatePropagation();
                        return false; // قمع فوري - لا نسمح بتمرير الخطأ
                    }
                }
            }, true);

            // Early console.error override to catch uploadmanager errors
            if (typeof console !== 'undefined' && console.error) {
                const originalConsoleError = console.error;
                console.error = function (...args) {
                    // Check all arguments for uploadmanager errors
                    let shouldSuppress = false;
                    let combinedStr = '';

                    for (let i = 0; i < args.length; i++) {
                        const arg = args[i];
                        let argStr = '';

                        if (typeof arg === 'string') {
                            argStr = arg.toLowerCase();
                            combinedStr += argStr + ' ';
                        } else if (arg && typeof arg === 'object') {
                            if (arg.message) {
                                const msg = String(arg.message).toLowerCase();
                                argStr += msg + ' ';
                                combinedStr += msg + ' ';
                            }
                            if (arg.stack) {
                                const stack = String(arg.stack).toLowerCase();
                                argStr += stack + ' ';
                                combinedStr += stack + ' ';
                            }
                            if (arg.name) {
                                const name = String(arg.name).toLowerCase();
                                argStr += name + ' ';
                                combinedStr += name + ' ';
                            }
                            if (arg.toString) {
                                const str = String(arg.toString()).toLowerCase();
                                argStr += str + ' ';
                                combinedStr += str + ' ';
                            }
                            // Also stringify the whole object to catch nested properties
                            try {
                                const objStr = JSON.stringify(arg).toLowerCase();
                                argStr += objStr + ' ';
                                combinedStr += objStr + ' ';
                            } catch (e) {
                                // Ignore JSON stringify errors
                            }
                        } else {
                            argStr = String(arg || '').toLowerCase();
                            combinedStr += argStr + ' ';
                        }

                        // Enhanced pattern matching including regex for line numbers
                        if (argStr.includes('uploadmanager') ||
                            argStr.includes('upload-manager') ||
                            argStr.includes('uploadmanager.js') ||
                            /uploadmanager\.js:\d+/.test(argStr) ||
                            (argStr.includes('cannot read properties of undefined') && (argStr.includes('document') || argStr.includes('reading') || argStr.includes('\'document\''))) ||
                            (argStr.includes('cannot read property') && argStr.includes('document')) ||
                            (argStr.includes('htmlstyleelement') && (argStr.includes('document') || argStr.includes('anonymous'))) ||
                            (argStr.includes('htmlimageelement') && (argStr.includes('document') || argStr.includes('anonymous'))) ||
                            (argStr.includes('svgsvgelement') && (argStr.includes('document') || argStr.includes('anonymous'))) ||
                            (argStr.includes('reading') && argStr.includes('document') && argStr.includes('undefined')) ||
                            (argStr.includes('uncaught typeerror') && argStr.includes('document') && argStr.includes('undefined')) ||
                            // Specific pattern: HTMLStyleElement.<anonymous> (uploadmanager.js:518:80)
                            (argStr.includes('htmlstyleelement') && argStr.includes('anonymous') && /uploadmanager\.js:\d+/.test(argStr)) ||
                            // Specific pattern: HTMLImageElement.<anonymous> (uploadmanager.js:518:80)
                            (argStr.includes('htmlimageelement') && argStr.includes('anonymous') && /uploadmanager\.js:\d+/.test(argStr)) ||
                            // Specific pattern: SVGSVGElement.<anonymous> (uploadmanager.js:518:80)
                            (argStr.includes('svgsvgelement') && argStr.includes('anonymous') && /uploadmanager\.js:\d+/.test(argStr)) ||
                            // Check for uploadmanager.js:518 specifically
                            (/uploadmanager\.js:518/.test(argStr)) ||
                            // Microsoft Aria Collector errors
                            argStr.includes('browser.pipe.aria.microsoft.com') ||
                            argStr.includes('aria.microsoft.com') ||
                            argStr.includes('err_blocked_by_client') ||
                            argStr.includes('collector/3.0')) {
                            shouldSuppress = true;
                            break;
                        }
                    }

                    // Also check combined string for patterns that might span multiple arguments
                    if (!shouldSuppress && combinedStr) {
                        if (combinedStr.includes('uploadmanager') ||
                            combinedStr.includes('upload-manager') ||
                            combinedStr.includes('uploadmanager.js') ||
                            /uploadmanager\.js:\d+/.test(combinedStr) ||
                            (combinedStr.includes('cannot read properties of undefined') && (combinedStr.includes('document') || combinedStr.includes('reading') || combinedStr.includes('\'document\''))) ||
                            (combinedStr.includes('htmlstyleelement') && (combinedStr.includes('document') || combinedStr.includes('anonymous'))) ||
                            (combinedStr.includes('htmlimageelement') && (combinedStr.includes('document') || combinedStr.includes('anonymous'))) ||
                            (combinedStr.includes('reading') && combinedStr.includes('document') && combinedStr.includes('undefined')) ||
                            (combinedStr.includes('uncaught typeerror') && combinedStr.includes('document') && combinedStr.includes('undefined')) ||
                            // Microsoft Aria Collector errors
                            combinedStr.includes('browser.pipe.aria.microsoft.com') ||
                            combinedStr.includes('aria.microsoft.com') ||
                            combinedStr.includes('err_blocked_by_client')) {
                            shouldSuppress = true;
                        }
                    }

                    if (!shouldSuppress) {
                        originalConsoleError.apply(console, args);
                    }
                };
            }
        })();
    </script>

    <!-- تعطيل جميع رسائل Console -->
    <script>
        (function () {
            'use strict';
            // حفظ وظائف console الأصلية (في حالة الحاجة لها لاحقاً)
            window._originalConsole = {
                log: console.log,
                error: console.error,
                warn: console.warn,
                info: console.info,
                debug: console.debug,
                trace: console.trace,
                dir: console.dir,
                dirxml: console.dirxml,
                group: console.group,
                groupCollapsed: console.groupCollapsed,
                groupEnd: console.groupEnd,
                time: console.time,
                timeEnd: console.timeEnd,
                assert: console.assert,
                profile: console.profile
            };

            // Enhanced console.error suppression for Chrome extension errors
            const originalError = console.error;
            console.error = function (...args) {
                if (args.length > 0) {
                    let errorText = '';
                    let hasUploadManager = false;
                    let hasDocumentError = false;
                    let hasHTMLStyleElement = false;

                    // Comprehensive check of all arguments
                    for (let i = 0; i < args.length; i++) {
                        const arg = args[i];
                        let argText = '';

                        if (typeof arg === 'string') {
                            argText = arg.toLowerCase();
                            errorText += argText + ' ';
                        } else if (typeof arg === 'object' && arg !== null) {
                            // Check stack trace
                            if (arg.stack) {
                                const stack = String(arg.stack).toLowerCase();
                                argText += stack + ' ';
                                errorText += stack + ' ';
                                if (stack.includes('uploadmanager') || stack.includes('upload-manager') || /uploadmanager\.js:\d+/.test(stack)) {
                                    hasUploadManager = true;
                                }
                                if (stack.includes('htmlstyleelement') || stack.includes('svgsvgelement')) {
                                    hasHTMLStyleElement = true;
                                }
                                if (stack.includes('cannot read properties of undefined') && (stack.includes('document') || stack.includes('reading'))) {
                                    hasDocumentError = true;
                                }
                            }
                            // Check message
                            if (arg.message) {
                                const msg = String(arg.message).toLowerCase();
                                argText += msg + ' ';
                                errorText += msg + ' ';
                                if (msg.includes('uploadmanager') || msg.includes('upload-manager')) {
                                    hasUploadManager = true;
                                }
                                if (msg.includes('htmlstyleelement') || msg.includes('svgsvgelement')) {
                                    hasHTMLStyleElement = true;
                                }
                                if (msg.includes('cannot read properties of undefined') && (msg.includes('document') || msg.includes('reading'))) {
                                    hasDocumentError = true;
                                }
                            }
                            // Stringify object
                            try {
                                const objStr = JSON.stringify(arg);
                                argText += objStr + ' ';
                                errorText += objStr + ' ';
                            } catch (e) {
                                argText += String(arg) + ' ';
                                errorText += String(arg) + ' ';
                            }
                        } else {
                            argText = String(arg || '').toLowerCase();
                            errorText += argText + ' ';
                        }
                    }

                    errorText = errorText.toLowerCase();

                    // Check for uploadmanager errors first - comprehensive patterns
                    if (errorText.includes('uploadmanager') ||
                        errorText.includes('upload-manager') ||
                        errorText.includes('uploadmanager.js') ||
                        /uploadmanager\.js:\d+/.test(errorText) ||
                        (errorText.includes('cannot read properties of undefined') && (errorText.includes('document') || errorText.includes('reading') || errorText.includes('\'document\''))) ||
                        (errorText.includes('cannot read property') && errorText.includes('document')) ||
                        (errorText.includes('htmlstyleelement') && (errorText.includes('document') || errorText.includes('anonymous'))) ||
                        (errorText.includes('svgsvgelement') && (errorText.includes('document') || errorText.includes('anonymous'))) ||
                        (errorText.includes('reading') && errorText.includes('document') && errorText.includes('undefined')) ||
                        // Specific pattern: HTMLStyleElement.<anonymous> (uploadmanager.js:518:80)
                        (errorText.includes('htmlstyleelement') && errorText.includes('anonymous') && /uploadmanager\.js:\d+/.test(errorText)) ||
                        // Specific pattern: SVGSVGElement.<anonymous> (uploadmanager.js:518:80)
                        (errorText.includes('svgsvgelement') && errorText.includes('anonymous') && /uploadmanager\.js:\d+/.test(errorText)) ||
                        // Check for uploadmanager.js:518 specifically
                        (/uploadmanager\.js:518/.test(errorText))) {
                        return; // Suppress uploadmanager errors
                    }

                    // Suppress Microsoft Aria Collector errors (ERR_BLOCKED_BY_CLIENT)
                    if (errorText.includes('browser.pipe.aria.microsoft.com') ||
                        errorText.includes('aria.microsoft.com') ||
                        errorText.includes('err_blocked_by_client') ||
                        errorText.includes('collector/3.0') ||
                        (errorText.includes('failed to load resource') && errorText.includes('microsoft'))) {
                        return; // Suppress - blocked by ad blockers, not a real error
                    }

                    // Check for Chrome extension error patterns
                    if (errorText.includes('unchecked runtime.lasterror') ||
                        errorText.includes('runtime.lasterror') ||
                        errorText.includes('could not establish connection') ||
                        errorText.includes('receiving end does not exist') ||
                        errorText.includes('the message port closed before a response was received') ||
                        errorText.includes('message port closed') ||
                        errorText.includes('message channel closed') ||
                        errorText.includes('extension context invalidated')) {
                        return; // Suppress these errors
                    }

                    // Suppress API/backend NetworkError (Sheets or Supabase)
                    if ((errorText.includes('google sheets') ||
                        errorText.includes('script.google.com') ||
                        errorText.includes('google.com/macros')) &&
                        (errorText.includes('networkerror when attempting to fetch resource') ||
                            errorText.includes('networkerror') ||
                            errorText.includes('failed to fetch') ||
                            errorText.includes('cors') ||
                            errorText.includes('cross-origin'))) {
                        return; // Suppress - handled by integration layer
                    }

                    // Suppress 503 errors from CDN and external resources
                    if ((errorText.includes('503') || errorText.includes('service unavailable')) &&
                        (errorText.includes('cdn.tailwindcss.com') ||
                            errorText.includes('tile.openstreetmap.org') ||
                            errorText.includes('openstreetmap') ||
                            errorText.includes('cdn.') ||
                            errorText.includes('tile.') ||
                            errorText.includes('fonts.googleapis.com') ||
                            errorText.includes('fonts.gstatic.com') ||
                            errorText.includes('cairo') ||
                            errorText.includes('css2?family'))) {
                        return; // Suppress - handled by fallback mechanisms
                    }

                    // Suppress certificate errors from Google services
                    if ((errorText.includes('err_cert_authority_invalid') ||
                            errorText.includes('cert_authority_invalid') ||
                            errorText.includes('certificate') ||
                            errorText.includes('cert authority')) &&
                        (errorText.includes('googleusercontent.com') ||
                            errorText.includes('script.google.com') ||
                            errorText.includes('google.com') ||
                            errorText.includes('googleapis.com'))) {
                        return; // Suppress - certificate issues are handled gracefully
                    }

                    // Suppress NetworkError from OpenStreetMap tiles
                    if (errorText.includes('networkerror') &&
                        (errorText.includes('tile.openstreetmap.org') ||
                            errorText.includes('openstreetmap'))) {
                        return; // Suppress - map tiles have fallback handling
                    }
                }
                originalError.apply(console, args);
            };

            // Enhanced console.warn suppression - شامل لـ Tracking Prevention
            const originalWarn = console.warn;
            console.warn = function (...args) {
                if (args.length > 0) {
                    const errorText = args.map(arg => String(arg || '')).join(' ').toLowerCase();

                    // قمع Tracking Prevention messages بشكل شامل - أولوية عالية
                    if (errorText.includes('tracking prevention') ||
                        errorText.includes('blocked access to storage') ||
                        (errorText.includes('tracking prevention') && errorText.includes('cdn.')) ||
                        (errorText.includes('tracking prevention') && errorText.includes('jsdelivr')) ||
                        (errorText.includes('tracking prevention') && errorText.includes('npm')) ||
                        (errorText.includes('tracking prevention') && errorText.includes('xlsx')) ||
                        (errorText.includes('tracking prevention') && errorText.includes('jspdf')) ||
                        (errorText.includes('tracking prevention') && errorText.includes('qrcode')) ||
                        (errorText.includes('tracking prevention') && errorText.includes('jsqr'))) {
                        return; // قمع Tracking Prevention
                    }
                    
                    // قمع تحذيرات Permissions Policy Violation
                    if (errorText.includes('permissions policy violation') ||
                        errorText.includes('permission policy violation') ||
                        errorText.includes('[violation]') ||
                        (errorText.includes('violation') && errorText.includes('camera')) ||
                        (errorText.includes('violation') && errorText.includes('microphone')) ||
                        (errorText.includes('violation') && errorText.includes('not allowed'))) {
                        return; // قمع التحذير - تم إضافة Permissions-Policy في meta tag
                    }

                    // Suppress Chrome extension errors
                    if (errorText.includes('unchecked runtime.lasterror') ||
                        errorText.includes('runtime.lasterror') ||
                        errorText.includes('could not establish connection') ||
                        errorText.includes('receiving end does not exist') ||
                        errorText.includes('the message port closed before a response was received') ||
                        errorText.includes('message port closed')) {
                        return; // Suppress these warnings
                    }

                    // Suppress CDN loading warnings (they're handled by fallback mechanisms)
                    if (errorText.includes('failed to load') && (
                        errorText.includes('xlsx') ||
                        errorText.includes('jspdf') ||
                        errorText.includes('qrcode') ||
                        errorText.includes('jsqr') ||
                        errorText.includes('tailwind') ||
                        errorText.includes('cdn') ||
                        errorText.includes('404')
                    )) {
                        return; // Suppress CDN loading warnings
                    }

                    // Suppress 503 warnings from external resources
                    if ((errorText.includes('503') || errorText.includes('service unavailable')) &&
                        (errorText.includes('cdn.tailwindcss.com') ||
                            errorText.includes('tile.openstreetmap.org') ||
                            errorText.includes('openstreetmap') ||
                            errorText.includes('cdn.') ||
                            errorText.includes('tile.'))) {
                        return; // Suppress - handled by fallback mechanisms
                    }

                    // Suppress OpaqueResponseBlocking warnings
                    if (errorText.includes('OpaqueResponseBlocking') ||
                        errorText.includes('opaque response') ||
                        errorText.includes('opaque-response') ||
                        errorText.includes('blocked by OpaqueResponseBlocking')) {
                        return; // Suppress - handled by service worker
                    }
                    
                    // Suppress Manifest warnings (property ignored, URL is invalid)
                    // These can appear when manifest is loaded from blob URLs (which browsers don't support)
                    if (errorText.includes('manifest') && (
                        (errorText.includes('property') && errorText.includes('ignored') && (errorText.includes('url is invalid') || errorText.includes('url') || errorText.includes('invalid'))) ||
                        (errorText.includes('start_url') && (errorText.includes('ignored') || errorText.includes('invalid'))) ||
                        (errorText.includes('src') && errorText.includes('ignored') && errorText.includes('manifest')) ||
                        (errorText.includes('manifest') && errorText.includes('blob:') && (errorText.includes('ignored') || errorText.includes('invalid'))) ||
                        (errorText.includes('manifest') && errorText.includes('property') && errorText.includes('ignored'))
                    )) {
                        return; // Suppress manifest warnings
                    }
                    
                    // Suppress "deferred DOM Node" warnings
                    if (errorText.includes('deferred dom node') ||
                        errorText.includes('could not be resolved to a valid node') ||
                        (errorText.includes('deferred') && errorText.includes('dom') && errorText.includes('node'))) {
                        return; // Suppress - framework-level warning, usually harmless
                    }
                    
                    // استخدام النظام الشامل إذا كان متاحاً
                    if (window.UniversalErrorHandler && 
                        window.UniversalErrorHandler.shouldSuppress(errorText, '', '')) {
                        return;
                    }
                }
                originalWarn.apply(console, args);
            };

            // تعطيل باقي وظائف console
            const noop = function () { };
            console.log = noop;
            console.info = noop;
            console.debug = noop;
            console.trace = noop;
            console.dir = noop;
            console.dirxml = noop;
            console.group = noop;
            console.groupCollapsed = noop;
            console.groupEnd = noop;
            console.time = noop;
            console.timeEnd = noop;
            console.assert = noop;
            console.profile = noop;

            // لتفعيل console مرة أخرى (إذا لزم الأمر)، استخدم:
            // Object.assign(console, window._originalConsole);
        })();
    </script>

    <!-- Favicon - Company Logo -->
    <!-- Default favicon (will be updated dynamically from company settings) -->
    <link rel="icon" type="image/png" sizes="16x16" href="./icons/icon-16x16.png" id="favicon-16">
    <link rel="icon" type="image/png" sizes="32x32" href="./icons/icon-32x32.png" id="favicon-32">
    <link rel="icon" type="image/png" sizes="48x48" href="./icons/icon-48x48.png">
    <link rel="icon" type="image/png" sizes="72x72" href="./icons/icon-72x72.png">
    <link rel="icon" type="image/png" sizes="96x96" href="./icons/icon-96x96.png">
    <link rel="icon" type="image/png" sizes="128x128" href="./icons/icon-128x128.png">
    <link rel="icon" type="image/png" sizes="144x144" href="./icons/icon-144x144.png">
    <link rel="icon" type="image/png" sizes="152x152" href="./icons/icon-152x152.png">
    <link rel="icon" type="image/png" sizes="192x192" href="./icons/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="384x384" href="./icons/icon-384x384.png">
    <link rel="icon" type="image/png" sizes="512x512" href="./icons/icon-512x512.png">
    <link rel="shortcut icon" href="./icons/icon-32x32.png" id="favicon-shortcut">
    <link rel="apple-touch-icon" sizes="180x180" href="./icons/icon-180x180.png" id="favicon-apple">
    <!-- Script to update favicon dynamically from company logo -->
    <script>
        // Function to update favicon and PWA icons from company logo
        function updateFaviconFromCompanyLogo(logoUrl) {
            if (!logoUrl) return;

            try {
                // Create a canvas to convert the logo to favicon and PWA icon sizes
                const img = new Image();
                // Set crossOrigin based on URL - some file hosts don't support CORS
                if (logoUrl.includes('drive.google.com') || logoUrl.includes('googleusercontent.com')) {
                    img.crossOrigin = null;
                } else {
                    img.crossOrigin = 'anonymous';
                }

                img.onload = function () {
                    // Create canvas for different sizes - including PWA icons
                    const sizes = [
                        { size: 16, id: 'favicon-16', rel: 'icon' },
                        { size: 32, id: 'favicon-32', rel: 'icon' },
                        { size: 48, id: 'favicon-48', rel: 'icon' },
                        { size: 72, id: 'favicon-72', rel: 'icon' },
                        { size: 96, id: 'favicon-96', rel: 'icon' },
                        { size: 128, id: 'favicon-128', rel: 'icon' },
                        { size: 144, id: 'favicon-144', rel: 'icon' },
                        { size: 152, id: 'favicon-152', rel: 'icon' },
                        { size: 180, id: 'favicon-apple', rel: 'apple-touch-icon' },
                        { size: 192, id: 'favicon-192', rel: 'icon' }, // PWA icon
                        { size: 384, id: 'favicon-384', rel: 'icon' },
                        { size: 512, id: 'favicon-512', rel: 'icon' } // PWA icon
                    ];

                    sizes.forEach(({ size, id, rel }) => {
                        const canvas = document.createElement('canvas');
                        canvas.width = size;
                        canvas.height = size;
                        const ctx = canvas.getContext('2d');

                        // Draw the logo on canvas with proper scaling
                        ctx.drawImage(img, 0, 0, size, size);

                        // Convert to data URL
                        const dataUrl = canvas.toDataURL('image/png');

                        // Update or create the icon link
                        let link = document.getElementById(id);
                        if (!link) {
                            link = document.createElement('link');
                            link.id = id;
                            link.rel = rel;
                            link.type = 'image/png';
                            if (rel === 'apple-touch-icon') {
                                link.setAttribute('sizes', size + 'x' + size);
                            } else {
                                link.setAttribute('sizes', size + 'x' + size);
                            }
                            document.head.appendChild(link);
                        }

                        link.href = dataUrl;
                    });

                    // Update shortcut icon (use 32x32 size)
                    let shortcutLink = document.getElementById('favicon-shortcut');
                    if (!shortcutLink) {
                        shortcutLink = document.createElement('link');
                        shortcutLink.id = 'favicon-shortcut';
                        shortcutLink.rel = 'shortcut icon';
                        document.head.appendChild(shortcutLink);
                    }
                    // Get the 32x32 data URL
                    const size32Canvas = document.createElement('canvas');
                    size32Canvas.width = 32;
                    size32Canvas.height = 32;
                    const size32Ctx = size32Canvas.getContext('2d');
                    size32Ctx.drawImage(img, 0, 0, 32, 32);
                    shortcutLink.href = size32Canvas.toDataURL('image/png');

                    // Update manifest.json dynamically with PWA icons
                    updateManifestIcons(img);
                };

                // Function to update manifest.json icons dynamically
                function updateManifestIcons(img) {
                    try {
                        // Create PWA icons (192x192 and 512x512) - Chrome requires these for installation
                        const pwaSizes = [192, 512];
                        const iconDataUrls = {}; // Store data URLs for manifest
                        const iconBlobUrls = {}; // Store blob URLs for DOM links
                        let iconsCreated = 0;

                        pwaSizes.forEach(size => {
                            const canvas = document.createElement('canvas');
                            canvas.width = size;
                            canvas.height = size;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, size, size);
                            
                            // Convert to data URL for manifest (browsers don't support blob URLs in manifests)
                            const dataUrl = canvas.toDataURL('image/png');
                            iconDataUrls[size] = dataUrl;
                            
                            // Also create blob URL for DOM icon links (better performance)
                            canvas.toBlob(function(blob) {
                                if (blob) {
                                    const blobUrl = URL.createObjectURL(blob);
                                    iconBlobUrls[size] = blobUrl;
                                    iconsCreated++;
                                    
                                    // Update or create PWA icon link in DOM
                                    const iconId = `pwa-icon-${size}`;
                                    let iconLink = document.getElementById(iconId);
                                    if (!iconLink) {
                                        iconLink = document.createElement('link');
                                        iconLink.id = iconId;
                                        iconLink.rel = 'icon';
                                        iconLink.type = 'image/png';
                                        iconLink.setAttribute('sizes', `${size}x${size}`);
                                        iconLink.setAttribute('purpose', 'any maskable');
                                        document.head.appendChild(iconLink);
                                    }
                                    iconLink.href = blobUrl;
                                    
                                    // Also update existing icon links if they exist
                                    const existingLinks = document.querySelectorAll(`link[rel="icon"][sizes="${size}x${size}"]`);
                                    existingLinks.forEach(link => {
                                        if (link.id !== iconId) {
                                            link.href = blobUrl;
                                        }
                                    });

                                    // When all icons are created, update manifest.json
                                    if (iconsCreated === pwaSizes.length) {
                                        updateManifestWithIcons(iconDataUrls, iconBlobUrls);
                                    }
                                }
                            }, 'image/png');
                        });
                    } catch (error) {
                        console.warn('Error updating manifest icons:', error);
                    }
                }

                // Function to update manifest.json with new icon URLs
                async function updateManifestWithIcons(iconDataUrls, iconBlobUrls) {
                    try {
                        let manifest = null;
                        const isFileProtocol = (typeof window !== 'undefined' && (window.location.protocol === 'file:' || window.location.origin === 'null'));
                        if (!isFileProtocol) {
                            const isLocalHost = (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1');
                            if (isLocalHost) return;
                            const manifestPaths = ['/Frontend/manifest.json', 'manifest.json', './manifest.json'];
                            for (const path of manifestPaths) {
                                try {
                                    const response = await fetch(path);
                                    if (response.ok) {
                                        manifest = await response.json();
                                        break;
                                    }
                                } catch (e) {
                                    continue;
                                }
                            }
                        }
                        if (!manifest) {
                            // If we can't fetch manifest, create a minimal one
                            manifest = {
                                "name": "Americana HSE Management System",
                                "short_name": "HSE System",
                                "display": "standalone",
                                "start_url": "/Frontend/",
                                "icons": []
                            };
                        }

                        // Ensure start_url is a valid relative path (not absolute with origin)
                        // Browsers don't support blob URLs for manifests, so we keep the original manifest.json
                        if (manifest.start_url) {
                            // Ensure it starts with / for relative path
                            if (!manifest.start_url.startsWith('/') && !manifest.start_url.startsWith('http')) {
                                manifest.start_url = '/' + manifest.start_url;
                            }
                        } else {
                            // Default to relative path
                            manifest.start_url = "/Frontend/";
                        }

                        // Helper function to validate data URL format
                        const isValidDataUrl = function(url) {
                            if (!url || typeof url !== 'string') {
                                return false;
                            }
                            // Validate data URL format: data:image/png;base64,...
                            return url.startsWith('data:image/') && url.includes(';base64,');
                        };
                        
                        // Update icon URLs in manifest with data URLs (browsers don't support blob URLs in manifests)
                        // Priority: 192x192 and 512x512 (required by Chrome)
                        if (manifest.icons && Array.isArray(manifest.icons)) {
                            manifest.icons.forEach(icon => {
                                if (!icon.sizes) return; // Skip icons without sizes
                                const sizeMatch = icon.sizes.match(/(\d+)x\d+/);
                                if (sizeMatch) {
                                    const size = parseInt(sizeMatch[1]);
                                    if (iconDataUrls[size] && isValidDataUrl(iconDataUrls[size])) {
                                        icon.src = iconDataUrls[size];
                                    }
                                }
                            });
                            
                            // Add new icons if they don't exist
                            [192, 512].forEach(size => {
                                if (iconDataUrls[size] && isValidDataUrl(iconDataUrls[size])) {
                                    const exists = manifest.icons.some(icon => {
                                        const sizeMatch = icon.sizes && icon.sizes.match(/(\d+)x\d+/);
                                        return sizeMatch && parseInt(sizeMatch[1]) === size;
                                    });
                                    if (!exists) {
                                        manifest.icons.push({
                                            src: iconDataUrls[size],
                                            sizes: `${size}x${size}`,
                                            type: 'image/png',
                                            purpose: 'any maskable'
                                        });
                                    }
                                }
                            });
                        } else {
                            // If no icons array, create one
                            manifest.icons = [];
                            [192, 512].forEach(size => {
                                if (iconDataUrls[size] && isValidDataUrl(iconDataUrls[size])) {
                                    manifest.icons.push({
                                        src: iconDataUrls[size],
                                        sizes: `${size}x${size}`,
                                        type: 'image/png',
                                        purpose: 'any maskable'
                                    });
                                }
                            });
                        }
                        
                        // Validate all icons have valid src (data URLs, http/https, or relative paths)
                        if (manifest.icons && Array.isArray(manifest.icons)) {
                            manifest.icons = manifest.icons.filter(icon => {
                                if (!icon.src || typeof icon.src !== 'string') {
                                    return false;
                                }
                                // Accept data URLs, http/https URLs, absolute paths, or relative paths
                                // Reject blob URLs (not supported in manifests)
                                if (icon.src.startsWith('blob:')) {
                                    return false; // Blob URLs are not valid in manifests
                                }
                                return icon.src.startsWith('data:') || 
                                       icon.src.startsWith('http') || 
                                       icon.src.startsWith('/') ||
                                       icon.src.startsWith('./');
                            });
                        }

                        // IMPORTANT: Do NOT create a blob URL for the manifest
                        // Browsers don't support blob URLs in manifest properties (start_url, icon src)
                        // Keep using the original manifest.json file
                        // We'll update the icons in the original manifest file instead
                        // Note: Since we can't write to the file system, we'll store the updated manifest
                        // in localStorage and use it when needed, but keep the original manifest link

                        // Store updated manifest in memory for reference
                        window._pwaManifestData = manifest;
                        
                        // Store icon data URLs and blob URLs
                        window._pwaIconDataUrls = iconDataUrls;
                        window._pwaIconBlobUrls = iconBlobUrls;
                        
                        // Note: The manifest link will continue to point to the original manifest.json
                        // The icons with data URLs will be available in window._pwaManifestData if needed
                        // For PWA installation, browsers will use the original manifest.json file
                        
                        // Trigger a custom event to notify that icons are updated
                        window.dispatchEvent(new CustomEvent('pwaIconsUpdated', {
                            detail: { iconDataUrls, iconBlobUrls, manifestUpdated: true }
                        }));
                    } catch (error) {
                        console.warn('Error updating manifest.json:', error);
                    }
                }

                img.onerror = function () {
                    // قمع رسائل الخطأ لروابط الملفات التي لا تدعم CORS
                    // هذا أمر طبيعي ولا يؤثر على وظائف التطبيق
                    // الشعار سيستخدم القيمة الافتراضية
                };
                
                img.src = logoUrl;
            } catch (error) {
                console.warn('Error updating favicon:', error);
            }
        }

        // Update favicon when page loads if company logo exists in localStorage
        document.addEventListener('DOMContentLoaded', function () {
            const savedLogo = localStorage.getItem('company_logo');
            if (savedLogo) {
                updateFaviconFromCompanyLogo(savedLogo);
            }
        });

        // Listen for changes to company logo in localStorage
        window.addEventListener('storage', function (e) {
            if (e.key === 'company_logo') {
                updateFaviconFromCompanyLogo(e.newValue);
            }
        });

        // Also listen for custom events (for same-window updates)
        window.addEventListener('companyLogoUpdated', function (e) {
            if (e.detail && e.detail.logoUrl) {
                updateFaviconFromCompanyLogo(e.detail.logoUrl);
            }
        });

        // معالجة أخطاء إضافات المتصفح (مثل Google Translate)
        // هذا يمنع أخطاء إضافات المتصفح من التأثير على التطبيق
        window.addEventListener('error', function (e) {
            const filename = (e.filename || e.source || e.target?.src || e.path?.[0]?.src || '').toLowerCase();
            const message = (e.message || '').toLowerCase();
            const errorStr = (filename + ' ' + message).toLowerCase();

            // Check error object properties
            const errorObj = e.error || {};
            const errorStack = (errorObj.stack || '').toLowerCase();
            const errorMsg = (errorObj.message || '').toLowerCase();
            const errorToString = (errorObj.toString && errorObj.toString()) || '';
            const errorName = (errorObj.name || '').toLowerCase();
            const fullErrorStr = errorStr + ' ' + errorStack + ' ' + errorMsg + ' ' + errorToString.toLowerCase() + ' ' + errorName;

            // ✅ تجاهل أخطاء إضافات المتصفح - فحص شامل مع regex للأنماط
            if (filename && (
                filename.includes('translator.js') ||
                filename.includes('translate_http.js') ||
                filename.includes('content_script.js') ||
                filename.includes('uploadmanager.js') ||
                filename.includes('upload-manager') ||
                filename.includes('uploadmanager') ||
                filename.includes('extension://') ||
                filename.includes('chrome-extension://') ||
                filename.includes('moz-extension://') ||
                filename.includes('safari-extension://') ||
                filename.includes('edge-extension://') ||
                /uploadmanager\.js:\d+/.test(filename) ||
                /uploadmanager\.js:518/.test(filename)
            )) {
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();
                return false;
            }

            // ✅ فحص رسالة الخطأ نفسها - أنماط محسّنة وشاملة
            if (message && (
                message.includes('uploadmanager') ||
                message.includes('upload-manager') ||
                (message.includes('cannot read properties of undefined') && (message.includes('document') || message.includes('reading') || message.includes('\'document\''))) ||
                (message.includes('cannot read property') && message.includes('document')) ||
                (message.includes('htmlstyleelement') && (message.includes('document') || message.includes('anonymous') || message.includes('uploadmanager') || message.includes('upload-manager'))) ||
                (message.includes('htmlimageelement') && (message.includes('document') || message.includes('anonymous') || message.includes('uploadmanager') || message.includes('upload-manager'))) ||
                (message.includes('svgsvgelement') && (message.includes('document') || message.includes('anonymous') || message.includes('uploadmanager'))) ||
                (message.includes('reading') && message.includes('document') && message.includes('undefined')) ||
                // Specific pattern: HTMLStyleElement.<anonymous> (uploadmanager.js:518:80)
                (message.includes('htmlstyleelement') && message.includes('anonymous') && /uploadmanager\.js:\d+/.test(message)) ||
                // Specific pattern: HTMLImageElement.<anonymous> (uploadmanager.js:518:80)
                (message.includes('htmlimageelement') && message.includes('anonymous') && /uploadmanager\.js:\d+/.test(message)) ||
                (message.includes('518') && (message.includes('uploadmanager') || message.includes('upload-manager')))
            )) {
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();
                return false;
            }

            // ✅ فحص stack trace - شامل
            if (errorStack && (
                errorStack.includes('uploadmanager') ||
                errorStack.includes('upload-manager') ||
                errorStack.includes('uploadmanager.js') ||
                (errorStack.includes('cannot read properties of undefined') && (errorStack.includes('document') || errorStack.includes('reading') || errorStack.includes('\'document\''))) ||
                (errorStack.includes('htmlstyleelement') && (errorStack.includes('document') || errorStack.includes('anonymous') || errorStack.includes('uploadmanager'))) ||
                (errorStack.includes('htmlimageelement') && (errorStack.includes('document') || errorStack.includes('anonymous') || errorStack.includes('uploadmanager'))) ||
                (errorStack.includes('svgsvgelement') && (errorStack.includes('document') || errorStack.includes('anonymous') || errorStack.includes('uploadmanager'))) ||
                /uploadmanager\.js:\d+/.test(errorStack) ||
                /uploadmanager\.js:518/.test(errorStack) ||
                // Specific pattern: HTMLStyleElement.<anonymous> (uploadmanager.js:518:80)
                (errorStack.includes('htmlstyleelement') && errorStack.includes('anonymous') && /uploadmanager\.js:\d+/.test(errorStack)) ||
                // Specific pattern: HTMLImageElement.<anonymous> (uploadmanager.js:518:80)
                (errorStack.includes('htmlimageelement') && errorStack.includes('anonymous') && /uploadmanager\.js:\d+/.test(errorStack)) ||
                (errorStack.includes('518') && (errorStack.includes('uploadmanager') || errorStack.includes('upload-manager')))
            )) {
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();
                return false;
            }

            // Suppress Microsoft Aria Collector network errors
            if (e.target && e.target.src && (
                e.target.src.includes('browser.pipe.aria.microsoft.com') ||
                e.target.src.includes('aria.microsoft.com') ||
                e.target.src.includes('Collector/3.0')
            )) {
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();
                return false;
            }

            // Suppress ERR_BLOCKED_BY_CLIENT errors from Microsoft Aria Collector
            if (message.includes('err_blocked_by_client') ||
                (message.includes('failed to load resource') && (
                    filename.includes('browser.pipe.aria.microsoft.com') ||
                    filename.includes('aria.microsoft.com') ||
                    filename.includes('collector/3.0') ||
                    errorStack.includes('browser.pipe.aria.microsoft.com') ||
                    errorStack.includes('aria.microsoft.com')
                ))) {
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();
                return false;
            }

            // ✅ فحص شامل للنص الكامل - أنماط محسّنة وشاملة
            if (errorStr.includes('uploadmanager') ||
                errorStr.includes('upload-manager') ||
                (errorStr.includes('cannot read properties of undefined') && (errorStr.includes('document') || errorStr.includes('reading') || errorStr.includes('\'document\''))) ||
                (errorStr.includes('cannot read property') && errorStr.includes('document')) ||
                (errorStr.includes('htmlstyleelement') && (errorStr.includes('document') || errorStr.includes('anonymous') || errorStr.includes('uploadmanager'))) ||
                (errorStr.includes('htmlimageelement') && (errorStr.includes('document') || errorStr.includes('anonymous') || errorStr.includes('uploadmanager'))) ||
                (errorStr.includes('svgsvgelement') && (errorStr.includes('document') || errorStr.includes('anonymous') || errorStr.includes('uploadmanager'))) ||
                fullErrorStr.includes('uploadmanager') ||
                fullErrorStr.includes('upload-manager') ||
                fullErrorStr.includes('uploadmanager.js') ||
                (fullErrorStr.includes('cannot read properties of undefined') && (fullErrorStr.includes('document') || fullErrorStr.includes('reading') || fullErrorStr.includes('\'document\''))) ||
                (fullErrorStr.includes('htmlstyleelement') && (fullErrorStr.includes('document') || fullErrorStr.includes('anonymous') || fullErrorStr.includes('uploadmanager'))) ||
                (fullErrorStr.includes('htmlimageelement') && (fullErrorStr.includes('document') || fullErrorStr.includes('anonymous') || fullErrorStr.includes('uploadmanager'))) ||
                (fullErrorStr.includes('svgsvgelement') && (fullErrorStr.includes('document') || fullErrorStr.includes('anonymous') || fullErrorStr.includes('uploadmanager'))) ||
                /uploadmanager\.js:\d+/.test(fullErrorStr) ||
                /uploadmanager\.js:518/.test(fullErrorStr) ||
                // Microsoft Aria Collector errors
                errorStr.includes('browser.pipe.aria.microsoft.com') ||
                errorStr.includes('aria.microsoft.com') ||
                errorStr.includes('err_blocked_by_client') ||
                fullErrorStr.includes('browser.pipe.aria.microsoft.com') ||
                fullErrorStr.includes('aria.microsoft.com')) {
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();
                return false;
            }

            // تجاهل أخطاء محددة من إضافات المتصفح
            if (message && (
                message.includes("can't access property") ||
                message.includes("Cannot read property 'style'") ||
                message.includes("Cannot read properties of null") ||
                message.includes("getElementById(...) is null") ||
                message.includes("can't access property \"style\"") ||
                (message.includes("style") && message.includes("null"))
            ) && filename && (
                    filename.includes('translator') ||
                    filename.includes('translate') ||
                    filename.includes('extension') ||
                    filename.includes('uploadmanager') ||
                    filename.includes('translator.js')
                )) {
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();
                return false;
            }

            // معالجة خاصة لخطأ translator.js:275:20
            if (filename && filename.includes('translator.js') && (
                message.includes("style") ||
                message.includes("getElementById") ||
                message.includes("null")
            )) {
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();
                return false;
            }
        }, true);

        // معالجة أخطاء Promise غير المعالجة من إضافات المتصفح
        window.addEventListener('unhandledrejection', function (e) {
            if (e.reason && (
                String(e.reason).includes('translator') ||
                String(e.reason).includes('translate') ||
                String(e.reason).includes('extension') ||
                String(e.reason).includes('uploadmanager') ||
                String(e.reason).includes("can't access property") ||
                String(e.reason).includes("Cannot read property") ||
                (e.reason && typeof e.reason === 'object' && e.reason.message && (
                    e.reason.message.includes('uploadmanager') ||
                    (e.reason.message.includes('Cannot read properties of undefined') && e.reason.message.includes('document'))
                ))
            )) {
                e.preventDefault();
            }
        });
    </script>

    <!-- Preconnect for performance -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <!-- Removed Tailwind CDN preconnect - not meant for production, causes CORS errors -->
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">

    <!-- Tailwind CSS -->
    <!-- Note: Tailwind CDN removed - not meant for production, causes CORS errors -->
    <!-- Using local styles.css which contains all necessary Tailwind-like utilities -->
    <!-- For production with full Tailwind: npm install -D tailwindcss postcss autoprefixer && npx tailwindcss init -->
    <!-- Suppress CDN warning in console -->
    <script>
        // Suppress Tailwind CDN warning and other non-critical warnings - شامل لـ Tracking Prevention
        const originalWarn = console.warn;
        console.warn = function (...args) {
            if (args.length > 0) {
                const firstArg = String(args[0] || '');
                const allArgs = args.map(arg => String(arg || '')).join(' ').toLowerCase();
                
                // قمع Tracking Prevention messages بشكل شامل - أولوية عالية
                if (allArgs.includes('tracking prevention') ||
                    allArgs.includes('blocked access to storage') ||
                    (allArgs.includes('tracking prevention') && allArgs.includes('cdn.')) ||
                    (allArgs.includes('tracking prevention') && allArgs.includes('jsdelivr')) ||
                    (allArgs.includes('tracking prevention') && allArgs.includes('npm')) ||
                    (allArgs.includes('tracking prevention') && allArgs.includes('xlsx')) ||
                    (allArgs.includes('tracking prevention') && allArgs.includes('jspdf')) ||
                    (allArgs.includes('tracking prevention') && allArgs.includes('qrcode')) ||
                    (allArgs.includes('tracking prevention') && allArgs.includes('jsqr'))) {
                    return; // قمع Tracking Prevention
                }

                // تجاهل تحذيرات Tailwind CDN
                if (firstArg.includes('cdn.tailwindcss.com') || allArgs.includes('tailwind')) {
                    return;
                }

                // تجاهل تحذيرات Font Awesome Glyph bbox (غير حرجة)
                if (firstArg.includes('Glyph bbox') ||
                    firstArg.includes('downloadable font') ||
                    firstArg.includes('fa-brands-400')) {
                    return;
                }

                // تجاهل أخطاء تحميل الخطوط (غير حرجة - سيتم استخدام الخطوط الاحتياطية)
                if (firstArg.includes('.woff2') ||
                    (firstArg.includes('Failed to load resource') && allArgs.includes('font')) ||
                    (firstArg.includes('net::ERR_FAILED') && allArgs.includes('font')) ||
                    (firstArg.includes('font') && firstArg.includes('error')) ||
                    allArgs.includes('fonts.googleapis.com') ||
                    allArgs.includes('fonts.gstatic.com') ||
                    (allArgs.includes('cairo') && (allArgs.includes('503') || allArgs.includes('failed') || allArgs.includes('error'))) ||
                    (allArgs.includes('css2?family') && (allArgs.includes('503') || allArgs.includes('failed') || allArgs.includes('error')))) {
                    return;
                }

                // تجاهل تحذيرات تحميل المكتبات من CDN (يتم التعامل معها تلقائياً)
                if (allArgs.includes('failed to load') && (
                    allArgs.includes('xlsx') ||
                    allArgs.includes('jspdf') ||
                    allArgs.includes('qrcode') ||
                    allArgs.includes('jsqr') ||
                    allArgs.includes('cdn') ||
                    allArgs.includes('404')
                )) {
                    return;
                }
            }
            originalWarn.apply(console, args);
        };

        // Handle Chrome extension runtime.lastError - Enhanced version
        (function () {
            'use strict';

            // قمع أخطاء Chrome Extensions بشكل شامل ومبكر
            if (typeof chrome !== 'undefined' && chrome.runtime) {
                try {
                    // إعادة تعريف chrome.runtime.lastError لمنع الأخطاء
                    let lastErrorValue = null;
                    const originalLastError = chrome.runtime.lastError;

                    Object.defineProperty(chrome.runtime, 'lastError', {
                        get: function () {
                            try {
                                const error = originalLastError;
                                if (error && error.message) {
                                    const msg = String(error.message || '').toLowerCase();
                                    if (msg.includes('message port closed') ||
                                        msg.includes('message channel closed') ||
                                        msg.includes('asynchronous response') ||
                                        msg.includes('receiving end does not exist') ||
                                        msg.includes('could not establish connection') ||
                                        msg.includes('extension context invalidated') ||
                                        msg.includes('the message port closed before a response was received')) {
                                        return null; // تجاهل هذه الأخطاء
                                    }
                                }
                                return error;
                            } catch (e) {
                                return null;
                            }
                        },
                        set: function (value) {
                            lastErrorValue = value;
                        },
                        configurable: true,
                        enumerable: true
                    });
                } catch (e) {
                    // إذا فشل إعادة التعريف، نتجاهل
                }

                // قمع أخطاء runtime.lastError في console.error
                const originalError = console.error;
                console.error = function (...args) {
                    if (args.length > 0) {
                        const firstArg = String(args[0] || '');
                        const allArgs = args.map(arg => {
                            if (typeof arg === 'object' && arg !== null) {
                                try {
                                    return JSON.stringify(arg);
                                } catch (e) {
                                    return String(arg);
                                }
                            }
                            return String(arg || '');
                        }).join(' ').toLowerCase();

                        const firstArgLower = firstArg.toLowerCase();

                        // فحص شامل لجميع المعاملات بما في ذلك stack traces
                        let hasUploadManager = false;
                        let hasDocumentError = false;

                        for (let i = 0; i < args.length; i++) {
                            const arg = args[i];
                            if (arg && typeof arg === 'object') {
                                // فحص stack trace
                                if (arg.stack) {
                                    const stack = String(arg.stack).toLowerCase();
                                    if (stack.includes('uploadmanager') || stack.includes('upload-manager') || stack.includes('uploadmanager.js')) {
                                        hasUploadManager = true;
                                    }
                                    if (stack.includes('cannot read properties of undefined') && stack.includes('document')) {
                                        hasDocumentError = true;
                                    }
                                    if (stack.includes('htmlstyleelement') && stack.includes('document')) {
                                        hasDocumentError = true;
                                    }
                                }
                                // فحص message
                                if (arg.message) {
                                    const msg = String(arg.message).toLowerCase();
                                    if (msg.includes('uploadmanager') || msg.includes('upload-manager')) {
                                        hasUploadManager = true;
                                    }
                                    if (msg.includes('cannot read properties of undefined') && msg.includes('document')) {
                                        hasDocumentError = true;
                                    }
                                    if (msg.includes('htmlstyleelement') && msg.includes('document')) {
                                        hasDocumentError = true;
                                    }
                                }
                            }
                        }

                        if (firstArgLower.includes('unchecked runtime.lasterror') ||
                            firstArgLower.includes('runtime.lasterror') ||
                            firstArgLower.includes('message port closed') ||
                            firstArgLower.includes('message channel closed') ||
                            firstArgLower.includes('asynchronous response') ||
                            firstArgLower.includes('receiving end does not exist') ||
                            firstArgLower.includes('translator.js') ||
                            firstArgLower.includes('translate_http.js') ||
                            firstArgLower.includes('can\'t access property') ||
                            firstArgLower.includes('cannot read property') ||
                            firstArgLower.includes('cannot read properties of undefined') ||
                            firstArgLower.includes('reading') ||
                            firstArgLower.includes('uploadmanager') ||
                            firstArgLower.includes('upload-manager') ||
                            firstArgLower.includes('htmlstyleelement') ||
                            firstArgLower.includes('getelementbyid(...) is null') ||
                            firstArgLower.includes('can\'t access property "style"') ||
                            (firstArgLower.includes('style') && firstArgLower.includes('null')) ||
                            hasUploadManager ||
                            hasDocumentError ||
                            (hasHTMLStyleElement && hasDocumentError) ||
                            allArgs.includes('translator.js') ||
                            allArgs.includes('uploadmanager') ||
                            allArgs.includes('upload-manager') ||
                            allArgs.includes('uploadmanager.js') ||
                            allArgs.includes('translator') ||
                            allArgs.includes('translate_http.js') ||
                            (allArgs.includes('htmlstyleelement') && (allArgs.includes('document') || allArgs.includes('anonymous'))) ||
                            firstArgLower.includes('could not establish connection') ||
                            firstArgLower.includes('the message port closed before a response was received') ||
                            firstArgLower.includes('permissions policy violation') ||
                            firstArgLower.includes('permission policy violation') ||
                            firstArgLower.includes('[violation]') ||
                            (firstArgLower.includes('violation') && firstArgLower.includes('camera')) ||
                            (firstArgLower.includes('violation') && firstArgLower.includes('not allowed')) ||
                            allArgs.includes('unchecked runtime.lasterror') ||
                            allArgs.includes('runtime.lasterror') ||
                            allArgs.includes('message port closed') ||
                            allArgs.includes('message channel closed') ||
                            allArgs.includes('asynchronous response') ||
                            allArgs.includes('the message port closed before a response was received') ||
                            hasUploadManager ||
                            (hasDocumentError && (allArgs.includes('uploadmanager') || allArgs.includes('upload-manager') || allArgs.includes('uploadmanager.js'))) ||
                            // Microsoft Aria Collector errors
                            firstArgLower.includes('browser.pipe.aria.microsoft.com') ||
                            firstArgLower.includes('aria.microsoft.com') ||
                            firstArgLower.includes('err_blocked_by_client') ||
                            allArgs.includes('browser.pipe.aria.microsoft.com') ||
                            allArgs.includes('aria.microsoft.com') ||
                            allArgs.includes('err_blocked_by_client') ||
                            allArgs.includes('collector/3.0') ||
                            allArgs.includes('permissions policy violation') ||
                            allArgs.includes('permission policy violation') ||
                            allArgs.includes('[violation]') ||
                            (allArgs.includes('violation') && allArgs.includes('camera')) ||
                            (allArgs.includes('violation') && allArgs.includes('not allowed'))) {
                            return; // تجاهل هذه الأخطاء
                        }
                    }
                    originalError.apply(console, args);
                };

                // قمع أخطاء runtime.lastError في console.warn أيضاً - شامل لـ Tracking Prevention
                const originalWarn = console.warn;
                console.warn = function (...args) {
                    if (args.length > 0) {
                        const firstArg = String(args[0] || '').toLowerCase();
                        const allArgs = args.map(arg => String(arg || '')).join(' ').toLowerCase();

                        // قمع Tracking Prevention messages بشكل شامل - أولوية عالية
                        if (firstArg.includes('tracking prevention') ||
                            firstArg.includes('blocked access to storage') ||
                            allArgs.includes('tracking prevention') ||
                            allArgs.includes('blocked access to storage') ||
                            (allArgs.includes('tracking prevention') && allArgs.includes('cdn.')) ||
                            (allArgs.includes('tracking prevention') && allArgs.includes('jsdelivr')) ||
                            (allArgs.includes('tracking prevention') && allArgs.includes('npm')) ||
                            (allArgs.includes('tracking prevention') && allArgs.includes('xlsx')) ||
                            (allArgs.includes('tracking prevention') && allArgs.includes('jspdf')) ||
                            (allArgs.includes('tracking prevention') && allArgs.includes('qrcode')) ||
                            (allArgs.includes('tracking prevention') && allArgs.includes('jsqr'))) {
                            return; // قمع Tracking Prevention
                        }

                        // قمع أخطاء Chrome Extensions
                        if (firstArg.includes('unchecked runtime.lasterror') ||
                            firstArg.includes('runtime.lasterror') ||
                            firstArg.includes('message port closed') ||
                            firstArg.includes('the message port closed before a response was received') ||
                            allArgs.includes('unchecked runtime.lasterror') ||
                            allArgs.includes('runtime.lasterror') ||
                            allArgs.includes('message port closed') ||
                            allArgs.includes('the message port closed before a response was received')) {
                            return; // تجاهل هذه الأخطاء
                        }

                        // قمع تحذيرات تحميل المكتبات من CDN
                        if (allArgs.includes('failed to load') && (
                            allArgs.includes('xlsx') ||
                            allArgs.includes('jspdf') ||
                            allArgs.includes('qrcode') ||
                            allArgs.includes('jsqr') ||
                            allArgs.includes('tailwind') ||
                            allArgs.includes('cdn') ||
                            allArgs.includes('404')
                        )) {
                            return; // تجاهل تحذيرات CDN
                        }
                    }
                    originalWarn.apply(console, args);
                };
            }
        })();

        // Suppress source map loading errors and CSP violations - Enhanced version
        window.addEventListener('error', function (e) {
            if (e.message) {
                const msgLower = String(e.message || '').toLowerCase();
                if (msgLower.includes('.map') ||
                    msgLower.includes('sourcemap') ||
                    msgLower.includes('content security policy') ||
                    msgLower.includes('frame-ancestors') ||
                    msgLower.includes('unchecked runtime.lasterror') ||
                    msgLower.includes('runtime.lasterror') ||
                    msgLower.includes('message port closed') ||
                    msgLower.includes('message channel closed') ||
                    msgLower.includes('asynchronous response') ||
                    msgLower.includes('receiving end does not exist') ||
                    msgLower.includes('could not establish connection') ||
                    msgLower.includes('the message port closed before a response was received')) {
                    e.preventDefault();
                    return false;
                }
            }

            // Suppress 404, 503, CORS errors for CDN resources (they're handled by fallback)
            if (e.target && (
                (e.target.tagName === 'SCRIPT' && (
                    e.target.src.includes('xlsx') ||
                    e.target.src.includes('jspdf') ||
                    e.target.src.includes('qrcode') ||
                    e.target.src.includes('jsqr') ||
                    e.target.src.includes('tailwindcss') ||
                    e.target.src.includes('cdn.tailwindcss.com')
                )) ||
                (e.target.tagName === 'LINK' && e.target.href && (
                    e.target.href.includes('tailwindcss') ||
                    e.target.href.includes('cdn.tailwindcss.com')
                )) ||
                (e.target.tagName === 'IMG' && e.target.src && (
                    e.target.src.includes('tile.openstreetmap.org') ||
                    e.target.src.includes('openstreetmap') ||
                    e.target.src.includes('drive.google.com')
                ))
            )) {
                e.preventDefault();
                e.stopPropagation();
                return false;
            }

            // Suppress CORS errors for Tailwind CDN, API backend, and file storage
            if (e.message && (
                (e.message.includes('cdn.tailwindcss.com') && e.message.includes('CORS')) ||
                (e.message.includes('cdn.tailwindcss.com') && e.message.includes('Access-Control-Allow-Origin')) ||
                (e.message.includes('cdn.tailwindcss.com') && (e.message.includes('503') || e.message.includes('Service Unavailable'))) ||
                (e.message.includes('script.google.com') && e.message.includes('CORS')) ||
                (e.message.includes('script.google.com') && e.message.includes('Access-Control-Allow-Origin')) ||
                (e.message.includes('Access-Control-Allow-Origin') && e.message.includes('script.google.com')) ||
                (e.message.includes('drive.google.com') && (e.message.includes('CORS') || e.message.includes('Access-Control-Allow-Origin') || e.message.includes('blocked'))) ||
                (e.message.includes('Access to image') && e.message.includes('drive.google.com'))
            )) {
                e.preventDefault();
                e.stopPropagation();
                return false;
            }

            // Suppress 503 errors from OpenStreetMap tiles and other external resources
            if (e.target && e.target.src && (
                e.target.src.includes('tile.openstreetmap.org') ||
                e.target.src.includes('openstreetmap') ||
                e.target.src.includes('arcgisonline.com') ||
                e.target.src.includes('opentopomap.org') ||
                e.target.src.includes('tile.openstreetmap.fr')
            ) && (
                    e.message && (e.message.includes('503') ||
                        e.message.includes('Service Unavailable') ||
                        e.message.includes('Failed to load') ||
                        e.message.includes('NetworkError'))
                )) {
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();
                return false;
            }

            // Suppress OpaqueResponseBlocking errors for local images
            if (e.message && (
                e.message.includes('OpaqueResponseBlocking') ||
                e.message.includes('opaque response') ||
                e.message.includes('opaque-response')
            )) {
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();
                return false;
            }
        }, true);

        // Suppress unhandled promise rejections from Chrome Extensions - Enhanced version
        // Suppress font loading errors
        window.addEventListener('error', function (event) {
            if (event.target && (
                event.target.tagName === 'LINK' && event.target.rel === 'stylesheet' ||
                (event.target.tagName === 'LINK' && event.target.href && event.target.href.includes('font')) ||
                (event.filename && event.filename.includes('.woff2'))
            )) {
                // Font loading errors are non-critical - fallback fonts will be used
                event.preventDefault();
                return false;
            }
        }, true);

        window.addEventListener('unhandledrejection', function (event) {
            const reason = event.reason;
            if (reason) {
                let reasonStr = '';
                if (typeof reason === 'string') {
                    reasonStr = reason.toLowerCase();
                } else if (reason.message) {
                    reasonStr = String(reason.message || '').toLowerCase();
                } else {
                    try {
                        reasonStr = JSON.stringify(reason).toLowerCase();
                    } catch (e) {
                        reasonStr = String(reason).toLowerCase();
                    }
                }

                if (reasonStr.includes('unchecked runtime.lasterror') ||
                    reasonStr.includes('runtime.lasterror') ||
                    reasonStr.includes('message port closed') ||
                    reasonStr.includes('message channel closed') ||
                    reasonStr.includes('asynchronous response') ||
                    reasonStr.includes('receiving end does not exist') ||
                    reasonStr.includes('could not establish connection') ||
                    reasonStr.includes('the message port closed before a response was received') ||
                    reasonStr.includes('woff2') ||
                    (reasonStr.includes('font') && reasonStr.includes('failed'))) {
                    event.preventDefault();
                    return false;
                }
            }
        });
    </script>
    <!-- Tailwind CDN script removed - causes CORS errors in production -->
    <!-- The app uses local styles.css which contains all necessary Tailwind-like utilities -->
    <script>
        // Suppress any remaining Tailwind CDN CORS errors from other sources
        (function () {
            // Intercept fetch calls to Tailwind CDN and suppress errors
            const originalFetch = window.fetch;
            window.fetch = function (...args) {
                const url = args[0];
                if (typeof url === 'string' && url.includes('cdn.tailwindcss.com')) {
                    // Suppress fetch to Tailwind CDN - return a rejected promise silently
                    return Promise.reject(new Error('Tailwind CDN not used in production')).catch(() => {
                        // Silently ignore
                    });
                }
                return originalFetch.apply(this, args).catch(function (error) {
                    // Suppress CORS errors for Tailwind CDN
                    if (error && error.message && error.message.includes('cdn.tailwindcss.com')) {
                        // Silently ignore
                        return Promise.reject(error);
                    }
                    throw error;
                });
            };
        })();
    </script>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="anonymous" />
    <!-- Leaflet JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin="anonymous"></script>

    <!-- Chart.js for Data Visualization -->
    <script>
        (function () {
            const chartScript = document.createElement('script');
            chartScript.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js';
            chartScript.crossOrigin = 'anonymous';
            chartScript.onerror = function () {
                this.onerror = null;
                this.src = 'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js';
                this.onerror = function () {
                    console.warn('⚠️ Failed to load Chart.js from all CDN sources. Charts may not display.');
                };
            };
            document.head.appendChild(chartScript);
        })();
    </script>

    <!-- Font Awesome Icons -->
    <!-- Removed integrity hash to prevent 404 errors - using latest stable version -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script>
        // Enhanced Font Awesome Loading Detection with Periodic Checks
        (function () {
            let fontAwesomeCheckInterval = null;
            let lastCheckTime = 0;
            const CHECK_INTERVAL = 60000; // Check every minute
            const INITIAL_CHECK_DELAY = 500; // Initial check after 500ms

            /**
             * Check if Font Awesome is loaded correctly
             * @returns {boolean} True if Font Awesome is loaded, false otherwise
             */
            function checkFontAwesome() {
                try {
                    const testElement = document.createElement('i');
                    testElement.className = 'fas fa-check';
                    testElement.style.position = 'absolute';
                    testElement.style.visibility = 'hidden';
                    testElement.style.fontSize = '1px';
                    testElement.style.left = '-9999px';
                    document.body.appendChild(testElement);

                    const computed = window.getComputedStyle(testElement, ':before');
                    const content = computed.getPropertyValue('content');

                    document.body.removeChild(testElement);

                    // Check if content is valid (not 'none' or empty)
                    const isLoaded = content && content !== 'none' && content !== '""' && content !== '';
                    return isLoaded;
                } catch (error) {
                    // If check fails, assume Font Awesome is not loaded
                    return false;
                }
            }

            /**
             * Reload Font Awesome from fallback CDN
             */
            function reloadFontAwesome() {
                // Remove existing Font Awesome links
                const existingLinks = document.querySelectorAll('link[href*="font-awesome"], link[href*="fontawesome"]');
                existingLinks.forEach(link => {
                    if (link.href.includes('cdnjs') || link.href.includes('jsdelivr') || link.href.includes('unpkg')) {
                        link.remove();
                    }
                });

                // Try jsDelivr first
                const fallback = document.createElement('link');
                fallback.rel = 'stylesheet';
                fallback.href = 'https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css';
                fallback.crossOrigin = 'anonymous';
                fallback.referrerPolicy = 'no-referrer';
                fallback.id = 'font-awesome-fallback';

                // If jsDelivr fails, try unpkg
                // Use a safer approach - check after a timeout instead of onerror
                // (link elements don't reliably support onerror)
                setTimeout(function () {
                    if (!checkFontAwesome()) {
                        try {
                            const unpkgFallback = document.createElement('link');
                            unpkgFallback.rel = 'stylesheet';
                            unpkgFallback.href = 'https://unpkg.com/@fortawesome/fontawesome-free@6.5.1/css/all.min.css';
                            unpkgFallback.crossOrigin = 'anonymous';
                            unpkgFallback.referrerPolicy = 'no-referrer';
                            unpkgFallback.id = 'font-awesome-unpkg-fallback';
                            if (document && document.head) {
                                document.head.appendChild(unpkgFallback);
                            }
                        } catch (e) {
                            // Silently fail - Font Awesome is not critical
                        }
                    }
                }, 3000); // Check after 3 seconds

                document.head.appendChild(fallback);
            }

            /**
             * Perform Font Awesome check and reload if needed
             */
            function performFontAwesomeCheck() {
                const now = Date.now();
                // Prevent multiple checks within 5 seconds
                if (now - lastCheckTime < 5000) {
                    return;
                }
                lastCheckTime = now;

                if (!checkFontAwesome()) {
                    if (typeof console !== 'undefined' && console.warn) {
                        console.warn('⚠️ Font Awesome not loaded, attempting to reload...');
                    }
                    reloadFontAwesome();
                }
            }

            // Initial check after page load
            window.addEventListener('load', function () {
                setTimeout(function () {
                    performFontAwesomeCheck();

                    // Start periodic checks
                    if (!fontAwesomeCheckInterval) {
                        fontAwesomeCheckInterval = setInterval(function () {
                            performFontAwesomeCheck();
                        }, CHECK_INTERVAL);
                    }
                }, INITIAL_CHECK_DELAY);
            });

            // Also check when DOM is ready (for faster initial detection)
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', function () {
                    setTimeout(function () {
                        performFontAwesomeCheck();
                    }, INITIAL_CHECK_DELAY);
                });
            } else {
                // DOM is already ready
                setTimeout(function () {
                    performFontAwesomeCheck();
                }, INITIAL_CHECK_DELAY);
            }

            // Cleanup on page unload
            window.addEventListener('beforeunload', function () {
                if (fontAwesomeCheckInterval) {
                    clearInterval(fontAwesomeCheckInterval);
                    fontAwesomeCheckInterval = null;
                }
            });
        })();
    </script>

    <!-- Google Fonts with fallback -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script>
        // Fallback for Google Fonts loading errors
        (function() {
            if (typeof document !== 'undefined') {
                // Check if Cairo font is available after page load
                setTimeout(function() {
                    if (typeof document.fonts !== 'undefined' && document.fonts.check) {
                        const fontCheck = document.fonts.check('16px Cairo');
                        if (!fontCheck) {
                            // Font not loaded, using system font fallback
                            console.warn('⚠️ Cairo font failed to load from Google Fonts, using system font fallback');
                            // The CSS already has fallback fonts: 'Segoe UI', Tahoma, Geneva, Verdana, Arial, Helvetica
                        }
                    }
                }, 2000);
            }
        })();
    </script>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="css/components.css">

    <!-- Enhanced Dashboard CSS -->
    <link rel="stylesheet" href="css/dashboard-enhanced.css">

    <!-- Dashboard Layout CSS -->
    <link rel="stylesheet" href="css/dashboard-layout.css">

    <!-- Safety Metrics Card CSS -->
    <link rel="stylesheet" href="css/safety-metrics-card.css">

    <!-- Reports & Statistics Card CSS -->
    <link rel="stylesheet" href="css/reports-statistics-card.css">

    <!-- UI/UX Professional Enhancements -->
    <link rel="stylesheet" href="css/ui-ux-enhancements.css">
    <link rel="stylesheet" href="css/browser-compatibility.css">

    <!-- Contractors Tabs CSS -->
    <link rel="stylesheet" href="css/contractors-tabs.css">

    <!-- Module Tabs CSS (Unified Tab Definitions) -->
    <link rel="stylesheet" href="css/module-tabs.css">

    <!-- Tailwind Utilities CSS -->
    <link rel="stylesheet" href="css/tailwind-utilities.css">

    <!-- SheetJS for Excel import -->
    <script>
        (function () {
            const xlsxScript = document.createElement('script');
            xlsxScript.src = 'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js';
            xlsxScript.onerror = function () {
                this.onerror = null;
                this.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
                this.onerror = function () {
                    this.onerror = null;
                    this.src = 'https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js';
                };
            };
            document.head.appendChild(xlsxScript);
        })();
    </script>

    <!-- jsPDF for PDF export -->
    <script>
        (function () {
            const jspdfScript = document.createElement('script');
            jspdfScript.src = 'https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js';
            jspdfScript.onerror = function () {
                this.onerror = null;
                this.src = 'https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js';
                this.onerror = function () {
                    this.onerror = null;
                    this.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
                };
            };
            document.head.appendChild(jspdfScript);

            // jsPDF autotable plugin
            const autotableScript = document.createElement('script');
            autotableScript.src = 'https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.24/dist/jspdf.plugin.autotable.min.js';
            autotableScript.onerror = function () {
                this.onerror = null;
                this.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.24/jspdf.plugin.autotable.min.js';
                this.onerror = function () {
                    this.onerror = null;
                    this.src = 'https://unpkg.com/jspdf-autotable@3.5.24/dist/jspdf.plugin.autotable.min.js';
                };
            };
            document.head.appendChild(autotableScript);
        })();
    </script>

    <!-- QR Code Generator -->
    <script>
        (function () {
            const qrcodeScript = document.createElement('script');
            qrcodeScript.src = 'https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js';
            qrcodeScript.onerror = function () {
                this.onerror = null;
                this.src = 'https://unpkg.com/qrcode-generator@1.4.4/qrcode.min.js';
                this.onerror = function () {
                    // QR code generator failed - feature will be unavailable
                    window.qrcode = null;
                };
            };
            document.head.appendChild(qrcodeScript);
        })();
    </script>

    <!-- QR Code Scanner -->
    <script>
        (function () {
            const jsqrScript = document.createElement('script');
            jsqrScript.src = 'https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js';
            jsqrScript.onerror = function () {
                this.onerror = null;
                this.src = 'https://unpkg.com/jsqr@1.4.0/dist/jsQR.js';
                this.onerror = function () {
                    this.onerror = null;
                    this.src = 'https://cdnjs.cloudflare.com/ajax/libs/jsQR/1.4.0/jsQR.min.js';
                    this.onerror = function () {
                        // jsQR failed - QR scanning will not be available
                        window.jsQR = null;
                    };
                };
            };
            document.head.appendChild(jsqrScript);
        })();
    </script>

    <!-- PWA Support: لا نضيف manifest على localhost لتجنب 404 -->
    <script>
        (function(){ try {
            var isLocal = (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1');
            if (isLocal) return;
            if (window.location.protocol !== 'file:' && window.location.origin !== 'null' && window.location.origin) {
                var link = document.createElement('link');
                link.rel = 'manifest';
                var p = (window.location.pathname || '').replace(/\/?[^/]*$/, '/');
                link.href = (p || '/') + 'manifest.json';
                link.id = 'pwa-manifest-link';
                link.onerror = function(){ if(window.UniversalErrorHandler&&window.UniversalErrorHandler.shouldSuppress('Manifest error',this.href||'','')) return; console.warn('⚠️ manifest.json غير متوفر - ميزات PWA محدودة'); };
                document.head.appendChild(link);
            }
        } catch(e) {} })();
    </script>
    <meta name="theme-color" content="#3B82F6">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">

    <!-- Content Security Policy -->
    <!-- ملاحظة: frame-ancestors لا يعمل في <meta> tag، يجب إضافته في HTTP headers من الخادم -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; 
                   script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://maps.googleapis.com https://*.googleapis.com; 
                   style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://fonts.gstatic.com https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://unpkg.com https://maps.googleapis.com; 
                   font-src 'self' https://fonts.gstatic.com https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://unpkg.com; 
                   img-src 'self' data: blob: https: https://*.googleapis.com https://*.gstatic.com https://*.openstreetmap.org; 
                   connect-src 'self' https://script.google.com https://*.googleusercontent.com https://*.googleapis.com https://maps.googleapis.com https://graph.microsoft.com https://login.microsoftonline.com https://oauth2.googleapis.com https://api.ipify.org https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://*.supabase.co https://rtxleteymcqmtzrozckh.supabase.co;
                   manifest-src 'self' blob:;
                   base-uri 'self';
                   form-action 'self';">

    <!-- ✅ دالة فتح/إغلاق إشعارات القائمة الجانبية -->
    <script>
        window.toggleSidebarNotifications = function() {
            console.log('🔔 toggleSidebarNotifications called!');
            var dropdown = document.getElementById('notifications-dropdown');
            var emptyMsg = document.getElementById('notifications-empty');
            
            if (!dropdown) {
                console.log('❌ Dropdown not found!');
                return;
            }
            
            var isVisible = dropdown.style.display === 'flex';
            console.log('🔔 Current state: isVisible =', isVisible);
            
            if (isVisible) {
                // إخفاء
                dropdown.style.display = 'none';
                console.log('🔔 Dropdown HIDDEN');
            } else {
                // إظهار
                dropdown.style.cssText = 'display: flex !important; visibility: visible !important; opacity: 1 !important; position: fixed !important; z-index: 99999 !important; top: 100px !important; left: 50% !important; transform: translateX(-50%) !important; width: 380px !important; max-width: 90vw !important; background: var(--card-bg, #ffffff) !important; border-radius: 12px !important; box-shadow: 0 8px 32px rgba(0,0,0,0.25) !important; flex-direction: column !important; border: 1px solid var(--border-color, #e5e7eb) !important;';
                
                // إظهار رسالة "لا توجد إشعارات" إذا كانت القائمة فارغة
                if (emptyMsg) {
                    emptyMsg.style.display = 'flex';
                }
                console.log('🔔 Dropdown SHOWN');
            }
        };
    </script>
</head>

<body class="font-cairo bg-gray-50" data-theme="light">
    <!-- استعادة الجلسة فوراً وإخفاء شاشة الدخول حتى نتحقق (لمنع ظهورها ثم الدخول التلقائي بعد إعادة التحميل) -->
    <script>
        (function() {
            try {
                var hasSession = sessionStorage.getItem('hse_current_session');
                if (!hasSession) {
                    var b = localStorage.getItem('hse_session_backup') || localStorage.getItem('hse_remember_user');
                    if (b) {
                        var d = JSON.parse(b);
                        if (d && d.email) {
                            sessionStorage.setItem('hse_current_session', b);
                            if (d.sessionId) sessionStorage.setItem('hse_session_id', d.sessionId);
                            hasSession = true;
                        }
                    }
                }
                if (hasSession || localStorage.getItem('hse_session_backup') || localStorage.getItem('hse_remember_user')) {
                    document.body.setAttribute('data-hse-pending-session', '1');
                    var style = document.createElement('style');
                    style.id = 'hse-hide-login-until-ready';
                    style.textContent = 'body[data-hse-pending-session] #login-screen { visibility: hidden !important; opacity: 0 !important; pointer-events: none !important; position: absolute !important; }\nbody[data-hse-pending-session]::after { content: ""; position: fixed; inset: 0; background: var(--bg-gray-50, #f9fafb); z-index: 99998; }\nbody[data-hse-pending-session] .hse-loading-text { position: fixed; left: 50%; top: 50%; transform: translate(-50%,-50%); z-index: 99999; font-size: 1.1rem; color: #4b5563; }';
                    document.head.appendChild(style);
                    var loadingEl = document.createElement('div');
                    loadingEl.className = 'hse-loading-text';
                    loadingEl.setAttribute('aria-live', 'polite');
                    loadingEl.textContent = 'جاري التحقق من الجلسة...';
                    document.body.appendChild(loadingEl);
                }
            } catch (e) {}
        })();
    </script>
    <!-- ⚡ Additional Protection at Body Start ⚡ -->
    <script>
        // قمع إضافي في بداية body
        (function() {
            if (window.console && window.console.error) {
                const _e = window.console.error;
                window.console.error = function() {
                    const a = arguments[0];
                    if (a && (('' + a).indexOf('uploadmanager') !== -1 || ('' + a).indexOf('518') !== -1 || ('' + a).indexOf('cannot read') !== -1)) {
                        return;
                    }
                    return _e.apply(this, arguments);
                };
            }
        })();
    </script>
    <script>
        // تطبيق الوضع الليلي فوراً قبل تحميل DOM لمنع الوميض
        (function () {
            try {
                const savedTheme = localStorage.getItem('theme') || 'light';
                document.documentElement.setAttribute('data-theme', savedTheme);
                document.body.setAttribute('data-theme', savedTheme);
            } catch (e) {
                // تجاهل الأخطاء في حالة عدم توفر localStorage
            }
        })();
    </script>

    <!-- Login Screen: تظهر افتراضياً؛ عند تشغيل التطبيق من http يتم إخفاؤها فقط عند استعادة الجلسة وعرض التطبيق -->
    <div id="login-screen" class="login-screen" role="main" aria-label="شاشة تسجيل الدخول">
        <div class="login-container">
            <div class="login-card" role="article">
                <!-- Logo -->
                <header class="text-center mb-8">
                    <div class="logo-wrapper mb-4" aria-hidden="true">
                        <img id="company-logo" src="" alt="شعار الشركة"
                            style="max-width: 180px; max-height: 120px; display: none; margin: 0 auto; border-radius: 8px; object-fit: contain; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <i id="default-logo-icon" class="fas fa-shield-alt text-6xl text-blue-600"></i>
                    </div>
                    <h1 class="text-3xl font-bold text-gray-800 mb-2" id="login-title">نظام إدارة السلامة والصحة المهنية
                    </h1>
                    <p class="text-sm font-semibold text-blue-600 mt-1" id="login-company-name">الشركة العالمية للانتاج
                        والتصنيع الزراعي</p>
                    <p class="text-xs font-semibold text-gray-500 mt-1" id="login-company-secondary-name"
                        style="display: none;"></p>
                </header>

                <!-- Login Form -->
                <form id="login-form" class="space-y-6">
                    <div>
                        <label for="username" class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-envelope ml-2"></i>
                            البريد الإلكتروني
                        </label>
                        <input type="email" id="username" name="username" required class="form-input"
                            placeholder="example@americana.com" autocomplete="username">
                    </div>

                    <div>
                        <label for="password" class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-lock ml-2"></i>
                            كلمة المرور
                        </label>
                        <div class="relative">
                            <input type="password" id="password" name="password" required class="form-input"
                                placeholder="••••••••" autocomplete="current-password">
                            <button type="button" id="password-toggle-btn" class="password-toggle-btn"
                                aria-label="إظهار/إخفاء كلمة المرور" title="إظهار/إخفاء كلمة المرور">
                                <i class="fas fa-eye" id="password-toggle-icon" aria-hidden="true"></i>
                            </button>
                        </div>
                    </div>

                    <div class="flex items-center justify-between">
                        <label class="flex items-center">
                            <input type="checkbox" name="remember" id="remember-me"
                                class="rounded border-gray-300 text-blue-600" aria-label="تذكرني">
                            <span class="mr-2 text-sm text-gray-700">تذكرني</span>
                        </label>
                        <a href="#" id="forgot-password-link" class="text-sm text-blue-600 hover:text-blue-800"
                            aria-label="نسيت كلمة المرور">نسيت كلمة المرور؟</a>
                    </div>

                    <button type="submit" class="btn-primary w-full" aria-label="تسجيل الدخول">
                        <i class="fas fa-sign-in-alt ml-2" aria-hidden="true"></i>
                        تسجيل الدخول
                    </button>

                    <button type="button" id="help-btn" class="btn-secondary w-full mt-3" aria-label="مساعدة">
                        <i class="fas fa-question-circle ml-2" aria-hidden="true"></i>
                        مساعدة / Help
                    </button>

                    <div id="login-error-contact" class="login-error-contact" style="display: none;">
                        <p class="text-xs text-gray-500 text-center mt-4">
                            في حالة وجود أي مشكلة، يُرجى التواصل مع مدير النظام على البريد التالي:<br>
                            <a href="mailto:Yasser.diab@icapp.com.eg"
                                class="text-blue-500 hover:text-blue-700 hover:underline">Yasser.diab@icapp.com.eg</a>
                        </p>
                    </div>
                </form>

                <!-- Login Footer -->
                <footer class="login-footer">
                    <div class="login-footer-content">
                        <div class="login-footer-row">
                            <span>© Yasser Diab — كل الحقوق محفوظة 2025</span>
                            <span class="login-footer-separator">|</span>
                            <span class="login-footer-login-count">
                                <span>👥</span>
                                <span>عدد تسجيل الدخول للمستخدمين:</span>
                                <span id="login-count" class="login-count-number">0</span>
                            </span>
                        </div>
                        <div class="login-footer-row">
                            <span class="login-footer-trial-badge">نسخة تجريبية</span>
                            <span class="login-footer-separator">|</span>
                            <a href="#" id="privacy-policy-link" class="login-footer-link">سياسة الخصوصية</a>
                        </div>
                    </div>
                </footer>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="main-app" class="main-app" style="display: none;">
        <div id="sidebar-overlay" class="sidebar-overlay" aria-hidden="true"></div>

        <!-- Sidebar -->
        <aside class="sidebar" role="complementary" aria-label="القائمة الجانبية">
            <!-- User Profile -->
            <div class="user-profile" role="region" aria-label="معلومات المستخدم">
                <input type="file" id="user-profile-photo-input" accept="image/*" tabindex="-1"
                    style="position:absolute;opacity:0;pointer-events:none;width:0;height:0;overflow:hidden;">
                <div class="user-avatar user-avatar-clickable" role="button" tabindex="0"
                    title="انقر لإضافة أو تغيير صورة الملف الشخصي"
                    aria-label="إضافة أو تغيير صورة الملف الشخصي"
                    style="position: relative; overflow: hidden; flex-shrink: 0;">
                    <img id="user-profile-photo" src="" alt="صورة المستخدم"
                        style="position:absolute;inset:0;width:100%;height:100%;object-fit:cover;display:none;border-radius:50%;">
                    <i id="user-profile-icon" class="fas fa-user"></i>
                </div>
                <div class="user-info">
                    <h3 class="user-name" id="userDisplayName">المستخدم</h3>
                    <p class="user-email" id="adminEmail">user@example.com</p>
                    <!-- Connection Status Button -->
                    <button id="user-connection-status" class="user-connection-status" aria-label="حالة الاتصال"
                        title="حالة الاتصال">
                        <i class="fas fa-circle" id="user-connection-icon"></i>
                        <span id="user-connection-text">جاري التحقق...</span>
                    </button>
                </div>
            </div>

            <!-- Theme Toggle -->
            <button id="theme-toggle" class="theme-toggle" aria-label="تبديل الوضع الليلي" title="تبديل الوضع الليلي">
                <i class="fas fa-moon" id="theme-icon"></i>
                <span id="theme-text" style="display: none;">الوضع الليلي</span>
            </button>

            <!-- Notifications and Sync Buttons Container -->
            <div style="display: flex; align-items: center; gap: 0.5rem; margin: 0.5rem 1rem; position: relative; z-index: 1002;">
                <!-- Notifications Badge -->
                <div id="sidebar-notifications-container" style="position: relative; display: inline-block; z-index: 1002;">
                    <button id="notifications-btn" class="notifications-btn" aria-label="الإشعارات" title="الإشعارات"
                        style="pointer-events: auto !important; cursor: pointer !important; position: relative; z-index: 1002 !important;">
                        <i class="fas fa-bell" style="pointer-events: none;"></i>
                        <span id="notifications-badge" class="notifications-badge" style="display: none; pointer-events: none;">0</span>
                    </button>
                    <!-- Script لربط الزر مباشرة -->
                    <script>
                        (function() {
                            var btn = document.getElementById('notifications-btn');
                            if (btn) {
                                btn.onclick = function(e) {
                                    e.preventDefault();
                                    e.stopPropagation();
                                    console.log('🔔 CLICK on notifications-btn!');
                                    alert('تم الضغط على زر الإشعارات!');
                                    var dd = document.getElementById('notifications-dropdown');
                                    if (dd) {
                                        if (dd.style.display === 'flex') {
                                            dd.style.display = 'none';
                                        } else {
                                            dd.style.cssText = 'display:flex!important;position:fixed!important;z-index:99999!important;top:100px!important;left:50%!important;transform:translateX(-50%)!important;width:380px!important;max-width:90vw!important;background:#fff!important;border-radius:12px!important;box-shadow:0 8px 32px rgba(0,0,0,0.3)!important;flex-direction:column!important;border:1px solid #ddd!important;';
                                            var em = document.getElementById('notifications-empty');
                                            if (em) em.style.display = 'flex';
                                        }
                                    }
                                };
                                console.log('✅ notifications-btn onclick bound!');
                            }
                        })();
                    </script>
                    <!-- Notifications Dropdown Panel -->
                    <div id="notifications-dropdown" class="notifications-dropdown" style="display: none;">
                        <div class="notifications-dropdown-header">
                            <h3>الإشعارات</h3>
                            <button id="close-notifications-dropdown" class="close-notifications-btn"
                                aria-label="إغلاق">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div id="notifications-list" class="notifications-list">
                            <!-- Notifications will be populated here -->
                        </div>
                        <div id="notifications-empty" class="notifications-empty" style="display: none;">
                            <i class="fas fa-bell-slash"></i>
                            <p>لا توجد إشعارات جديدة</p>
                        </div>
                    </div>
                </div>

                <!-- Sync Button -->
                <button id="sync-btn" class="sync-btn" aria-label="مزامنة البيانات مع قاعدة البيانات"
                    title="مزامنة البيانات مع قاعدة البيانات">
                    <i class="fas fa-sync-alt" id="sync-icon"></i>
                </button>
            </div>

            <!-- Language Switcher -->
            <div class="language-switcher mb-4 p-3 rounded-lg">
                <button id="language-toggle" class="language-toggle-btn">
                    <span class="flex items-center gap-2">
                        <i class="fas fa-globe"></i>
                        <span id="current-lang-text">العربية</span>
                    </span>
                    <i class="fas fa-exchange-alt"></i>
                </button>
            </div>

            <!-- Navigation -->
            <nav class="navigation" role="navigation" aria-label="القائمة الرئيسية">
                <a href="#dashboard" class="nav-item active" data-section="dashboard" role="menuitem"
                    aria-current="page">
                    <i class="fas fa-chart-pie" aria-hidden="true"></i>
                    <span data-i18n="nav.dashboard">لوحة التحكم</span>
                </a>
                <a href="#users" class="nav-item" data-section="users" role="menuitem">
                    <i class="fas fa-users" aria-hidden="true"></i>
                    <span data-i18n="nav.users">المستخدمين</span>
                </a>
                <a href="#user-tasks" class="nav-item" data-section="user-tasks" role="menuitem">
                    <i class="fas fa-tasks" aria-hidden="true"></i>
                    <span data-i18n="nav.userTasks">مهام المستخدمين</span>
                </a>
                <a href="#employees" class="nav-item" data-section="employees" role="menuitem">
                    <i class="fas fa-user-tie" aria-hidden="true"></i>
                    <span data-i18n="nav.employees">قاعدة بيانات الموظفين</span>
                </a>
                <a href="#incidents" class="nav-item" data-section="incidents" role="menuitem">
                    <i class="fas fa-exclamation-triangle" aria-hidden="true"></i>
                    <span data-i18n="nav.incidents">الحوادث</span>
                </a>
                <a href="#nearmiss" class="nav-item" data-section="nearmiss" role="menuitem">
                    <i class="fas fa-eye" aria-hidden="true"></i>
                    <span data-i18n="nav.nearmiss">الحوادث الوشيكة</span>
                </a>
                <a href="#ptw" class="nav-item" data-section="ptw" role="menuitem">
                    <i class="fas fa-file-alt" aria-hidden="true"></i>
                    <span data-i18n="nav.ptw">تصاريح العمل</span>
                </a>
                <a href="#training" class="nav-item" data-section="training" role="menuitem">
                    <i class="fas fa-graduation-cap" aria-hidden="true"></i>
                    <span data-i18n="nav.training">التدريب</span>
                </a>
                <a href="#clinic" class="nav-item" data-section="clinic" role="menuitem">
                    <i class="fas fa-hospital" aria-hidden="true"></i>
                    <span data-i18n="nav.clinic">العيادة الطبية</span>
                </a>
                <a href="#fire-equipment" class="nav-item" data-section="fire-equipment" role="menuitem">
                    <i class="fas fa-fire-extinguisher" aria-hidden="true"></i>
                    <span data-i18n="nav.fire">فحص معدات الحريق</span>
                </a>
                <a href="#periodic-inspections" class="nav-item" data-section="periodic-inspections" role="menuitem">
                    <i class="fas fa-calendar-check" aria-hidden="true"></i>
                    <span data-i18n="nav.periodicInspections">الفحوصات الدورية</span>
                </a>
                <a href="#ppe" class="nav-item" data-section="ppe" role="menuitem">
                    <i class="fas fa-hard-hat" aria-hidden="true"></i>
                    <span data-i18n="nav.ppe">مهمات الوقاية</span>
                </a>
                <a href="#violations" class="nav-item" data-section="violations" role="menuitem">
                    <i class="fas fa-exclamation-circle" aria-hidden="true"></i>
                    <span data-i18n="nav.violations">المخالفات</span>
                </a>
                <a href="#contractors" class="nav-item" data-section="contractors" role="menuitem">
                    <i class="fas fa-users-cog" aria-hidden="true"></i>
                    <span data-i18n="nav.contractors">المقاولين</span>
                </a>
                <a href="#behavior-monitoring" class="nav-item" data-section="behavior-monitoring" role="menuitem">
                    <i class="fas fa-user-check" aria-hidden="true"></i>
                    <span data-i18n="nav.behavior">مراقبة التصرفات</span>
                </a>
                <a href="#chemical-safety" class="nav-item" data-section="chemical-safety" role="menuitem">
                    <i class="fas fa-flask" aria-hidden="true"></i>
                    <span data-i18n="nav.chemical">المواد الكيميائية</span>
                </a>
                <a href="#daily-observations" class="nav-item" data-section="daily-observations" role="menuitem">
                    <i class="fas fa-clipboard-check" aria-hidden="true"></i>
                    <span data-i18n="nav.observations">الملاحظات اليومية</span>
                </a>
                <a href="#iso" class="nav-item" data-section="iso" role="menuitem">
                    <i class="fas fa-certificate" aria-hidden="true"></i>
                    <span data-i18n="nav.iso">نظام ISO</span>
                </a>
                <a href="#emergency" class="nav-item" data-section="emergency" role="menuitem">
                    <i class="fas fa-bell" aria-hidden="true"></i>
                    <span data-i18n="nav.emergency">تنبيهات الطوارئ</span>
                </a>
                <a href="#risk-assessment" class="nav-item" data-section="risk-assessment" role="menuitem">
                    <i class="fas fa-shield-alt" aria-hidden="true"></i>
                    <span data-i18n="nav.risk">تقييم المخاطر</span>
                </a>
                <a href="#sop-jha" class="nav-item" data-section="sop-jha" role="menuitem">
                    <i class="fas fa-file-contract" aria-hidden="true"></i>
                    <span data-i18n="nav.sop">تعليمات السلامة SOP-JHA</span>
                </a>
                <a href="#legal-documents" class="nav-item" data-section="legal-documents" role="menuitem">
                    <i class="fas fa-gavel" aria-hidden="true"></i>
                    <span data-i18n="nav.legal">المستندات القانونية</span>
                </a>
                <a href="#sustainability" class="nav-item" data-section="sustainability" role="menuitem">
                    <i class="fas fa-leaf" aria-hidden="true"></i>
                    <span data-i18n="nav.sustainability">الاستدامة البيئية</span>
                </a>
                <a href="#safety-budget" class="nav-item" data-section="safety-budget" role="menuitem">
                    <i class="fas fa-wallet" aria-hidden="true"></i>
                    <span data-i18n="nav.safetyBudget">ميزانية السلامة</span>
                </a>
                <a href="#safety-performance-kpis" class="nav-item" data-section="safety-performance-kpis"
                    role="menuitem">
                    <i class="fas fa-gauge-high" aria-hidden="true"></i>
                    <span data-i18n="nav.safetyKPIs">مؤشرات الأداء للسلامة</span>
                </a>
                <a href="#safety-health-management" class="nav-item" data-section="safety-health-management"
                    role="menuitem">
                    <i class="fas fa-user-shield" aria-hidden="true"></i>
                    <span data-i18n="nav.safetyHealthManagement">إدارة السلامة والصحة</span>
                </a>
                <a href="#action-tracking" class="nav-item" data-section="action-tracking" role="menuitem">
                    <i class="fas fa-clipboard-list" aria-hidden="true"></i>
                    <span data-i18n="nav.actionTracking">سجل متابعة الإجراءات</span>
                </a>
                <a href="#change-management" class="nav-item" data-section="change-management" role="menuitem">
                    <i class="fas fa-exchange-alt" aria-hidden="true"></i>
                    <span data-i18n="nav.changeManagement">إدارة التغيرات</span>
                </a>
                <a href="#ai-assistant" class="nav-item" data-section="ai-assistant" role="menuitem">
                    <i class="fas fa-robot" aria-hidden="true"></i>
                    <span data-i18n="nav.aiAssistant">مساعد الذكاء الاصطناعي</span>
                </a>
                <a href="#apptester" class="nav-item" data-section="apptester" role="menuitem">
                    <i class="fas fa-vial" aria-hidden="true"></i>
                    <span data-i18n="nav.appTester">اختبار التطبيق</span>
                </a>
                <a href="#settings" class="nav-item" data-section="settings" role="menuitem">
                    <i class="fas fa-cog" aria-hidden="true"></i>
                    <span data-i18n="nav.settings">الإعدادات</span>
                </a>
            </nav>

            <!-- Logout Button -->
            <button id="logout-btn" class="logout-btn" aria-label="تسجيل الخروج">
                <i class="fas fa-sign-out-alt" aria-hidden="true"></i>
                <span data-i18n="nav.logout">تسجيل الخروج</span>
            </button>
        </aside>

        <div class="app-shell">
            <header class="mobile-topbar" role="banner">
                <button id="sidebar-toggle" class="sidebar-toggle" aria-label="فتح القائمة الرئيسية" title="القائمة"
                    aria-expanded="false">
                    <i class="fas fa-bars" aria-hidden="true"></i>
                </button>
                <div class="mobile-topbar-title">
                    <span id="mobile-company-name">نظام السلامة المهنية</span>
                    <small id="mobile-user-name" class="mobile-user-name"></small>
                </div>
                <div class="mobile-topbar-actions">
                    <button id="mobile-theme-toggle" class="mobile-icon-btn" aria-label="تبديل الوضع الليلي"
                        title="الوضع الليلي">
                        <i class="fas fa-moon" id="mobile-theme-icon" aria-hidden="true"></i>
                    </button>
                    <div style="position: relative;">
                        <button id="mobile-notifications-btn" class="mobile-icon-btn" aria-label="الإشعارات"
                            title="الإشعارات">
                            <i class="fas fa-bell" aria-hidden="true"></i>
                            <span id="mobile-notifications-badge" class="mobile-badge" style="display: none;">0</span>
                        </button>
                        <!-- Mobile Notifications Dropdown Panel -->
                        <div id="mobile-notifications-dropdown"
                            class="notifications-dropdown mobile-notifications-dropdown" style="display: none;">
                            <div class="notifications-dropdown-header">
                                <h3>الإشعارات</h3>
                                <button id="close-mobile-notifications-dropdown" class="close-notifications-btn"
                                    aria-label="إغلاق">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div id="mobile-notifications-list" class="notifications-list">
                                <!-- Notifications will be populated here -->
                            </div>
                            <div id="mobile-notifications-empty" class="notifications-empty" style="display: none;">
                                <i class="fas fa-bell-slash"></i>
                                <p>لا توجد إشعارات جديدة</p>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Main Content -->
            <main class="main-content">
                <!-- Company Logo Header -->
                <div id="company-logo-header" class="company-logo-header"
                    style="display: none; position: fixed; top: 0; right: var(--sidebar-width); left: 0; height: 70px; background: var(--card-bg); border-bottom: 2px solid var(--border-color); z-index: 40; padding: 10px 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: space-between; transition: background-color 0.3s ease;">
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <img id="header-company-logo" src="" alt="شعار الشركة"
                            style="max-height: 50px; max-width: 150px; object-fit: contain; display: none;">
                        <div id="header-company-text-group" style="display: flex; flex-direction: column; gap: 4px;">
                            <span id="header-company-name-text" class="header-company-name"
                                style="font-weight: 600; font-size: 1rem; color: var(--text-primary); display: none;"></span>
                            <span id="header-company-secondary-text" class="header-company-name"
                                style="font-weight: 600; font-size: 0.95rem; color: var(--text-primary); display: none;"></span>
                        </div>
                    </div>
                    <div style="flex: 1;"></div>
                    <!-- Header Actions: Theme Toggle & Notifications -->
                    <div class="header-actions" style="display: flex; align-items: center; gap: 10px;">
                        <button id="header-theme-toggle" class="header-theme-toggle" aria-label="تبديل الوضع الليلي"
                            title="تبديل الوضع الليلي" style="display: none;">
                            <i class="fas fa-moon" id="header-theme-icon"></i>
                        </button>
                        <div style="position: relative; display: inline-block;">
                            <button id="header-notifications-btn" class="header-notifications-btn"
                                aria-label="الإشعارات" title="الإشعارات" style="display: none; position: relative;">
                                <i class="fas fa-bell"></i>
                                <span id="header-notifications-badge" class="header-notifications-badge"
                                    style="display: none;">0</span>
                            </button>
                            <!-- Header Notifications Dropdown Panel -->
                            <div id="header-notifications-dropdown" class="notifications-dropdown"
                                style="display: none;">
                                <div class="notifications-dropdown-header">
                                    <h3>الإشعارات</h3>
                                    <button id="close-header-notifications-dropdown" class="close-notifications-btn"
                                        aria-label="إغلاق">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <div id="header-notifications-list" class="notifications-list">
                                    <!-- Notifications will be populated here -->
                                </div>
                                <div id="header-notifications-empty" class="notifications-empty" style="display: none;">
                                    <i class="fas fa-bell-slash"></i>
                                    <p>لا توجد إشعارات جديدة</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Dashboard Section -->
                <section id="dashboard-section" class="section active" role="region" aria-labelledby="dashboard-title">
                    <header class="section-header">
                        <h1 id="dashboard-title" class="section-title">
                            <i class="fas fa-tachometer-alt ml-3" aria-hidden="true"></i>
                            لوحة التحكم
                        </h1>
                        <p class="section-subtitle">نظرة عامة على أنشطة السلامة المهنية</p>
                    </header>

                    <!-- KPI Cards -->
                    <div class="kpi-grid" role="group" aria-label="مؤشرات الأداء الرئيسية">
                        <div class="kpi-card kpi-danger" role="article">
                            <div class="kpi-icon" aria-hidden="true">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div class="kpi-content">
                                <h3 class="kpi-label">إجمالي الحوادث</h3>
                                <p class="kpi-value" id="total-incidents" aria-live="polite">0</p>
                                <p class="kpi-description">هذا الشهر</p>
                            </div>
                        </div>

                        <div class="kpi-card kpi-success" role="article">
                            <div class="kpi-icon" aria-hidden="true">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="kpi-content">
                                <h3 class="kpi-label">المستخدمين النشطين</h3>
                                <p class="kpi-value" id="active-users" aria-live="polite">0</p>
                                <p class="kpi-description">مستخدم مسجل</p>
                            </div>
                        </div>

                        <div class="kpi-card kpi-info" role="article" style="grid-column: span 2; min-height: 180px;">
                            <div class="kpi-icon" aria-hidden="true">
                                <i class="fas fa-file-alt"></i>
                            </div>
                            <div class="kpi-content" style="flex: 1; width: 100%;">
                                <h3 class="kpi-label" style="margin-bottom: 16px; font-size: 18px;">تصاريح العمل</h3>
                                <div
                                    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; margin-top: 12px;">
                                    <div
                                        style="text-align: center; padding: 16px; background: rgba(59, 130, 246, 0.1); border-radius: 8px; border: 2px solid rgba(59, 130, 246, 0.2);">
                                        <p
                                            style="font-size: 13px; color: #6b7280; margin-bottom: 10px; font-weight: 600;">
                                            تصريح مفتوح</p>
                                        <p class="kpi-value" id="open-ptw-count" aria-live="polite"
                                            style="font-size: 32px; font-weight: bold; color: #3b82f6; margin: 0; line-height: 1.2;">
                                            0</p>
                                    </div>
                                    <div
                                        style="text-align: center; padding: 16px; background: rgba(34, 197, 94, 0.1); border-radius: 8px; border: 2px solid rgba(34, 197, 94, 0.2);">
                                        <p
                                            style="font-size: 13px; color: #6b7280; margin-bottom: 10px; font-weight: 600;">
                                            تصريح مغلق</p>
                                        <p class="kpi-value" id="closed-ptw-count" aria-live="polite"
                                            style="font-size: 32px; font-weight: bold; color: #22c55e; margin: 0; line-height: 1.2;">
                                            0</p>
                                    </div>
                                    <div
                                        style="text-align: center; padding: 16px; background: rgba(99, 102, 241, 0.1); border-radius: 8px; border: 2px solid rgba(99, 102, 241, 0.2);">
                                        <p
                                            style="font-size: 13px; color: #6b7280; margin-bottom: 10px; font-weight: 600;">
                                            الإجمالي</p>
                                        <p class="kpi-value" id="total-ptw-count" aria-live="polite"
                                            style="font-size: 32px; font-weight: bold; color: #6366f1; margin: 0; line-height: 1.2;">
                                            0</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="kpi-card kpi-primary" role="article">
                            <div class="kpi-icon" aria-hidden="true">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <div class="kpi-content">
                                <h3 class="kpi-label">معدل الامتثال</h3>
                                <p class="kpi-value" id="compliance-rate" aria-live="polite">0%</p>
                                <p class="kpi-description">شهري</p>
                            </div>
                        </div>

                        <div class="kpi-card kpi-purple" role="article">
                            <div class="kpi-icon" aria-hidden="true">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div class="kpi-content">
                                <h3 class="kpi-label">عدد ساعات العمل</h3>
                                <p class="kpi-value" id="total-work-hours" aria-live="polite">0</p>
                                <p class="kpi-description">ساعة عمل</p>
                            </div>
                        </div>

                        <div class="kpi-card kpi-success" role="article">
                            <div class="kpi-icon" aria-hidden="true">
                                <i class="fas fa-calendar-times"></i>
                            </div>
                            <div class="kpi-content">
                                <h3 class="kpi-label">إجمالي الأيام منذ آخر حادث</h3>
                                <p class="kpi-value" id="days-without-injury" aria-live="polite">0</p>
                                <p class="kpi-description">يوم</p>
                            </div>
                        </div>
                    </div>
                    <!-- End of KPI Grid -->

                    <!-- مؤشرات السلامة المهنية (Safety Metrics) - ثابت بدون animation/وميض -->
                    <div class="content-card safety-metrics-section kpis-values-ready">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="fas fa-chart-line ml-2"></i>
                                مؤشرات السلامة المهنية (Safety Metrics)
                            </h2>
                        </div>
                        <div class="card-body">
                            <div class="metrics-grid-container">
                                <!-- TRIR - Total Recordable Injury Rate -->
                                <div class="metric-card-frame kpi-purple">
                                    <div>
                                        <div class="flex items-center justify-between mb-2 w-full">
                                            <div class="text-purple-600 text-2xl">
                                                <i class="fas fa-clipboard-check"></i>
                                            </div>
                                            <span
                                                class="text-xs font-semibold text-purple-700 bg-purple-200 px-2 py-1 rounded">TRIR</span>
                                        </div>
                                        <h3 class="text-sm font-semibold text-gray-700 mb-1">Total Recordable Injury
                                            Rate</h3>
                                        <p class="text-2xl font-bold text-purple-600" id="trir-value">0.00</p>
                                        <p class="text-xs text-gray-600 mt-1">معدل الإصابات القابلة للتسجيل</p>
                                    </div>
                                </div>

                                <!-- FA - Frequency Rate -->
                                <div class="metric-card-frame kpi-info">
                                    <div>
                                        <div class="flex items-center justify-between mb-2 w-full">
                                            <div class="text-blue-600 text-2xl">
                                                <i class="fas fa-sync-alt"></i>
                                            </div>
                                            <span
                                                class="text-xs font-semibold text-blue-700 bg-blue-200 px-2 py-1 rounded">FA</span>
                                        </div>
                                        <h3 class="text-sm font-semibold text-gray-700 mb-1">Frequency Rate</h3>
                                        <p class="text-2xl font-bold text-blue-600" id="fa-value">0.00</p>
                                        <p class="text-xs text-gray-600 mt-1">معدل التكرار (لكل مليون ساعة)</p>
                                    </div>
                                </div>

                                <!-- TIR - Total Injury Rate -->
                                <div class="metric-card-frame kpi-warning">
                                    <div>
                                        <div class="flex items-center justify-between mb-2 w-full">
                                            <div class="text-orange-600 text-2xl">
                                                <i class="fas fa-chart-bar"></i>
                                            </div>
                                            <span
                                                class="text-xs font-semibold text-orange-700 bg-orange-200 px-2 py-1 rounded">TIR</span>
                                        </div>
                                        <h3 class="text-sm font-semibold text-gray-700 mb-1">Total Injury Rate</h3>
                                        <p class="text-2xl font-bold text-orange-600" id="tir-value">0</p>
                                        <p class="text-xs text-gray-600 mt-1">معدل الإصابات الإجمالي</p>
                                    </div>
                                </div>

                                <!-- LTI - Lost Time Injury -->
                                <div class="metric-card-frame kpi-danger">
                                    <div>
                                        <div class="flex items-center justify-between mb-2 w-full">
                                            <div class="text-red-600 text-2xl">
                                                <i class="fas fa-user-injured"></i>
                                            </div>
                                            <span
                                                class="text-xs font-semibold text-red-700 bg-red-200 px-2 py-1 rounded">LTI</span>
                                        </div>
                                        <h3 class="text-sm font-semibold text-gray-700 mb-1">Lost Time Injury</h3>
                                        <p class="text-2xl font-bold text-red-600" id="lti-value">0</p>
                                        <p class="text-xs text-gray-600 mt-1">إصابات فقدان وقت العمل</p>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                                <p class="text-xs text-gray-600">
                                    <i class="fas fa-info-circle ml-1 text-blue-600"></i>
                                    <strong>ملاحظة:</strong> يتم حساب المؤشرات بناءً على عدد الحوادث المسجلة وإجمالي
                                    ساعات العمل.
                                </p>
                            </div>
                        </div>
                    </div>
                    <!-- End of Safety Metrics Section -->

                    <!-- التقارير والإحصائيات (Reports & Statistics) - ثابت بدون animation/وميض -->
                    <div class="content-card reports-statistics-section kpis-values-ready">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="fas fa-file-chart-line ml-2"></i>
                                التقارير والإحصائيات (Reports & Statistics)
                            </h2>
                        </div>
                        <div class="card-body">
                            <div class="metrics-grid-container">
                                <!-- Total Reports -->
                                <div class="metric-card-frame kpi-indigo">
                                    <div>
                                        <div class="flex items-center justify-between mb-2 w-full">
                                            <div
                                                class="w-8 h-8 flex items-center justify-center rounded-md bg-indigo-100 text-indigo-600">
                                                <i class="fas fa-file-alt"></i>
                                            </div>
                                            <span
                                                class="text-xs font-bold px-2 py-1 rounded bg-gray-100 text-gray-600 tracking-wide">REPORTS</span>
                                        </div>
                                        <h3 class="text-sm font-semibold text-gray-700 mb-1">Total Reports</h3>
                                        <p class="text-2xl font-bold text-gray-900" id="total-reports-value" dir="ltr" style="direction: ltr; text-align: left; font-variant-numeric: tabular-nums;">0</p>
                                        <p class="text-xs text-gray-600 mt-1">إجمالي التقارير المُنشأة</p>
                                    </div>
                                </div>

                                <!-- Incidents Reports -->
                                <div class="metric-card-frame kpi-danger" data-stat-id="incidents" data-clickable="true" style="cursor: pointer;">
                                    <div>
                                        <div class="flex items-center justify-between mb-2 w-full">
                                            <div
                                                class="w-8 h-8 flex items-center justify-center rounded-md bg-red-100 text-red-500">
                                                <i class="fas fa-exclamation-circle"></i>
                                            </div>
                                            <span
                                                class="text-xs font-bold px-2 py-1 rounded bg-gray-100 text-gray-600 tracking-wide">INCIDENTS</span>
                                        </div>
                                        <h3 class="text-sm font-semibold text-gray-700 mb-1">Incident Reports</h3>
                                        <p class="text-2xl font-bold text-gray-900" id="incident-reports-value" dir="ltr" style="direction: ltr; text-align: left; font-variant-numeric: tabular-nums;">0</p>
                                        <p class="text-xs text-gray-600 mt-1">تقارير الحوادث</p>
                                    </div>
                                </div>

                                <!-- Near Miss Reports -->
                                <div class="metric-card-frame kpi-warning" data-stat-id="nearmiss" data-clickable="true" style="cursor: pointer;">
                                    <div>
                                        <div class="flex items-center justify-between mb-2 w-full">
                                            <div
                                                class="w-8 h-8 flex items-center justify-center rounded-md bg-orange-100 text-orange-500">
                                                <i class="fas fa-triangle-exclamation"></i>
                                            </div>
                                            <span
                                                class="text-xs font-bold px-2 py-1 rounded bg-gray-100 text-gray-600 tracking-wide">NEAR
                                                MISS</span>
                                        </div>
                                        <h3 class="text-sm font-semibold text-gray-700 mb-1">Near Miss Reports</h3>
                                        <p class="text-2xl font-bold text-gray-900" id="nearmiss-reports-value" dir="ltr" style="direction: ltr; text-align: left; font-variant-numeric: tabular-nums;">0</p>
                                        <p class="text-xs text-gray-600 mt-1">تقارير الحوادث الوشيكة</p>
                                    </div>
                                </div>

                                <!-- Inspections -->
                                <div class="metric-card-frame kpi-success" data-stat-id="periodic-inspections" data-clickable="true" style="cursor: pointer;">
                                    <div>
                                        <div class="flex items-center justify-between mb-2 w-full">
                                            <div
                                                class="w-8 h-8 flex items-center justify-center rounded-md bg-green-100 text-green-500">
                                                <i class="fas fa-clipboard-check"></i>
                                            </div>
                                            <span
                                                class="text-xs font-bold px-2 py-1 rounded bg-gray-100 text-gray-600 tracking-wide">INSPECTIONS</span>
                                        </div>
                                        <h3 class="text-sm font-semibold text-gray-700 mb-1">Inspections</h3>
                                        <p class="text-2xl font-bold text-gray-900" id="inspections-reports-value" dir="ltr" style="direction: ltr; text-align: left; font-variant-numeric: tabular-nums;">0</p>
                                        <p class="text-xs text-gray-600 mt-1">تقارير الفحص والتفتيش</p>
                                    </div>
                                </div>

                                <!-- Training Reports -->
                                <div class="metric-card-frame kpi-info" data-stat-id="training" data-clickable="true" style="cursor: pointer;">
                                    <div>
                                        <div class="flex items-center justify-between mb-2 w-full">
                                            <div
                                                class="w-8 h-8 flex items-center justify-center rounded-md bg-blue-100 text-blue-500">
                                                <i class="fas fa-graduation-cap"></i>
                                            </div>
                                            <span
                                                style="font-size: 0.6875rem; font-weight: 700; padding: 0.25rem 0.5rem; border-radius: 4px; background: rgba(0, 0, 0, 0.05); color: #4b5563; letter-spacing: 0.5px;">TRAINING</span>
                                        </div>
                                        <h3 class="text-sm font-semibold text-gray-700 mb-1">Training Sessions</h3>
                                        <p class="text-2xl font-bold text-gray-900" id="training-sessions-value" dir="ltr" style="direction: ltr; text-align: left; font-variant-numeric: tabular-nums;">0</p>
                                        <p class="text-xs text-gray-600 mt-1">جلسات التدريب المنفذة</p>
                                    </div>
                                </div>


                                <!-- Violations -->
                                <div class="metric-card-frame kpi-warning" data-stat-id="violations" data-clickable="true" style="cursor: pointer;">
                                    <div>
                                        <div class="flex items-center justify-between mb-2 w-full">
                                            <div
                                                class="w-8 h-8 flex items-center justify-center rounded-md bg-pink-100 text-pink-500">
                                                <i class="fas fa-ban"></i>
                                            </div>
                                            <span
                                                class="text-xs font-bold px-2 py-1 rounded bg-gray-100 text-gray-600 tracking-wide">VIOLATIONS</span>
                                        </div>
                                        <h3 class="text-sm font-semibold text-gray-700 mb-1">Safety Violations</h3>
                                        <p class="text-2xl font-bold text-gray-900" id="violations-value" dir="ltr" style="direction: ltr; text-align: left; font-variant-numeric: tabular-nums;">0</p>
                                        <p class="text-xs text-gray-600 mt-1">المخالفات المسجلة</p>
                                    </div>
                                </div>

                                <!-- المقاولين المعتمدين -->
                                <div class="metric-card-frame kpi-primary" data-stat-id="contractors" data-clickable="true" style="cursor: pointer;">
                                    <div>
                                        <div class="flex items-center justify-between mb-2 w-full">
                                            <div class="w-8 h-8 flex items-center justify-center rounded-md bg-blue-100 text-blue-600">
                                                <i class="fas fa-handshake"></i>
                                            </div>
                                            <span class="text-xs font-bold px-2 py-1 rounded bg-gray-100 text-gray-600 tracking-wide">المقاولين المعتمدين</span>
                                        </div>
                                        <h3 class="text-sm font-semibold text-gray-700 mb-1">المقاولين المعتمدين</h3>
                                        <p class="text-2xl font-bold text-gray-900" id="approved-contractors-card-value" dir="ltr" style="direction: ltr; text-align: left; font-variant-numeric: tabular-nums;">0</p>
                                        <p class="text-xs text-gray-600 mt-1">المقاولون والموردون المعتمدون في النظام</p>
                                    </div>
                                </div>

                                <!-- PTW Reports -->
                                <div class="metric-card-frame kpi-purple" data-stat-id="ptw" data-clickable="true" style="cursor: pointer;">
                                    <div>
                                        <div class="flex items-center justify-between mb-2 w-full">
                                            <div
                                                class="w-8 h-8 flex items-center justify-center rounded-md bg-purple-100 text-purple-500">
                                                <i class="fas fa-file-signature"></i>
                                            </div>
                                            <span
                                                class="text-xs font-bold px-2 py-1 rounded bg-gray-100 text-gray-600 tracking-wide">PTW</span>
                                        </div>
                                        <h3 class="text-sm font-semibold text-gray-700 mb-1">Permit to Work</h3>
                                        <p class="text-2xl font-bold text-gray-900" id="ptw-reports-value" dir="ltr" style="direction: ltr; text-align: left; font-variant-numeric: tabular-nums;">0</p>
                                        <p class="text-xs text-gray-600 mt-1">تصاريح العمل الصادرة</p>
                                    </div>
                                </div>


                                <!-- Audits -->
                                <div class="metric-card-frame kpi-indigo" data-stat-id="iso" data-clickable="true" style="cursor: pointer;">
                                    <div>
                                        <div class="flex items-center justify-between mb-2 w-full">
                                            <div
                                                class="w-8 h-8 flex items-center justify-center rounded-md bg-indigo-100 text-indigo-600">
                                                <i class="fas fa-search"></i>
                                            </div>
                                            <span
                                                class="text-xs font-bold px-2 py-1 rounded bg-gray-100 text-gray-600 tracking-wide">AUDITS</span>
                                        </div>
                                        <h3 class="text-sm font-semibold text-gray-700 mb-1">Safety Audits</h3>
                                        <p class="text-2xl font-bold text-gray-900" id="audits-value" dir="ltr" style="direction: ltr; text-align: left; font-variant-numeric: tabular-nums;">0</p>
                                        <p class="text-xs text-gray-600 mt-1">عمليات التدقيق المنفذة</p>
                                    </div>
                                </div>

                                <!-- Electricity Consumption -->
                                <div class="metric-card-frame kpi-warning" data-stat-id="electricity-consumption" data-clickable="true" style="cursor: pointer;">
                                    <div>
                                        <div class="flex items-center justify-between mb-2 w-full">
                                            <div
                                                class="w-8 h-8 flex items-center justify-center rounded-md bg-yellow-100 text-yellow-600">
                                                <i class="fas fa-bolt"></i>
                                            </div>
                                            <span
                                                class="text-xs font-bold px-2 py-1 rounded bg-gray-100 text-gray-600 tracking-wide">ELECTRICITY</span>
                                        </div>
                                        <h3 class="text-sm font-semibold text-gray-700 mb-1">استهلاك الكهرباء</h3>
                                        <p class="text-2xl font-bold text-gray-900" id="electricity-consumption-value" dir="ltr" style="direction: ltr; text-align: left; font-variant-numeric: tabular-nums;">0</p>
                                        <p class="text-xs text-gray-600 mt-1">كيلووات ساعة (kWh)</p>
                                    </div>
                                </div>

                                <!-- Water Consumption -->
                                <div class="metric-card-frame kpi-info" data-stat-id="water-consumption" data-clickable="true" style="cursor: pointer;">
                                    <div>
                                        <div class="flex items-center justify-between mb-2 w-full">
                                            <div
                                                class="w-8 h-8 flex items-center justify-center rounded-md bg-blue-100 text-blue-500">
                                                <i class="fas fa-tint"></i>
                                            </div>
                                            <span
                                                class="text-xs font-bold px-2 py-1 rounded bg-gray-100 text-gray-600 tracking-wide">WATER</span>
                                        </div>
                                        <h3 class="text-sm font-semibold text-gray-700 mb-1">استهلاك المياة</h3>
                                        <p class="text-2xl font-bold text-gray-900" id="water-consumption-value" dir="ltr" style="direction: ltr; text-align: left; font-variant-numeric: tabular-nums;">0</p>
                                        <p class="text-xs text-gray-600 mt-1">متر مكعب (m³)</p>
                                    </div>
                                </div>

                                <!-- Gas Consumption -->
                                <div class="metric-card-frame kpi-danger" data-stat-id="gas-consumption" data-clickable="true" style="cursor: pointer;">
                                    <div>
                                        <div class="flex items-center justify-between mb-2 w-full">
                                            <div
                                                class="w-8 h-8 flex items-center justify-center rounded-md bg-red-100 text-red-500">
                                                <i class="fas fa-fire"></i>
                                            </div>
                                            <span
                                                class="text-xs font-bold px-2 py-1 rounded bg-gray-100 text-gray-600 tracking-wide">GAS</span>
                                        </div>
                                        <h3 class="text-sm font-semibold text-gray-700 mb-1">استهلاك الغاز</h3>
                                        <p class="text-2xl font-bold text-gray-900" id="gas-consumption-value" dir="ltr" style="direction: ltr; text-align: left; font-variant-numeric: tabular-nums;">0</p>
                                        <p class="text-xs text-gray-600 mt-1">متر مكعب (m³)</p>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                                <p class="text-xs text-gray-600">
                                    <i class="fas fa-chart-pie ml-1 text-blue-600"></i>
                                    <strong>إحصائيات:</strong> يتم تحديث التقارير والإحصائيات تلقائياً بناءً على
                                    البيانات المُدخلة في النظام. جميع الأرقام تعكس الوضع الحالي للنظام.
                                </p>
                            </div>
                        </div>
                    </div>
                    <!-- End of Reports & Statistics Section -->

                    <!-- Additional Reports & Analytics Section -->
                    <div class="content-card additional-reports-section">
                        <div class="card-body" style="padding: 0;">
                            <!-- Employee Report Widget -->
                            <div id="employee-report-widget"></div>

                            <!-- Charts Section -->
                            <div id="dashboard-charts"></div>

                            <!-- Reports Widget -->
                            <div id="dashboard-reports-widget"></div>
                        </div>
                    </div>
                    <!-- End of Additional Reports & Analytics Section -->

                    <!-- Content Grid - Recent Activity, Tasks, Quick Stats -->
                    <div class="content-grid">
                            <div class="content-card">
                                <div class="card-header">
                                    <h2 class="card-title">
                                        <i class="fas fa-clock ml-2"></i>
                                        الأنشطة الأخيرة
                                    </h2>
                                </div>
                                <div class="card-body">
                                    <div id="recent-activities" class="activity-list">
                                        <div class="empty-state">
                                            <i class="fas fa-inbox text-4xl text-gray-300 mb-4"></i>
                                            <p class="text-gray-500">لا توجد أنشطة حديثة</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="content-card">
                                <div class="card-header">
                                    <h2 class="card-title">
                                        <i class="fas fa-tasks ml-2"></i>
                                        مهامي
                                    </h2>
                                    <a href="#user-tasks" class="text-sm text-blue-600 hover:text-blue-800"
                                        style="text-decoration: none;">
                                        عرض الكل <i class="fas fa-arrow-left mr-1"></i>
                                    </a>
                                </div>
                                <div class="card-body">
                                    <div id="user-tasks-widget" class="activity-list">
                                        <div class="empty-state">
                                            <i class="fas fa-tasks text-4xl text-gray-300 mb-4"></i>
                                            <p class="text-gray-500">لا توجد مهام</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="content-card">
                                <div class="card-header">
                                    <h2 class="card-title">
                                        <i class="fas fa-chart-line ml-2"></i>
                                        الإحصائيات السريعة
                                    </h2>
                                </div>
                                <div class="card-body">
                                    <div class="stats-grid">
                                        <div class="stat-item">
                                            <span class="stat-label">حوادث هذا الأسبوع</span>
                                            <span class="stat-value" id="week-incidents">0</span>
                                        </div>
                                        <div class="stat-item">
                                            <span class="stat-label">تصاريح مفتوحة</span>
                                            <span class="stat-value" id="open-ptw">0</span>
                                        </div>
                                        <div class="stat-item">
                                            <span class="stat-label">تدريبات مكتملة</span>
                                            <span class="stat-value" id="completed-training">0</span>
                                        </div>
                                        <div class="stat-item">
                                            <span class="stat-label">أيام بدون حوادث</span>
                                            <span class="stat-value" id="days-without-incident">0</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                    </div>
                    <!-- End of Content Grid -->
                </section>

                <!-- Other Sections (will be added dynamically) -->
                <section id="users-section" class="section" role="region" aria-label="قسم المستخدمين"></section>

                <!-- User Tasks Section -->
                <section id="user-tasks-section" class="section" role="region" aria-label="قسم مهام المستخدمين">
                </section>
                <section id="employees-section" class="section" role="region" aria-label="قسم قاعدة بيانات الموظفين">
                </section>
                <section id="incidents-section" class="section" role="region" aria-label="قسم الحوادث"></section>
                <section id="nearmiss-section" class="section" role="region" aria-label="قسم الحوادث الوشيكة"></section>
                <section id="ptw-section" class="section" role="region" aria-label="قسم تصاريح العمل"></section>
                <section id="training-section" class="section" role="region" aria-label="قسم التدريب"></section>
                <section id="clinic-section" class="section" role="region" aria-label="قسم العيادة الطبية"></section>
                <section id="fire-equipment-section" class="section" role="region" aria-label="قسم فحص معدات الحريق">
                </section>
                <!-- Alias for app tester compatibility -->
                <section id="fireequipment-section" class="section" role="region" aria-label="قسم فحص معدات الحريق"
                    style="display: none;"></section>
                <section id="periodic-inspections-section" class="section" role="region"
                    aria-label="قسم الفحوصات الدورية"></section>
                <!-- Alias for app tester compatibility -->
                <section id="periodicinspections-section" class="section" role="region"
                    aria-label="قسم الفحوصات الدورية" style="display: none;"></section>
                <section id="ppe-section" class="section" role="region" aria-label="قسم مهمات الوقاية الشخصية">
                </section>
                <section id="violations-section" class="section" role="region" aria-label="قسم المخالفات"></section>
                <section id="contractors-section" class="section" role="region" aria-label="قسم المقاولين"></section>
                <section id="behavior-monitoring-section" class="section" role="region"
                    aria-label="قسم مراقبة التصرفات"></section>
                <!-- Alias for app tester compatibility -->
                <section id="behaviormonitoring-section" class="section" role="region" aria-label="قسم مراقبة التصرفات"
                    style="display: none;"></section>
                <section id="chemical-safety-section" class="section" role="region" aria-label="قسم المواد الكيميائية">
                </section>
                <!-- Alias for app tester compatibility -->
                <section id="chemicalsafety-section" class="section" role="region" aria-label="قسم المواد الكيميائية"
                    style="display: none;"></section>
                <section id="daily-observations-section" class="section" role="region"
                    aria-label="قسم الملاحظات اليومية"></section>
                <section id="iso-section" class="section" role="region" aria-label="قسم نظام ISO"></section>
                <section id="emergency-section" class="section" role="region" aria-label="قسم تنبيهات الطوارئ">
                </section>
                <section id="risk-assessment-section" class="section" role="region" aria-label="قسم تقييم المخاطر">
                </section>
                <!-- Alias for app tester compatibility -->
                <section id="riskassessment-section" class="section" role="region" aria-label="قسم تقييم المخاطر"
                    style="display: none;"></section>
                <section id="sop-jha-section" class="section" role="region" aria-label="قسم تعليمات السلامة SOP-JHA">
                </section>
                <!-- Alias for app tester compatibility -->
                <section id="sopjha-section" class="section" role="region" aria-label="قسم تعليمات السلامة SOP-JHA"
                    style="display: none;"></section>
                <section id="legal-documents-section" class="section" role="region"
                    aria-label="قسم المستندات القانونية"></section>
                <!-- Alias for app tester compatibility -->
                <section id="legaldocuments-section" class="section" role="region" aria-label="قسم المستندات القانونية"
                    style="display: none;"></section>
                <section id="sustainability-section" class="section" role="region" aria-label="قسم الاستدامة البيئية">
                </section>
                <section id="safety-budget-section" class="section" role="region"
                    aria-label="قسم ميزانية السلامة وتتبع الإنفاق"></section>
                <!-- Alias for app tester compatibility -->
                <section id="safetybudget-section" class="section" role="region"
                    aria-label="قسم ميزانية السلامة وتتبع الإنفاق" style="display: none;"></section>
                <section id="safety-performance-kpis-section" class="section" role="region"
                    aria-label="قسم مؤشرات الأداء لإدارة السلامة"></section>
                <!-- Alias for app tester compatibility -->
                <section id="safetyperformancekpis-section" class="section" role="region"
                    aria-label="قسم مؤشرات الأداء لإدارة السلامة" style="display: none;"></section>
                <section id="safety-health-management-section" class="section" role="region"
                    aria-label="قسم إدارة السلامة والصحة"></section>
                <!-- Alias for app tester compatibility -->
                <section id="safetyhealthmanagement-section" class="section" role="region"
                    aria-label="قسم إدارة السلامة والصحة" style="display: none;"></section>
                <section id="action-tracking-section" class="section" role="region"
                    aria-label="قسم سجل متابعة الإجراءات"></section>
                <!-- Alias for app tester compatibility -->
                <section id="actiontrackingregister-section" class="section" role="region"
                    aria-label="قسم سجل متابعة الإجراءات" style="display: none;"></section>
                <section id="ai-assistant-section" class="section" role="region"
                    aria-label="قسم مساعد الذكاء الاصطناعي"></section>
                <!-- Alias for app tester compatibility -->
                <section id="aiassistant-section" class="section" role="region" aria-label="قسم مساعد الذكاء الاصطناعي"
                    style="display: none;"></section>
                <!-- User AI Assistant Section -->
                <section id="useraiassistant-section" class="section" role="region"
                    aria-label="قسم مساعد المستخدم الذكي"></section>
                <!-- User Tasks Section Alias -->
                <section id="usertasks-section" class="section" role="region" aria-label="قسم مهام المستخدم"
                    style="display: none;"></section>
                <!-- Reports Section -->
                <section id="reports-section" class="section" role="region" aria-label="قسم التقارير"></section>
                <!-- HSE Section -->
                <section id="hse-section" class="section" role="region" aria-label="قسم HSE" style="display: none;">
                </section>
                <!-- Alias for app tester compatibility -->
                <section id="dailyobservations-section" class="section" role="region" aria-label="قسم الملاحظات اليومية"
                    style="display: none;"></section>
                <!-- App Tester Section -->
                <section id="apptester-section" class="section" role="region" aria-label="قسم اختبار التطبيق"></section>
                <!-- Settings Section -->
                <section id="settings-section" class="section" role="region" aria-label="قسم الإعدادات">
                    <div class="section-header">
                        <h2 class="section-title">
                            <i class="fas fa-cog ml-2"></i>
                            الإعدادات
                        </h2>
                    </div>

                    <div class="settings-container">
                        <!-- Regular Settings (for all users) -->
                        <div class="settings-group">
                            <div class="settings-group-header">
                                <h3 class="settings-group-title">
                                    <i class="fas fa-user-cog ml-2"></i>
                                    إعدادات المستخدم
                                </h3>
                                <p class="settings-group-subtitle">
                                    تخصيص إعداداتك الشخصية
                                </p>
                            </div>
                            <div class="settings-group-content">
                                <p class="text-gray-600 dark:text-gray-400">إعدادات المستخدم ستضاف هنا...</p>
                            </div>
                        </div>
                    </div>
                </section>
                
                <!-- Issue Tracking Section -->
                <section id="issue-tracking-section" class="section" role="region" aria-label="قسم تتبع المشاكل"></section>
                <section id="change-management-section" class="section" role="region" aria-label="قسم إدارة التغيرات"></section>
            </main>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notification-container" class="notification-container"></div>

    <!-- Loading Overlay (مخفي - التحميل في الخلفية) -->
    <div id="loading-overlay" class="loading-overlay" style="display: none !important; visibility: hidden;">
        <div class="loading-spinner">
            <!-- Progress bar container -->
            <div style="width: 300px; margin: 0 auto;">
                <div style="width: 100%; height: 6px; background: rgba(59, 130, 246, 0.2); border-radius: 3px; overflow: hidden; margin-bottom: 16px;">
                    <div class="loading-progress-animation" style="height: 100%; background: linear-gradient(90deg, #3b82f6, #2563eb, #3b82f6); background-size: 200% 100%; border-radius: 3px; animation: loadingProgress 1.5s ease-in-out infinite;"></div>
                </div>
            </div>
            <p class="mt-4 text-gray-600 loading-message">جاري تحميل النظام...</p>
            <!-- Progress bar will be added dynamically -->
        </div>
    </div>

    <!-- User AI Assistant Chat Button -->
    <button id="user-ai-assistant-btn" class="user-ai-assistant-btn" aria-label="مساعد النظام" title="مساعد النظام">
        <i class="fas fa-robot"></i>
        <span class="user-ai-assistant-badge" id="user-ai-assistant-badge" style="display: none;">!</span>
    </button>

    <!-- User AI Assistant Chat Window -->
    <div id="user-ai-assistant-chat" class="user-ai-assistant-chat" style="display: none;">
        <div class="user-ai-assistant-header">
            <div class="user-ai-assistant-header-content">
                <i class="fas fa-robot ml-2"></i>
                <div>
                    <h3>مساعد النظام</h3>
                    <p class="text-xs text-gray-500">System Assistant</p>
                </div>
            </div>
            <div class="user-ai-assistant-header-actions">
                <button id="user-ai-assistant-clear" class="user-ai-assistant-header-btn" aria-label="مسح المحادثة"
                    title="مسح المحادثة">
                    <i class="fas fa-trash-alt"></i>
                </button>
                <button id="user-ai-assistant-close" class="user-ai-assistant-close" aria-label="إغلاق">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        <div class="user-ai-assistant-messages" id="user-ai-assistant-messages">
            <div class="user-ai-message user-ai-message-assistant">
                <div class="user-ai-message-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="user-ai-message-content">
                    <p>مرحباً! أنا مساعد النظام. كيف يمكنني مساعدتك اليوم؟</p>
                    <p class="text-xs text-gray-500 mt-1">Hello! I'm the System Assistant. How can I help you today?</p>
                </div>
            </div>
        </div>
        <div class="user-ai-assistant-input-container">
            <div class="user-ai-assistant-quick-actions" id="user-ai-assistant-quick-actions">
                <button class="user-ai-quick-action-btn" data-action="how-to-report-incident">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>كيف أسجل حادث؟</span>
                </button>
                <button class="user-ai-quick-action-btn" data-action="training-reports">
                    <i class="fas fa-graduation-cap"></i>
                    <span>تقارير التدريب</span>
                </button>
                <button class="user-ai-quick-action-btn" data-action="budget-status">
                    <i class="fas fa-wallet"></i>
                    <span>حالة الميزانية</span>
                </button>
                <button class="user-ai-quick-action-btn" data-action="expired-permits">
                    <i class="fas fa-id-card"></i>
                    <span>تصاريح منتهية</span>
                </button>
            </div>
            <div class="user-ai-assistant-input-wrapper">
                <label for="user-ai-assistant-input" class="sr-only">اكتب سؤالك هنا / Type your question here</label>
                <input type="text" id="user-ai-assistant-input" class="user-ai-assistant-input"
                    placeholder="اكتب سؤالك هنا... / Type your question here..." autocomplete="off"
                    aria-label="اكتب سؤالك هنا / Type your question here">
                <button id="user-ai-assistant-send" class="user-ai-assistant-send" aria-label="إرسال">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <!-- External Libraries -->
    <!-- XLSX يتم تحميله في <head> بسكريبت fallback متعدد المصادر -->

    <!-- 🚀 PERFORMANCE OPTIMIZATION: Enhanced Loading System -->
    <!-- تحميل النظام المحسن أولاً لتسريع بدء التطبيق -->

    <!-- إعدادات التطبيق (قبل أي موديول): __CONFIG__.HSE_API_SECRET للإنتاج -->
    <script src="js/config.js"></script>

    <!-- Enhanced Loader - شاشة التحميل المحسنة (يجب أن تُحمّل أولاً) -->
    <script src="js/modules/enhanced-loader.js" defer></script>

    <!-- Lazy Loader - نظام التحميل الديناميكي -->
    <script src="js/modules/lazy-loader.js" defer></script>

    <!-- Main App - Refactored Modules -->
    <!-- 1. Utils and Constants (must be loaded first) -->
    <script src="js/modules/app-utils.js" defer></script>

    <!-- 1.1 DOM Safety Utilities (safe DOM access functions) -->
    <script src="js/modules/dom-safety-utils.js" defer></script>

    <!-- 1.5 Sync Improvements (loaded before services) -->
    <script src="js/modules/sync-improvements.js" defer></script>

    <!-- 1.6 Real-Time Sync Manager (Live Data Updates) -->
    <script src="js/modules/realtime-sync-manager.js" defer></script>

    <!-- 2. Services (Data fetching, Google Integration, etc.) -->
    <!-- CRITICAL: DataManager is defined here and must be loaded before login-init-fixed.js -->
    <!-- Load individual service modules first (they expose themselves to window) -->
    <script src="js/modules/services/data-manager.js" defer></script>
    <script src="js/modules/services/periodic-inspection-store.js" defer></script>
    <script src="js/modules/services/approval-circuits.js" defer></script>
    <script src="js/modules/services/audit-log.js" defer></script>
    <script src="js/modules/services/user-activity-log.js" defer></script>
    <script src="js/modules/services/cloud-storage-integration.js" defer></script>
    <script src="js/modules/services/workflow.js" defer></script>
    <script src="js/modules/services/supabase-integration.js" defer></script>
    <script src="js/modules/services/connection-monitor.js" defer></script>
    <script src="js/modules/services/ai-assistant.js" defer></script>
    <script src="js/modules/services/map-coordinates-manager.js" defer></script>
    <script src="js/modules/services/issue-tracking.js" defer></script>
    <!-- Main services loader (ensures all services are available and adds helper functions) -->
    <script src="js/modules/app-services.js" defer></script>

    <!-- 3. UI (UI rendering and DOM manipulation) -->
    <script src="js/modules/app-ui.js" defer></script>

    <!-- 4. Modules (Auth, Dashboard, Users, etc.) -->
    <!-- CRITICAL: Auth is defined here and must be loaded before login-init-fixed.js -->
    <!-- تم تقسيم الملف لتحسين الأداء -->
    <!-- تحميل Auth و Dashboard من ملفات منفصلة أولاً -->
    <script src="js/modules/auth.js?v=3" defer></script>
    <script src="js/modules/dashboard.js" defer></script>
    <!-- تحميل باقي الموديولات من الملفات المقسمة -->
    <!-- تم تقسيم app-modules.js إلى 31 ملف منفصل لتحسين الأداء والصيانة -->
    <script src="js/modules/modules-loader.js" defer></script>

    <!-- 5. Events (Event listeners and initialization) -->
    <script src="js/modules/app-events.js" defer></script>

    <!-- Login Init - تحميل مباشر -->
    <script src="login-init-fixed.js?v=3" defer></script>

    <!-- App Bootstrap - نظام بدء التطبيق (يدير عملية التحميل) -->
    <!-- يجب تحميله بعد جميع الملفات الأخرى لضمان تحميل DataManager و Auth -->
    <script src="js/app-bootstrap.js" defer></script>

    <!-- Dynamic Module Loader -->
    <script src="js/modules/dynamic-module-loader.js" defer></script>
    <script src="js/modules/backup-ui.js" defer></script>

    <!-- Original app.js تم حذفه بعد التقسيم - تم استبداله بالملفات المقسمة -->

    <!-- Service Worker Registration -->
    <script>
        // تسجيل Service Worker للتخزين المؤقت وتحسين الأداء
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                const __isDev = (window.location.hostname === 'localhost' ||
                    window.location.hostname === '127.0.0.1' ||
                    window.location.search.includes('dev=true'));

                // التحقق من أن الصفحة لا تُفتح من file:// (null protocol)
                const protocol = window.location.protocol;
                if (protocol === 'file:' || protocol === 'null' || !protocol || protocol === '') {
                    // استخدام console.debug بدلاً من console.warn لتقليل الضوضاء
                    if (console.debug) {
                        console.debug('ℹ️ Service Worker لا يعمل مع file:// protocol');
                    }
                    return;
                }

                // تحديد المسار الصحيح لـ Service Worker تلقائياً
                const currentPath = window.location.pathname;
                let swPath;

                // إذا كان المسار الحالي يحتوي على /Frontend/، استخدمه
                if (currentPath.includes('/Frontend/')) {
                    swPath = '/Frontend/service-worker.js';
                }
                // إذا كان في الجذر، استخدم المسار النسبي
                else {
                    swPath = '/service-worker.js';
                }

                if (__isDev) {
                    console.log('📍 المسار الحالي:', currentPath);
                    console.log('🔧 مسار Service Worker:', swPath);
                }

                // محاولة التسجيل بالمسار المحدد
                try {
                    const registration = await navigator.serviceWorker.register(swPath);
                    if (__isDev) console.log('✅ Service Worker مسجل بنجاح:', registration.scope);

                    // التحقق من التحديثات
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        if (__isDev) console.log('🔄 يوجد تحديث جديد للـ Service Worker');

                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                if (__isDev) console.log('✨ تحديث جديد متاح! سيتم تطبيقه عند إعادة تحميل الصفحة.');

                                // يمكن إضافة إشعار للمستخدم هنا
                                if (window.Notification && typeof window.Notification.info === 'function') {
                                    window.Notification.info('يوجد تحديث جديد! يُرجى إعادة تحميل الصفحة.');
                                }
                            }
                        });
                    });
                } catch (error) {
                    // عرض التحذيرات فقط في وضع التطوير
                    if (__isDev) {
                        console.warn('⚠️ فشل تسجيل Service Worker:', error);
                        console.warn('💡 تفاصيل الخطأ:', {
                            message: error.message,
                            path: swPath,
                            location: window.location.href
                        });
                    }

                    // محاولة بديلة بالمسار الآخر
                    const altPath = swPath === '/service-worker.js'
                        ? '/Frontend/service-worker.js'
                        : '/service-worker.js';

                    if (__isDev) console.log('🔄 محاولة مسار بديل:', altPath);

                    try {
                        const registration = await navigator.serviceWorker.register(altPath);
                        if (__isDev) console.log('✅ نجح التسجيل بالمسار البديل:', registration.scope);
                    } catch (altError) {
                        // عرض رسائل الخطأ فقط في وضع التطوير
                        if (__isDev) {
                            console.error('❌ فشلت جميع محاولات تسجيل Service Worker');
                            console.error('💡 تلميح: تحقق من أن ملف service-worker.js موجود ويتم تقديمه بـ MIME type صحيح');
                        }
                        // في الإنتاج، نقمع الرسائل لأن Service Worker اختياري
                    }
                }
            });
        } else {
            // Service Worker غير مدعوم - هذه حالة طبيعية في بعض المتصفحات القديمة
            // لا حاجة لعرض تحذير لأن Service Worker اختياري
            if (window.location.hostname === 'localhost' ||
                window.location.hostname === '127.0.0.1' ||
                window.location.search.includes('dev=true')) {
                console.debug('ℹ️ Service Worker غير مدعوم في هذا المتصفح');
            }
        }
    </script>

    <!-- Initialize Additional Systems -->
    <script>
        // تهيئة الأنظمة الإضافية بعد تحميل الصفحة
        window.addEventListener('app:ready', async () => {
            const __isDev = (window.location.hostname === 'localhost' ||
                window.location.hostname === '127.0.0.1' ||
                window.location.search.includes('dev=true'));
            if (__isDev) console.log('📱 التطبيق جاهز - تهيئة الأنظمة الإضافية...');

            // تهيئة واجهة الإعدادات عند فتح قسم الإعدادات
            const settingsNav = document.querySelector('a[data-section="settings"]');
            if (settingsNav) {
                settingsNav.addEventListener('click', () => {
                    setTimeout(() => {
                        if (typeof BackupUI !== 'undefined') {
                            BackupUI.init();
                        }
                    }, 500);
                });
            }
        });
    </script>

    <!-- Auto-assign ids/names to form fields (fix autofill warnings) -->
    <script>
        (function () {
            'use strict';

            let autoFieldCounter = 0;

            function sanitizeId(value) {
                const raw = String(value || '').trim();
                if (!raw) return '';
                const cleaned = raw.replace(/[^a-z0-9\-_:.]/gi, '-');
                if (!cleaned) return '';
                return /^\d/.test(cleaned) ? `fld-${cleaned}` : cleaned;
            }

            function ensureFieldIdentifiers(field) {
                if (!field || field.nodeType !== 1) return;
                if (field.tagName !== 'INPUT' && field.tagName !== 'SELECT' && field.tagName !== 'TEXTAREA') return;

                // Skip hidden inputs; they are not used for autofill
                if (field.tagName === 'INPUT' && String(field.type || '').toLowerCase() === 'hidden') {
                    return;
                }

                const hasId = field.hasAttribute('id') && field.id.trim() !== '';
                const hasName = field.hasAttribute('name') && field.name.trim() !== '';

                if (hasId && hasName) return;

                let desiredId = hasId ? field.id : '';
                let desiredName = hasName ? field.name : '';

                if (!desiredId && desiredName) {
                    desiredId = sanitizeId(desiredName);
                }

                if (!desiredId) {
                    autoFieldCounter += 1;
                    desiredId = `auto-field-${autoFieldCounter}`;
                }

                // ضمان عدم تكرار الـ id
                if (document.getElementById(desiredId) && document.getElementById(desiredId) !== field) {
                    autoFieldCounter += 1;
                    desiredId = `${desiredId}-${autoFieldCounter}`;
                }

                if (!hasId) {
                    field.id = desiredId;
                    field.setAttribute('data-auto-id', 'true');
                }

                if (!hasName) {
                    desiredName = sanitizeId(desiredId) || desiredId;
                    field.name = desiredName;
                    field.setAttribute('data-auto-name', 'true');
                }
            }

            function ensureAllFormFields(root) {
                if (!root || !root.querySelectorAll) return;
                const fields = root.querySelectorAll('input, select, textarea');
                fields.forEach(ensureFieldIdentifiers);
            }

            // تشغيل أولي بعد تحميل DOM
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => {
                    ensureAllFormFields(document);
                });
            } else {
                ensureAllFormFields(document);
            }

            // مراقبة العناصر الجديدة التي تُضاف ديناميكياً
            const observer = new MutationObserver((mutations) => {
                for (const mutation of mutations) {
                    mutation.addedNodes.forEach((node) => {
                        if (node.nodeType !== 1) return;
                        if (node.matches && node.matches('input, select, textarea')) {
                            ensureFieldIdentifiers(node);
                        }
                        ensureAllFormFields(node);
                    });
                }
            });

            if (document.body) {
                observer.observe(document.body, { childList: true, subtree: true });
            } else {
                document.addEventListener('DOMContentLoaded', () => {
                    observer.observe(document.body, { childList: true, subtree: true });
                });
            }
        })();
    </script>

    <!-- Auto Compatibility Check (Development / Opt-in only) -->
    <script>
        (function () {
            const isDev = (window.location.hostname === 'localhost' ||
                window.location.hostname === '127.0.0.1' ||
                window.location.search.includes('dev=true'));

            if (isDev || localStorage.getItem('enable-compat-check') === 'true') {
                const s = document.createElement('script');
                s.src = 'auto-compatibility-check.js';
                s.defer = true;
                document.head.appendChild(s);
            }
        })();
    </script>

    <!-- Unit Tests (Development Only) -->
    <script>
        // تحميل Unit Tests فقط في وضع التطوير
        // انتظار تحميل AppState قبل التحقق من debugMode
        (function () {
            function loadUnitTests() {
                const isLocal = window.location.hostname === 'localhost' ||
                    window.location.hostname.includes('127.0.0.1') ||
                    window.location.hostname === '';
                const isDebugMode = typeof AppState !== 'undefined' && AppState?.debugMode;

                if (isLocal || isDebugMode) {
                    const script = document.createElement('script');
                    script.src = 'js/tests/unit-tests.js';
                    script.defer = true;
                    document.head.appendChild(script);
                }
            }

            // محاولة التحميل فوراً (إذا كان AppState متاحاً)
            if (typeof AppState !== 'undefined') {
                loadUnitTests();
            } else {
                // انتظار تحميل AppState
                let attempts = 0;
                const maxAttempts = 50; // 5 ثواني كحد أقصى
                const checkInterval = setInterval(() => {
                    attempts++;
                    if (typeof AppState !== 'undefined' || attempts >= maxAttempts) {
                        clearInterval(checkInterval);
                        loadUnitTests();
                    }
                }, 100);
            }
        })();
    </script>

    <!-- Dashboard Enhancements Script -->
    <script src="js/dashboard-enhancements.js" defer></script>

    <!-- ✅ Chrome DevTools Final Protection - Last Line of Defense -->
    <script>
        // ✅✅✅ Chrome-Specific Final Protection ✅✅✅
        // هذا السكربت يعمل كخط دفاع نهائي في Chrome
        (function() {
            'use strict';
            
            // ✅ Chrome DevTools Console Protection - مع try/catch لتجنب التكرار اللانهائي
            if (typeof console !== 'undefined') {
                var _finalError = console.error;
                console.error = function() {
                    try {
                        for (var i = 0; i < arguments.length; i++) {
                            var arg = arguments[i];
                            if (arg) {
                                var str = '';
                                try {
                                    str = (typeof arg === 'string' ? arg : (arg.message || arg.stack || '')).toLowerCase();
                                } catch (e0) {
                                    return;
                                }
                                if (str.indexOf('uploadmanager') !== -1 || str.indexOf('518') !== -1 ||
                                    str.indexOf('cannot read properties of undefined') !== -1 ||
                                    str.indexOf('reading \'document\'') !== -1 ||
                                    str.indexOf('htmlstyleelement') !== -1 ||
                                    str.indexOf('htmlimageelement') !== -1 ||
                                    str.indexOf('svgsvgelement') !== -1 ||
                                    str.indexOf('anonymous') !== -1 ||
                                    str.indexOf('contentdocument') !== -1 ||
                                    str.indexOf('contentwindow') !== -1) {
                                    return;
                                }
                            }
                        }
                        return _finalError.apply(console, arguments);
                    } catch (e2) {
                        return;
                    }
                };
                var _finalWarn = console.warn;
                console.warn = function() {
                    try {
                        for (var i = 0; i < arguments.length; i++) {
                            var arg = arguments[i];
                            if (arg) {
                                var str = '';
                                try {
                                    str = (typeof arg === 'string' ? arg : (arg.message || arg.stack || '')).toLowerCase();
                                } catch (e0) {
                                    return;
                                }
                                if (str.indexOf('uploadmanager') !== -1 || str.indexOf('518') !== -1) {
                                    return;
                                }
                            }
                        }
                        return _finalWarn.apply(console, arguments);
                    } catch (e2) {
                        return;
                    }
                };
            }
            
            // ✅ Chrome Extension Error Suppression
            if (typeof chrome !== 'undefined' && chrome.runtime) {
                try {
                    // منع أخطاء Chrome Extensions من الظهور
                    const originalError = chrome.runtime.lastError;
                    Object.defineProperty(chrome.runtime, 'lastError', {
                        get: function() {
                            const err = originalError;
                            if (err && err.message) {
                                const msg = String(err.message).toLowerCase();
                                if (msg.indexOf('uploadmanager') !== -1 ||
                                    msg.indexOf('contentdocument') !== -1 ||
                                    msg.indexOf('contentwindow') !== -1) {
                                    return null;
                                }
                            }
                            return err;
                        },
                        configurable: true
                    });
                } catch(e) {}
            }
            
            // ✅ Final window.onerror Protection - مع try/catch لتجنب التكرار اللانهائي
            var _finalOnError = window.onerror;
            window.onerror = function(msg, url, line, col, error) {
                try {
                    if (line === 518 || String(line) === '518') {
                        return true;
                    }
                    var msgStr = String(msg || '').toLowerCase();
                    var urlStr = String(url || '').toLowerCase();
                    var errorStack = '';
                    try {
                        if (error && error.stack) errorStack = String(error.stack).toLowerCase();
                    } catch (e1) {
                        return true;
                    }
                    var combined = msgStr + ' ' + urlStr + ' ' + errorStack;
                    if (combined.indexOf('uploadmanager') !== -1 || combined.indexOf('518') !== -1 ||
                        (combined.indexOf('cannot read') !== -1 && combined.indexOf('document') !== -1) ||
                        combined.indexOf('htmlstyleelement') !== -1 ||
                        combined.indexOf('htmlimageelement') !== -1 ||
                        combined.indexOf('svgsvgelement') !== -1) {
                        return true;
                    }
                    if (_finalOnError) {
                        return _finalOnError.apply(this, arguments);
                    }
                } catch (e2) {
                    return true;
                }
                return false;
            };
            
            // ✅ Final Error Event Protection
            window.addEventListener('error', function(e) {
                const msg = String(e.message || '').toLowerCase();
                const file = String(e.filename || '').toLowerCase();
                const lineno = e.lineno;
                
                if (lineno === 518 || 
                    msg.indexOf('uploadmanager') !== -1 ||
                    file.indexOf('uploadmanager') !== -1 ||
                    (msg.indexOf('cannot read') !== -1 && msg.indexOf('document') !== -1)) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    return false;
                }
            }, true);
            
            // ✅ Final UnhandledRejection Protection
            window.addEventListener('unhandledrejection', function(e) {
                const reason = e.reason;
                const reasonStr = String(reason || '').toLowerCase();
                const reasonMsg = (reason && reason.message ? String(reason.message) : '').toLowerCase();
                const reasonStack = (reason && reason.stack ? String(reason.stack) : '').toLowerCase();
                const combined = reasonStr + ' ' + reasonMsg + ' ' + reasonStack;
                
                if (combined.indexOf('uploadmanager') !== -1 ||
                    combined.indexOf('518') !== -1 ||
                    (combined.indexOf('cannot read') !== -1 && combined.indexOf('document') !== -1)) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    return false;
                }
            }, true);
            
            // ✅ Chrome DevTools Protocol Protection
            if (typeof window.chrome !== 'undefined' && window.chrome.devtools) {
                try {
                    // منع Chrome DevTools من عرض أخطاء uploadmanager
                    const originalConsole = window.console;
                    Object.defineProperty(window, 'console', {
                        get: function() {
                            return originalConsole;
                        },
                        set: function() {
                            // منع تغيير console
                        },
                        configurable: false
                    });
                } catch(e) {}
            }
            
            console.log('%c✅ Chrome-Specific Error Suppressor Active (Final Layer)', 'color: #4285f4; font-weight: bold; font-size: 14px;');
        })();
    </script>
</body>

</html>
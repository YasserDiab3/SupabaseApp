# الخطوة التالية — مشروعك على Supabase جاهز للإعداد

تم تطبيق بيانات مشروعك في الواجهة الأمامية.

---

## ما تم تطبيقه

- **رابط المشروع:** `https://rtxleteymcqmtzrozckh.supabase.co`
- **المفتاح العام (anon):** تم وضعه في `SupabaseApp/Frontend/js/modules/app-utils.js`
- التطبيق جاهز للاتصال بمشروعك بعد تنفيذ الترحيلات ونشر الدالة (انظر أدناه).
- **مستخدم افتراضي للاختبار:** بعد تطبيق الترحيلات يُدخل مستخدم تجريبي تلقائياً — **البريد:** `admin@test.com` ، **كلمة المرور:** `admin123` (للاختبار فقط؛ يُفضّل حذفه أو تغيير كلمة المرور في الإنتاج).

---

## الخطوات المطلوبة منك الآن (بالترتيب)

### 1) تثبيت Supabase CLI (مطلوب — إن ظهرت رسالة "supabase is not recognized")

على **Windows** اختر أحد الطرق:

**الطريقة أ — تثبيت عبر Scoop (موصى بها):**

1. افتح PowerShell (عادي أو كمسؤول) ونفّذ:
   ```powershell
   Set-ExecutionPolicy RemoteSigned -Scope CurrentUser
   iwr -useb get.scoop.sh | iex
   scoop install supabase
   ```
2. أعد فتح الطرفية ثم تحقق: `supabase --version`

**الطريقة ب — استخدام npx بدون تثبيت عالمي:**

يمكنك تشغيل الأوامر عبر `npx supabase` بدلاً من `supabase` (يحتاج Node.js):

- بدلاً من `supabase login` استخدم: `npx supabase login`
- بدلاً من `supabase link ...` استخدم: `npx supabase link --project-ref rtxleteymcqmtzrozckh`
- وهكذا لباقي الأوامر.

**الطريقة ج — السكربت الرسمي لـ Windows:**

```powershell
irm https://windows.supabase.com/install.ps1 | iex
```

ثم أعد فتح الطرفية وتحقق: `supabase --version`.

---

### 2) فتح الطرفية والانتقال لمجلد الخلفية

**مهم:** انتقل من **جذر المشروع** (المجلد الذي فيه مجلد `SupabaseApp`)، وليس من داخل `SupabaseApp`:

```powershell
cd "d:\App\v.2-ok run"
cd SupabaseApp\Backend
```

أو في سطر واحد:

```powershell
cd "d:\App\v.2-ok run\SupabaseApp\Backend"
```

إذا كنت بالفعل داخل `SupabaseApp\Backend` فلا تنفّذ `cd SupabaseApp/Backend` مرة أخرى (وإلا سيبحث عن مجلد غير موجود).

### 3) تسجيل الدخول وربط المشروع

```bash
supabase login
```

ثم ربط المشروع (معرف مشروعك: **rtxleteymcqmtzrozckh**):

```bash
supabase link --project-ref rtxleteymcqmtzrozckh
```

### 4) تطبيق ترحيلات قاعدة البيانات (إنشاء الجداول)

```bash
supabase db push
```

هذا ينشئ جميع الجداول: الأساسية + إدارة التغيرات + إكمال جداول النسخة الحالية (سجلات الحوادث، العيادة المقاولين، ISO، الاستدامة، الطوارئ، الميزانية، إعدادات الشركة، وغيرها).

### 5) نشر Edge Function (واجهة API التطبيق)

```bash
supabase functions deploy hse-api
```

بعد النشر، عنوان الدالة سيكون:

`https://rtxleteymcqmtzrozckh.supabase.co/functions/v1/hse-api`

### 6) تشغيل الواجهة الأمامية محلياً والتحقق

من مجلد الواجهة:

```bash
cd "d:\App\v.2-ok run\SupabaseApp\Frontend"
npx serve .
```

ثم افتح في المتصفح الرابط المعروض (مثل `http://localhost:3000`)، سجّل الدخول، وجرّب أحد الموديولات (مثل إدارة التغيرات أو الحوادث).

---

## ملخص الأوامر (نسخ ولصق)

**مهم:** يجب تنفيذ أوامر `link` و `db push` من مجلد **Backend** (لأن ملفات الترحيل فيه فقط):

```powershell
cd "d:\App\v.2-ok run\SupabaseApp\Backend"
supabase login
supabase link --project-ref rtxleteymcqmtzrozckh
supabase db push
supabase functions deploy hse-api
```

إذا نفذت الأوامر من مجلد `SupabaseApp` (بدون `Backend`) فلن يُطبَّق أي ترحيل ولن تظهر الجداول في Table Editor.

إذا كان `supabase` غير معروف، استبدل كل `supabase` بـ `npx supabase` (مثال: `npx supabase login`).

ثم لتشغيل الواجهة:

```powershell
cd "d:\App\v.2-ok run\SupabaseApp\Frontend"
npx serve .
```

---

## التحقق من أن كل شيء يعمل

1. **قاعدة البيانات:** من [Supabase Dashboard](https://app.supabase.com) → مشروعك → **Table Editor** — يجب أن تظهر الجداول بعد `db push`.
2. **Edge Function:** من **Edge Functions** — يجب أن تظهر الدالة `hse-api` وحالة نشطة بعد `deploy`.
3. **التطبيق:** بعد تشغيل `npx serve .` وفتح الصفحة، لا تظهر أخطاء اتصال أو "Supabase غير مفعّل" في الكونسول (F12).

---

## إضافة أول مستخدم (عند ظهور "لا يوجد مستخدمون مسجلون")

نسخة Supabase لا تستخدم Google Sheets؛ المستخدمون يُخزَّنون في جدول **users** على Supabase.

**الطريقة 1 — من Supabase Dashboard (موصى بها لأول مستخدم):**

1. افتح [Supabase Dashboard](https://supabase.com/dashboard/project/rtxleteymcqmtzrozckh) → **Table Editor** → جدول **users**.
2. اضغط **Insert row** (أو **Insert** → **Row**).
3. أدخل على الأقل:
   - **id:** أي معرف فريد (مثل بريدك أو `admin1`).
   - **data:** كائن JSON يحتوي على الحقول، مثلاً:
     ```json
     {"name":"مدير النظام","email":"admin@example.com","role":"admin","passwordHash":"ضع_هنا_كلمة_مرور_مشفّرة"}
     ```
   - أو اترك **data** كـ `{}` وضَع الحقول في أعمدة منفصلة إن وُجدت.

**ملاحظة:** إذا كان التطبيق يتحقق من كلمة المرور عبر `passwordHash`، فستحتاج إما إلى تشفير كلمة المرور بنفس الطريقة التي يستخدمها التطبيق، أو إضافة مستخدم من واجهة الإعدادات بعد تفعيل خيار "إضافة مستخدم" إن وُجد. يمكنك مؤقتاً إدخال **id** و **data** مع **email** و **role: "admin"** ثم تجربة تسجيل الدخول؛ إن فشل التحقق من كلمة المرور، راجع كود التطبيق لطريقة التشفير أو استخدم شاشة "نسيت كلمة المرور" / "إضافة مستخدم" من الإعدادات.

**الطريقة 2 — من التطبيق:** إن كانت شاشة الإعدادات توفّر "إضافة مستخدم" وتعمل مع Supabase، أضف المستخدم الأول من هناك (قد يتطلب وصولاً خاصاً أو رابط إعداد أولي).

---

إذا واجهت رسالة خطأ في أي خطوة، انسخ نص الخطأ ورقم الخطوة وسأساعدك في حلها.

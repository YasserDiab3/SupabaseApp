# مراجعة قبل الإنتاج — الموديولات والواجهة (UI/UX)

**التاريخ:** 2025-02-21

---

## 1. التعديلات المنفذة (Supabase + منع أخطاء)

| الملف | التعديل |
|-------|---------|
| **auth.js** | استخدام optional chaining و`useSupabaseBackend` في مسار "مزامنة قسرية" عند خطأ كلمة المرور (سطر ~725). منع رمي خطأ عند استخدام Supabase فقط. |
| **contractors.js** | توسيع شرط `canSync` في `ensureEvaluationsDataLoaded()` ليشمل `AppState.useSupabaseBackend === true` حتى تُحمَّل تقييمات المقاولين مع Supabase. |
| **app-ui.js** | تفعيل `startBackgroundSync()` عند استخدام Supabase (نفس شرط `hasBackend`)؛ المزامنة الدورية كل 2 دقيقة تعمل الآن مع Supabase. |
| **data-manager.js** | `retryPendingSync()` يعمل مع Supabase: التحقق من `useSupabaseBackend` أو Google Script؛ عند Supabase لا يُطلب `spreadsheetId`. |
| **settings.js** | استخدام `AppState.googleConfig?.appsScript?.enabled` و`?.sheets?.spreadsheetId` في كل القراءات؛ تهيئة `appsScript` و`sheets` قبل الكتابة؛ دعم اختبار الاتصال عند استخدام Supabase. |

---

## 2. توافق الموديولات مع Supabase

- **الموديولات (35):** تعتمد على `DataManager` و`GoogleIntegration`؛ في SupabaseApp يتم تحميل `supabase-integration.js` فيضع `GoogleIntegration = SupabaseIntegration`، لذلك الاستدعاءات (مثل `readFromSheets`, `saveToSheet`, `syncData`) تذهب إلى Supabase دون تغيير في الموديولات.
- **استثناءات مُصلَحة:** كانت **contractors** و**settings** الوحيدتين اللتين تحتويان على شروط تعتمد فقط على Google؛ تم تعديلهما كما أعلاه.

---

## 3. مراجعة UI/UX السريعة

| البند | الحالة |
|--------|--------|
| **اللغة والاتجاه** | `index.html`: `lang="ar"` و`dir="rtl"` مضبوطان. |
| **الخط** | استخدام خط Cairo مع fallback مناسب في `responsive.css`. |
| **الشاشات الصغيرة** | وجود `responsive.css` مع `@media (max-width: 768px)` وتحسينات للنص والـ viewport. |
| **الوضع الليلي** | تطبيق فوري للثيم عبر `data-theme` في `app-ui.js`. |
| **Loader** | استخدام `Loading.show()` / `Loading.hide()` في مسارات async في الإعدادات والاختبار؛ جميع المسارات (نجاح/فشل/استثناء) تغطي إخفاء الـ loader. |
| **الإشعارات** | استخدام `Notification.success` / `Notification.error` / `Notification.warning` في الإعدادات واختبار الاتصال. |
| **إمكانية الوصول** | وجود استخدامات لـ `aria-` و`role` في الواجهة (مثلاً في مكونات وأيقونات). |

**توصية اختيارية:** تقليل أو دمج استدعاءات `addIcons` المتعددة المؤجلة (300–3500 ms) في `app-ui.js` إن ظهر تأخر أو “وميض” في الواجهة.

---

## 4. ما لم يُغيّر (بقصد)

- **تكرار تحميل البيانات بعد الدخول:** لا يزال في `auth.js` تحميل الأوراق ذات الأولوية ثم في `app-ui.js` استدعاء `syncData()`. هذا يعطي تحميلاً سريعاً ثم مزامنة كاملة؛ لا تعارض في المنطق، وإن رغبت لاحقاً بتبسيط المسار يمكن جعل مصدر واحد للتحميل الأولي.
- **إعدادات Google في واجهة Supabase:** قسم "تكامل Google" يظهر كما هو؛ مع optional chaining لن يحدث خطأ عند عدم وجود `appsScript` أو `sheets`. إخفاء القسم عند `useSupabaseBackend` يمكن إضافته لاحقاً كتحسين واجهة.

---

## 5. خلاصة الجاهزية للإنتاج

- **التوافق:** الموديولات تعمل مع Supabase بعد التعديلات؛ لا توجد شروط متبقية تمنع Supabase في المسارات الحرجة (تحميل بعد الدخول، مزامنة خلفية، مقاولين، إعدادات، إعادة محاولة المزامنة).
- **الأخطاء:** استخدام optional chaining في `auth.js` و`settings.js` يمنع رمي أخطاء عند عدم وجود `googleConfig` أو `appsScript` (مثل بيئة Supabase فقط).
- **الواجهة:** الهيكل العام (RTL، responsive، ثيم، loaders، إشعارات) منظم ولا توجد ثغرات واضحة في مسارات الـ loader أو الإشعارات في الملفات المُمراجعة.

يُنصح بتشغيل التطبيق مرة واحدة بعد النشر (تسجيل دخول، فتح تبويب المقاولين، الإعدادات، اختبار الاتصال) للتأكد من سلوك البيئة الحية.
